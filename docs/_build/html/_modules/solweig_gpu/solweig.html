

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>solweig_gpu.solweig &mdash; SOLWEIG-GPU 1.2.15 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=4afb903a"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SOLWEIG-GPU
              <img src="../../_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#using-conda-recommended">Using Conda (Recommended)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#using-pip-with-system-gdal">Using pip with system GDAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#development-installation">Development Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#verify-installation">Verify Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#gpu-setup">GPU Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#cuda-requirements">CUDA Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#cpu-only-mode">CPU-Only Mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#common-issues">Common Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#gdal-import-error">GDAL Import Error</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../installation.html#pytorch-gpu-not-detected">PyTorch GPU Not Detected</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#basic-workflow">Basic Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#example-1-using-your-own-met-data">Example 1: Using Your Own Met Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#required-input-files">Required Input Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#met-data-format">Met Data Format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#example-2-using-era5-data">Example 2: Using ERA5 Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#example-3-using-wrf-output">Example 3: Using WRF Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#command-line-usage">Command-Line Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#configuration-options">Configuration Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#tile-size">Tile Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../quickstart.html#output-options">Output Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#output-files">Output Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart.html#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.solweig_gpu">Main Entry Point</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig_gpu.thermal_comfort"><code class="docutils literal notranslate"><span class="pre">thermal_comfort()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.preprocessor">Data Preprocessing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.extract_datetime_strict"><code class="docutils literal notranslate"><span class="pre">extract_datetime_strict()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.check_rasters"><code class="docutils literal notranslate"><span class="pre">check_rasters()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.create_tiles"><code class="docutils literal notranslate"><span class="pre">create_tiles()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.process_era5_data"><code class="docutils literal notranslate"><span class="pre">process_era5_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.process_wrfout_data"><code class="docutils literal notranslate"><span class="pre">process_wrfout_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.process_metfiles"><code class="docutils literal notranslate"><span class="pre">process_metfiles()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.create_met_files"><code class="docutils literal notranslate"><span class="pre">create_met_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.preprocessor.ppr"><code class="docutils literal notranslate"><span class="pre">ppr()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.solweig">Radiation Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.ensure_tensor"><code class="docutils literal notranslate"><span class="pre">ensure_tensor()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.daylen"><code class="docutils literal notranslate"><span class="pre">daylen()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.sunonsurface_2018a"><code class="docutils literal notranslate"><span class="pre">sunonsurface_2018a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.gvf_2018a"><code class="docutils literal notranslate"><span class="pre">gvf_2018a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.cylindric_wedge"><code class="docutils literal notranslate"><span class="pre">cylindric_wedge()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.TsWaveDelay_2015a"><code class="docutils literal notranslate"><span class="pre">TsWaveDelay_2015a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Kup_veg_2015a"><code class="docutils literal notranslate"><span class="pre">Kup_veg_2015a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Kvikt_veg"><code class="docutils literal notranslate"><span class="pre">Kvikt_veg()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.shaded_or_sunlit"><code class="docutils literal notranslate"><span class="pre">shaded_or_sunlit()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Kside_veg_v2022a"><code class="docutils literal notranslate"><span class="pre">Kside_veg_v2022a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.sun_distance"><code class="docutils literal notranslate"><span class="pre">sun_distance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.clearnessindex_2013b"><code class="docutils literal notranslate"><span class="pre">clearnessindex_2013b()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.diffusefraction"><code class="docutils literal notranslate"><span class="pre">diffusefraction()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.shadowingfunction_wallheight_13"><code class="docutils literal notranslate"><span class="pre">shadowingfunction_wallheight_13()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.shadowingfunction_wallheight_23"><code class="docutils literal notranslate"><span class="pre">shadowingfunction_wallheight_23()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Perez_v3"><code class="docutils literal notranslate"><span class="pre">Perez_v3()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.model1"><code class="docutils literal notranslate"><span class="pre">model1()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.model2"><code class="docutils literal notranslate"><span class="pre">model2()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.model3"><code class="docutils literal notranslate"><span class="pre">model3()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.define_patch_characteristics"><code class="docutils literal notranslate"><span class="pre">define_patch_characteristics()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Lcyl_v2022a"><code class="docutils literal notranslate"><span class="pre">Lcyl_v2022a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Lvikt_veg"><code class="docutils literal notranslate"><span class="pre">Lvikt_veg()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Lside_veg_v2022a"><code class="docutils literal notranslate"><span class="pre">Lside_veg_v2022a()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.solweig.Solweig_2022a_calc"><code class="docutils literal notranslate"><span class="pre">Solweig_2022a_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.sun_position">Solar Position Algorithm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.sun_position"><code class="docutils literal notranslate"><span class="pre">sun_position()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.julian_calculation"><code class="docutils literal notranslate"><span class="pre">julian_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.earth_heliocentric_position_calculation"><code class="docutils literal notranslate"><span class="pre">earth_heliocentric_position_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.sun_geocentric_position_calculation"><code class="docutils literal notranslate"><span class="pre">sun_geocentric_position_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.nutation_calculation"><code class="docutils literal notranslate"><span class="pre">nutation_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.true_obliquity_calculation"><code class="docutils literal notranslate"><span class="pre">true_obliquity_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.abberation_correction_calculation"><code class="docutils literal notranslate"><span class="pre">abberation_correction_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.apparent_sun_longitude_calculation"><code class="docutils literal notranslate"><span class="pre">apparent_sun_longitude_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.apparent_stime_at_greenwich_calculation"><code class="docutils literal notranslate"><span class="pre">apparent_stime_at_greenwich_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.sun_rigth_ascension_calculation"><code class="docutils literal notranslate"><span class="pre">sun_rigth_ascension_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.sun_geocentric_declination_calculation"><code class="docutils literal notranslate"><span class="pre">sun_geocentric_declination_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.observer_local_hour_calculation"><code class="docutils literal notranslate"><span class="pre">observer_local_hour_calculation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.topocentric_sun_position_calculate"><code class="docutils literal notranslate"><span class="pre">topocentric_sun_position_calculate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.topocentric_local_hour_calculate"><code class="docutils literal notranslate"><span class="pre">topocentric_local_hour_calculate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.sun_topocentric_zenith_angle_calculate"><code class="docutils literal notranslate"><span class="pre">sun_topocentric_zenith_angle_calculate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.set_to_range"><code class="docutils literal notranslate"><span class="pre">set_to_range()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.sun_position.Solweig_2015a_metdata_noload"><code class="docutils literal notranslate"><span class="pre">Solweig_2015a_metdata_noload()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.shadow">Shadow and Sky View Factor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.shadow.ensure_tensor"><code class="docutils literal notranslate"><span class="pre">ensure_tensor()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.shadow.shadow"><code class="docutils literal notranslate"><span class="pre">shadow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.shadow.annulus_weight"><code class="docutils literal notranslate"><span class="pre">annulus_weight()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.shadow.create_patches"><code class="docutils literal notranslate"><span class="pre">create_patches()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.shadow.svf_calculator"><code class="docutils literal notranslate"><span class="pre">svf_calculator()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.calculate_utci">UTCI Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.calculate_utci.utci_polynomial"><code class="docutils literal notranslate"><span class="pre">utci_polynomial()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.calculate_utci.utci_calculator"><code class="docutils literal notranslate"><span class="pre">utci_calculator()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.utci_process">UTCI Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.load_raster_to_tensor"><code class="docutils literal notranslate"><span class="pre">load_raster_to_tensor()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.extract_key"><code class="docutils literal notranslate"><span class="pre">extract_key()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.get_matching_files"><code class="docutils literal notranslate"><span class="pre">get_matching_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.map_files_by_key"><code class="docutils literal notranslate"><span class="pre">map_files_by_key()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.extract_number_from_filename"><code class="docutils literal notranslate"><span class="pre">extract_number_from_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.utci_process.compute_utci"><code class="docutils literal notranslate"><span class="pre">compute_utci()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.walls_aspect">Wall Geometry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.findwalls"><code class="docutils literal notranslate"><span class="pre">findwalls()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.cart2pol"><code class="docutils literal notranslate"><span class="pre">cart2pol()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.get_ders"><code class="docutils literal notranslate"><span class="pre">get_ders()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.filter1Goodwin_as_aspect_v3"><code class="docutils literal notranslate"><span class="pre">filter1Goodwin_as_aspect_v3()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.process_file_parallel"><code class="docutils literal notranslate"><span class="pre">process_file_parallel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.walls_aspect.run_parallel_processing"><code class="docutils literal notranslate"><span class="pre">run_parallel_processing()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.cli">Command-Line Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.cli.str2bool"><code class="docutils literal notranslate"><span class="pre">str2bool()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.cli.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-solweig_gpu.Tgmaps_v1">Surface Properties</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#solweig_gpu.Tgmaps_v1.Tgmaps_v1"><code class="docutils literal notranslate"><span class="pre">Tgmaps_v1()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../input_data.html">Input Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../input_data.html#geospatial-rasters">Geospatial Rasters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#required-rasters">Required Rasters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../input_data.html#building-dsm">Building DSM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../input_data.html#digital-elevation-model-dem">Digital Elevation Model (DEM)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../input_data.html#tree-dsm">Tree DSM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../input_data.html#land-cover-optional">Land Cover (Optional)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../input_data.html#meteorological-forcing-data">Meteorological Forcing Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#option-1-custom-text-file-umep-format">Option 1: Custom Text File (UMEP Format)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#option-2-era5-reanalysis-data">Option 2: ERA5 Reanalysis Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#option-3-wrf-output-files">Option 3: WRF Output Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../input_data.html#data-preparation-tips">Data Preparation Tips</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#coordinate-reference-system">Coordinate Reference System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../input_data.html#temporal-resolution">Temporal Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../input_data.html#sample-data">Sample Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#basic-configuration">Basic Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#required-parameters">Required Parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../configuration.html#base-path"><code class="docutils literal notranslate"><span class="pre">base_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../configuration.html#selected-date-str"><code class="docutils literal notranslate"><span class="pre">selected_date_str</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#raster-filenames">Raster Filenames</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#tiling-configuration">Tiling Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#tile-size"><code class="docutils literal notranslate"><span class="pre">tile_size</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#overlap"><code class="docutils literal notranslate"><span class="pre">overlap</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#meteorological-data-configuration">Meteorological Data Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#using-custom-meteorological-file">Using Custom Meteorological File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#using-era5-or-wrf-data">Using ERA5 or WRF Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#output-configuration">Output Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#complete-configuration-example">Complete Configuration Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#gpu-vs-cpu">GPU vs CPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration.html#memory-management">Memory Management</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../outputs.html">Outputs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#output-structure">Output Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#output-files">Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#universal-thermal-climate-index-utci">Universal Thermal Climate Index (UTCI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#mean-radiant-temperature-tmrt">Mean Radiant Temperature (Tmrt)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#sky-view-factor-svf">Sky View Factor (SVF)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../outputs.html#downwelling-shortwave">Downwelling Shortwave</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../outputs.html#upwelling-shortwave-kup">Upwelling Shortwave (Kup)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../outputs.html#downwelling-longwave-ldown">Downwelling Longwave (Ldown)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../outputs.html#upwelling-longwave-lup">Upwelling Longwave (Lup)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#shadow-maps">Shadow Maps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#multi-band-structure">Multi-Band Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#visualizing-outputs">Visualizing Outputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#using-qgis">Using QGIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#using-python">Using Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#using-arcgis">Using ArcGIS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#merging-tiles">Merging Tiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#utci-tile-merging-example">UTCI tile merging example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../outputs.html#data-analysis">Data Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#computing-statistics">Computing Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../outputs.html#extracting-time-series">Extracting Time Series</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Example 1: Using WRF Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#example-2-using-era5-data">Example 2: Using ERA5 Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#you-can-download-era5-as-below">You can download ERA5 as below</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#example-3-using-a-custom-meteorological-file">Example 3: Using a Custom Meteorological File</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../testing.html#running-tests">Running Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#full-test-suite">Full Test Suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#with-coverage-report">With Coverage Report</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#specific-test-modules">Specific Test Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#example-testing-a-utility-function">Example: Testing a Utility Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#example-testing-with-fixtures">Example: Testing with Fixtures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing.html#continuous-integration">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing.html#manual-testing">Manual Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#test-with-sample-data">Test with Sample Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing.html#verify-outputs">Verify Outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing.html#benchmark-tests">Benchmark Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide.html#architecture-overview">Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide.html#module-interactions">Module Interactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developer_guide.html#contributing-to-solweig-gpu">Contributing to SOLWEIG-GPU</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SOLWEIG-GPU</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">solweig_gpu.solweig</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for solweig_gpu.solweig</h1><div class="highlight"><pre>
<span></span><span class="c1">#SOLWEIG-GPU: GPU-accelerated SOLWEIG model for urban thermal comfort simulation</span>
<span class="c1">#Copyright (C) 2022â€“2025 Harsh Kamath and Naveen Sudharsan</span>

<span class="c1">#This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#it under the terms of the GNU General Public License as published by</span>
<span class="c1">#the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#(at your option) any later version.</span>

<span class="c1">#This program is distributed in the hope that it will be useful,</span>
<span class="c1">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1">#GNU General Public License for more details.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">radians</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.ndimage.interpolation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.shadow</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_patches</span>
<span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>

<div class="viewcode-block" id="ensure_tensor">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.ensure_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert input to PyTorch tensor on specified device.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        x: Input data (numpy array, list, or tensor)</span>
<span class="sd">        device (torch.device, optional): Target device</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Input as tensor on device</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="daylen">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.daylen">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">daylen</span><span class="p">(</span><span class="n">DOY</span><span class="p">,</span> <span class="n">XLAT</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate day length and solar declination for given day and latitude.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        DOY (torch.Tensor): Day of year (1-365)</span>
<span class="sd">        XLAT (torch.Tensor): Latitude in degrees</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (DAYL, DEC, SNDN, SNUP) where:</span>
<span class="sd">            - DAYL: Day length in hours</span>
<span class="sd">            - DEC: Solar declination in degrees</span>
<span class="sd">            - SNDN: Time of solar noon in hours</span>
<span class="sd">            - SNUP: Time of sunrise in hours</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RAD</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>

    <span class="n">DEC</span> <span class="o">=</span> <span class="o">-</span><span class="mf">23.45</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">DOY</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.0</span><span class="p">)</span>

    <span class="n">SOC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">RAD</span> <span class="o">*</span> <span class="n">DEC</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">RAD</span> <span class="o">*</span> <span class="n">XLAT</span><span class="p">)</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">SOC</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">DAYL</span> <span class="o">=</span> <span class="mf">12.0</span> <span class="o">+</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">SNUP</span> <span class="o">=</span> <span class="mf">12.0</span> <span class="o">-</span> <span class="n">DAYL</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">SNDN</span> <span class="o">=</span> <span class="mf">12.0</span> <span class="o">+</span> <span class="n">DAYL</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="k">return</span> <span class="n">DAYL</span><span class="p">,</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">SNDN</span><span class="p">,</span> <span class="n">SNUP</span></div>


<div class="viewcode-block" id="sunonsurface_2018a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.sunonsurface_2018a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sunonsurface_2018a</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">sunwall</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">Tg</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span>
                       <span class="n">emis_grid</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">alb_grid</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">Twater</span><span class="p">,</span> <span class="n">lc_grid</span><span class="p">,</span> <span class="n">landcover</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate solar radiation on surfaces with different orientations.</span>
<span class="sd">    </span>
<span class="sd">    Determines radiation on walls and ground surfaces accounting for</span>
<span class="sd">    building geometry, shadows, and surface properties.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        azimuthA (float): Solar azimuth angle (degrees)</span>
<span class="sd">        scale (float): Grid scale (pixels per meter)</span>
<span class="sd">        buildings (torch.Tensor): Building mask array</span>
<span class="sd">        shadow (torch.Tensor): Shadow map</span>
<span class="sd">        sunwall (torch.Tensor): Sunlit wall mask</span>
<span class="sd">        first (torch.Tensor): First surface type</span>
<span class="sd">        second (torch.Tensor): Second surface type</span>
<span class="sd">        aspect (torch.Tensor): Wall aspect angles</span>
<span class="sd">        walls (torch.Tensor): Wall heights</span>
<span class="sd">        Tg (torch.Tensor): Ground temperature</span>
<span class="sd">        Tgwall (torch.Tensor): Wall temperature</span>
<span class="sd">        Ta (float): Air temperature</span>
<span class="sd">        emis_grid (torch.Tensor): Ground emissivity</span>
<span class="sd">        ewall (float): Wall emissivity</span>
<span class="sd">        alb_grid (torch.Tensor): Ground albedo</span>
<span class="sd">        SBC (float): Stefan-Boltzmann constant</span>
<span class="sd">        albedo_b (float): Building albedo</span>
<span class="sd">        Twater (float): Water temperature</span>
<span class="sd">        lc_grid (torch.Tensor): Land cover grid</span>
<span class="sd">        landcover (np.ndarray): Land cover classification</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Radiation components for different surfaces</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># Convert inputs to tensors on the GPU</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">ewall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ewall</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">albedo_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">albedo_b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">landcover</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">landcover</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="n">sizex</span> <span class="o">=</span> <span class="n">walls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sizey</span> <span class="o">=</span> <span class="n">walls</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">wallbol</span> <span class="o">=</span> <span class="p">(</span><span class="n">walls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">sunwall</span><span class="p">[</span><span class="n">sunwall</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">azimuthA</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">buildings</span>
    <span class="n">Lup</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tg</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">+</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">landcover</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Tg</span><span class="p">[</span><span class="n">lc_grid</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Twater</span> <span class="o">-</span> <span class="n">Ta</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">Lwall</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tgwall</span> <span class="o">+</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">albshadow</span> <span class="o">=</span> <span class="n">alb_grid</span> <span class="o">*</span> <span class="n">shadow</span>
    <span class="n">alb</span> <span class="o">=</span> <span class="n">alb_grid</span>

    <span class="n">tempsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempbu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempbub</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempbubwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">first</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">second</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">weightsumLupsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumLwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumalbsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumalbwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumalbnosh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">weightsumalbwallnosh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempLupsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempalbsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempalbnosh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">pibyfour</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">threetimespibyfour</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">fivetimespibyfour</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">seventimespibyfour</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">sinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">cosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">tanazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">signsinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sinazimuth</span><span class="p">)</span>
    <span class="n">signcosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cosazimuth</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span> <span class="ow">and</span> <span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">threetimespibyfour</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fivetimespibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span> <span class="ow">and</span> <span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">seventimespibyfour</span><span class="p">):</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">index</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">/</span> <span class="n">tanazimuth</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">tanazimuth</span><span class="p">))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">index</span>

        <span class="n">absdx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">absdy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>

        <span class="n">xc1</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">xc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizex</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">yc1</span> <span class="o">=</span> <span class="p">((</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">yc2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizey</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>

        <span class="n">xp1</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">xp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizex</span> <span class="o">-</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">yp1</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="n">yp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizey</span> <span class="o">-</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>

        <span class="n">tempbu</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">buildings</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">tempsh</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shadow</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">tempLupsh</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lup</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">tempalbsh</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">albshadow</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">tempalbnosh</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">alb</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tempbu</span><span class="p">)</span>

        <span class="n">shadow2</span> <span class="o">=</span> <span class="n">tempsh</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">weightsumsh</span> <span class="o">+=</span> <span class="n">shadow2</span>

        <span class="n">Lupsh</span> <span class="o">=</span> <span class="n">tempLupsh</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">weightsumLupsh</span> <span class="o">+=</span> <span class="n">Lupsh</span>

        <span class="n">albsh</span> <span class="o">=</span> <span class="n">tempalbsh</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">weightsumalbsh</span> <span class="o">+=</span> <span class="n">albsh</span>

        <span class="n">albnosh</span> <span class="o">=</span> <span class="n">tempalbnosh</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">weightsumalbnosh</span> <span class="o">+=</span> <span class="n">albnosh</span>

        <span class="n">tempwallsun</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sunwall</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span>
        <span class="n">tempb</span> <span class="o">=</span> <span class="n">tempwallsun</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">tempbwall</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">tempbub</span> <span class="o">=</span> <span class="p">((</span><span class="n">tempb</span> <span class="o">+</span> <span class="n">tempbub</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">tempbubwall</span> <span class="o">=</span> <span class="p">((</span><span class="n">tempbwall</span> <span class="o">+</span> <span class="n">tempbubwall</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">weightsumLwall</span> <span class="o">+=</span> <span class="n">tempbub</span> <span class="o">*</span> <span class="n">Lwall</span>
        <span class="n">weightsumalbwall</span> <span class="o">+=</span> <span class="n">tempbub</span> <span class="o">*</span> <span class="n">albedo_b</span>
        <span class="n">weightsumwall</span> <span class="o">+=</span> <span class="n">tempbub</span>
        <span class="n">weightsumalbwallnosh</span> <span class="o">+=</span> <span class="n">tempbubwall</span> <span class="o">*</span> <span class="n">albedo_b</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">weightsumwall_first</span> <span class="o">=</span> <span class="n">weightsumwall</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">weightsumsh_first</span> <span class="o">=</span> <span class="n">weightsumsh</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">wallsuninfluence_first</span> <span class="o">=</span> <span class="n">weightsumwall_first</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">weightsumLwall_first</span> <span class="o">=</span> <span class="n">weightsumLwall</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">weightsumLupsh_first</span> <span class="o">=</span> <span class="n">weightsumLupsh</span> <span class="o">/</span> <span class="n">ind</span>

            <span class="n">weightsumalbwall_first</span> <span class="o">=</span> <span class="n">weightsumalbwall</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">weightsumalbsh_first</span> <span class="o">=</span> <span class="n">weightsumalbsh</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">weightsumalbwallnosh_first</span> <span class="o">=</span> <span class="n">weightsumalbwallnosh</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">weightsumalbnosh_first</span> <span class="o">=</span> <span class="n">weightsumalbnosh</span> <span class="o">/</span> <span class="n">ind</span>
            <span class="n">wallinfluence_first</span> <span class="o">=</span> <span class="n">weightsumalbwallnosh_first</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">wallsuninfluence_second</span> <span class="o">=</span> <span class="n">weightsumwall</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">wallinfluence_second</span> <span class="o">=</span> <span class="n">weightsumalbwallnosh</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">azilow</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">azihigh</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">azilow</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&lt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&gt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="n">wallbol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">azilow</span> <span class="o">=</span> <span class="n">azilow</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">azihigh</span> <span class="o">=</span> <span class="n">azihigh</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">weightsumwall</span> <span class="o">==</span> <span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="n">facesh</span>
    <span class="n">keep</span><span class="p">[</span><span class="n">keep</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">gvf1</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumwall_first</span> <span class="o">+</span> <span class="n">weightsumsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_first</span> <span class="o">+</span> \
           <span class="p">(</span><span class="n">weightsumsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="n">first</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_first</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">weightsumwall</span><span class="p">[</span><span class="n">keep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gvf2</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumwall</span> <span class="o">+</span> <span class="n">weightsumsh</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">second</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_second</span> <span class="o">+</span> \
           <span class="p">(</span><span class="n">weightsumsh</span><span class="p">)</span> <span class="o">/</span> <span class="n">second</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_second</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gvf2</span><span class="p">[</span><span class="n">gvf2</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">gvfLup1</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumLwall_first</span> <span class="o">+</span> <span class="n">weightsumLupsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_first</span> <span class="o">+</span> \
              <span class="p">(</span><span class="n">weightsumLupsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="n">first</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_first</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">weightsumLwall</span><span class="p">[</span><span class="n">keep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gvfLup2</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumLwall</span> <span class="o">+</span> <span class="n">weightsumLupsh</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">second</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_second</span> <span class="o">+</span> \
              <span class="p">(</span><span class="n">weightsumLupsh</span><span class="p">)</span> <span class="o">/</span> <span class="n">second</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_second</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gvfalb1</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumalbwall_first</span> <span class="o">+</span> <span class="n">weightsumalbsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_first</span> <span class="o">+</span> \
              <span class="p">(</span><span class="n">weightsumalbsh_first</span><span class="p">)</span> <span class="o">/</span> <span class="n">first</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_first</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">weightsumalbwall</span><span class="p">[</span><span class="n">keep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gvfalb2</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumalbwall</span> <span class="o">+</span> <span class="n">weightsumalbsh</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">second</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallsuninfluence_second</span> <span class="o">+</span> \
              <span class="p">(</span><span class="n">weightsumalbsh</span><span class="p">)</span> <span class="o">/</span> <span class="n">second</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallsuninfluence_second</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gvfalbnosh1</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumalbwallnosh_first</span> <span class="o">+</span> <span class="n">weightsumalbnosh_first</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">wallinfluence_first</span> <span class="o">+</span> \
                  <span class="p">(</span><span class="n">weightsumalbnosh_first</span><span class="p">)</span> <span class="o">/</span> <span class="n">first</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallinfluence_first</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gvfalbnosh2</span> <span class="o">=</span> <span class="p">((</span><span class="n">weightsumalbwallnosh</span> <span class="o">+</span> <span class="n">weightsumalbnosh</span><span class="p">)</span> <span class="o">/</span> <span class="n">second</span><span class="p">)</span> <span class="o">*</span> <span class="n">wallinfluence_second</span> <span class="o">+</span> \
                  <span class="p">(</span><span class="n">weightsumalbnosh</span><span class="p">)</span> <span class="o">/</span> <span class="n">second</span> <span class="o">*</span> <span class="p">(</span><span class="n">wallinfluence_second</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">gvf</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvf1</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">gvf2</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.9</span>
    <span class="n">gvfLup</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfLup1</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">gvfLup2</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.9</span>
    <span class="n">gvfLup</span> <span class="o">=</span> <span class="n">gvfLup</span> <span class="o">+</span> <span class="p">((</span><span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tg</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">+</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">buildings</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gvfalb</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalb1</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">gvfalb2</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.9</span>
    <span class="n">gvfalb</span> <span class="o">=</span> <span class="n">gvfalb</span> <span class="o">+</span> <span class="n">alb_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">buildings</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">shadow</span>
    <span class="n">gvfalbnosh</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalbnosh1</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">gvfalbnosh2</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.9</span>
    <span class="n">gvfalbnosh</span> <span class="o">=</span> <span class="n">gvfalbnosh</span> <span class="o">*</span> <span class="n">buildings</span> <span class="o">+</span> <span class="n">alb_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">buildings</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">tempbu</span><span class="p">,</span><span class="n">tempsh</span><span class="p">,</span><span class="n">tempLupsh</span><span class="p">,</span><span class="n">tempalbsh</span><span class="p">,</span><span class="n">tempalbnosh</span><span class="p">,</span><span class="n">shadow2</span><span class="p">,</span><span class="n">Lupsh</span><span class="p">,</span><span class="n">albsh</span><span class="p">,</span><span class="n">albnosh</span><span class="p">,</span><span class="n">tempwallsun</span><span class="p">,</span><span class="n">tempb</span><span class="p">,</span><span class="n">tempbwall</span><span class="p">,</span><span class="n">tempbub</span><span class="p">,</span><span class="n">tempbubwall</span>

    <span class="k">del</span> <span class="n">weightsumLupsh</span> <span class="p">,</span><span class="n">weightsumLwall</span> <span class="p">,</span><span class="n">weightsumalbsh</span> <span class="p">,</span><span class="n">weightsumalbwall</span> <span class="p">,</span><span class="n">weightsumalbnosh</span> <span class="p">,</span><span class="n">weightsumalbwallnosh</span><span class="p">,</span><span class="n">weightsumsh</span> <span class="p">,</span><span class="n">weightsumwall</span>

    <span class="k">return</span> <span class="n">gvf</span><span class="p">,</span> <span class="n">gvfLup</span><span class="p">,</span> <span class="n">gvfalb</span><span class="p">,</span> <span class="n">gvfalbnosh</span><span class="p">,</span> <span class="n">gvf2</span></div>



<div class="viewcode-block" id="gvf_2018a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.gvf_2018a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gvf_2018a</span><span class="p">(</span><span class="n">wallsun</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">dirwalls</span><span class="p">,</span> <span class="n">Tg</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">emis_grid</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span>
              <span class="n">alb_grid</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">Twater</span><span class="p">,</span> <span class="n">lc_grid</span><span class="p">,</span> <span class="n">landcover</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate ground view factors for radiation exchange between surfaces.</span>
<span class="sd">    </span>
<span class="sd">    Computes how much ground surfaces &quot;see&quot; walls and other surfaces,</span>
<span class="sd">    accounting for shadows and multiple reflections.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        wallsun (torch.Tensor): Sunlit wall indicator</span>
<span class="sd">        walls (torch.Tensor): Wall heights</span>
<span class="sd">        buildings (torch.Tensor): Building mask</span>
<span class="sd">        scale (float): Grid scale</span>
<span class="sd">        shadow (torch.Tensor): Shadow map</span>
<span class="sd">        first/second (torch.Tensor): Surface classification</span>
<span class="sd">        dirwalls (torch.Tensor): Wall directions</span>
<span class="sd">        Tg/Tgwall/Ta (torch.Tensor): Temperatures (ground/wall/air)</span>
<span class="sd">        emis_grid (torch.Tensor): Ground emissivity</span>
<span class="sd">        ewall (float): Wall emissivity  </span>
<span class="sd">        alb_grid (torch.Tensor): Ground albedo</span>
<span class="sd">        SBC (float): Stefan-Boltzmann constant</span>
<span class="sd">        albedo_b (float): Building albedo</span>
<span class="sd">        rows/cols (int): Grid dimensions</span>
<span class="sd">        Twater (float): Water temperature</span>
<span class="sd">        lc_grid (torch.Tensor): Land cover grid</span>
<span class="sd">        landcover (np.ndarray): Land cover data</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: View factors and albedo components for different directions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">azimuthA</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">359</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># Search directions for Ground View Factors (GVF)</span>

    <span class="n">gvfLup</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbnosh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfLupE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfLupS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfLupW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfLupN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbnoshE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbnoshS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbnoshW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfalbnoshN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">gvfSum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">sunwall</span> <span class="o">=</span> <span class="p">((</span><span class="n">wallsun</span> <span class="o">/</span> <span class="n">walls</span> <span class="o">*</span> <span class="n">buildings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">gvfLupi</span><span class="p">,</span> <span class="n">gvfalbi</span><span class="p">,</span> <span class="n">gvfalbnoshi</span><span class="p">,</span> <span class="n">gvf2</span> <span class="o">=</span> <span class="n">sunonsurface_2018a</span><span class="p">(</span>
            <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">scale</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">sunwall</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">dirwalls</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">Tg</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span>
            <span class="n">Ta</span><span class="p">,</span> <span class="n">emis_grid</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">alb_grid</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">Twater</span><span class="p">,</span> <span class="n">lc_grid</span><span class="p">,</span> <span class="n">landcover</span>
        <span class="p">)</span>

        <span class="n">gvfLup</span> <span class="o">+=</span> <span class="n">gvfLupi</span>
        <span class="n">gvfalb</span> <span class="o">+=</span> <span class="n">gvfalbi</span>
        <span class="n">gvfalbnosh</span> <span class="o">+=</span> <span class="n">gvfalbnoshi</span>
        <span class="n">gvfSum</span> <span class="o">+=</span> <span class="n">gvf2</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">gvfLupE</span> <span class="o">+=</span> <span class="n">gvfLupi</span>
            <span class="n">gvfalbE</span> <span class="o">+=</span> <span class="n">gvfalbi</span>
            <span class="n">gvfalbnoshE</span> <span class="o">+=</span> <span class="n">gvfalbnoshi</span>

        <span class="k">if</span> <span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">:</span>
            <span class="n">gvfLupS</span> <span class="o">+=</span> <span class="n">gvfLupi</span>
            <span class="n">gvfalbS</span> <span class="o">+=</span> <span class="n">gvfalbi</span>
            <span class="n">gvfalbnoshS</span> <span class="o">+=</span> <span class="n">gvfalbnoshi</span>

        <span class="k">if</span> <span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">:</span>
            <span class="n">gvfLupW</span> <span class="o">+=</span> <span class="n">gvfLupi</span>
            <span class="n">gvfalbW</span> <span class="o">+=</span> <span class="n">gvfalbi</span>
            <span class="n">gvfalbnoshW</span> <span class="o">+=</span> <span class="n">gvfalbnoshi</span>

        <span class="k">if</span> <span class="mi">270</span> <span class="o">&lt;=</span> <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">or</span> <span class="n">azimuthA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="n">gvfLupN</span> <span class="o">+=</span> <span class="n">gvfLupi</span>
            <span class="n">gvfalbN</span> <span class="o">+=</span> <span class="n">gvfalbi</span>
            <span class="n">gvfalbnoshN</span> <span class="o">+=</span> <span class="n">gvfalbnoshi</span>

    <span class="n">gvfLup</span> <span class="o">=</span> <span class="n">gvfLup</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">gvfalb</span> <span class="o">=</span> <span class="n">gvfalb</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span>
    <span class="n">gvfalbnosh</span> <span class="o">=</span> <span class="n">gvfalbnosh</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span>

    <span class="n">gvfLupE</span> <span class="o">=</span> <span class="n">gvfLupE</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">gvfLupS</span> <span class="o">=</span> <span class="n">gvfLupS</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">gvfLupW</span> <span class="o">=</span> <span class="n">gvfLupW</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">gvfLupN</span> <span class="o">=</span> <span class="n">gvfLupN</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>

    <span class="n">gvfalbE</span> <span class="o">=</span> <span class="n">gvfalbE</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbS</span> <span class="o">=</span> <span class="n">gvfalbS</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbW</span> <span class="o">=</span> <span class="n">gvfalbW</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbN</span> <span class="o">=</span> <span class="n">gvfalbN</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">gvfalbnoshE</span> <span class="o">=</span> <span class="n">gvfalbnoshE</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbnoshS</span> <span class="o">=</span> <span class="n">gvfalbnoshS</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbnoshW</span> <span class="o">=</span> <span class="n">gvfalbnoshW</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gvfalbnoshN</span> <span class="o">=</span> <span class="n">gvfalbnoshN</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">gvfNorm</span> <span class="o">=</span> <span class="n">gvfSum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuthA</span><span class="p">)</span>
    <span class="n">gvfNorm</span><span class="p">[</span><span class="n">buildings</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">gvfLup</span><span class="p">,</span> <span class="n">gvfalb</span><span class="p">,</span> <span class="n">gvfalbnosh</span><span class="p">,</span> <span class="n">gvfLupE</span><span class="p">,</span> <span class="n">gvfalbE</span><span class="p">,</span>
        <span class="n">gvfalbnoshE</span><span class="p">,</span> <span class="n">gvfLupS</span><span class="p">,</span> <span class="n">gvfalbS</span><span class="p">,</span> <span class="n">gvfalbnoshS</span><span class="p">,</span> <span class="n">gvfLupW</span><span class="p">,</span>
        <span class="n">gvfalbW</span><span class="p">,</span> <span class="n">gvfalbnoshW</span><span class="p">,</span> <span class="n">gvfLupN</span><span class="p">,</span> <span class="n">gvfalbN</span><span class="p">,</span> <span class="n">gvfalbnoshN</span><span class="p">,</span>
        <span class="n">gvfSum</span><span class="p">,</span> <span class="n">gvfNorm</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="cylindric_wedge">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.cylindric_wedge">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cylindric_wedge</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">svfalfa</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate form factors for cylindrical geometry (human body model).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        zen (torch.Tensor): Solar zenith angle</span>
<span class="sd">        svfalfa (torch.Tensor): SVF alpha component</span>
<span class="sd">        rows, cols (int): Grid dimensions</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Fside, Fup, Fcyl) - Form factors for cylinder sides, top, and total</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">alfa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">svfalfa</span>

    <span class="n">xa</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">alfa</span><span class="p">))</span>
    <span class="n">hkil</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">ba</span> <span class="o">*</span> <span class="n">ha</span>

    <span class="n">qa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">qa</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">Za</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Za</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ba</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">qa</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">phi</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">Za</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">qa</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">phi</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]))</span>

    <span class="n">ukil</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ukil</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ba</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">xa</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">xa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">Ssurf</span> <span class="o">=</span> <span class="n">hkil</span> <span class="o">+</span> <span class="n">ukil</span>

    <span class="n">F_sh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ba</span> <span class="o">-</span> <span class="n">Ssurf</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ba</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">alfa</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">hkil</span><span class="p">,</span> <span class="n">ukil</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">Ssurf</span><span class="p">,</span> <span class="n">qa</span><span class="p">,</span> <span class="n">Za</span>

    <span class="k">return</span> <span class="n">F_sh</span></div>


<div class="viewcode-block" id="TsWaveDelay_2015a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.TsWaveDelay_2015a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLup</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate surface temperature wave delay.</span>
<span class="sd">    </span>
<span class="sd">    Models thermal inertia and temperature wave propagation in surfaces.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        gvfLup: Ground view factor for upward longwave</span>
<span class="sd">        firstdaytime: First time step flag</span>
<span class="sd">        timeadd: Time addition parameter</span>
<span class="sd">        timestepdec: Time step decimal</span>
<span class="sd">        Tgmap1: Previous ground temperature map</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Temperature with wave delay applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># gvfLup = torch.tensor(gvfLup, device=device)</span>
    <span class="n">Tgmap0</span> <span class="o">=</span> <span class="n">gvfLup</span>  <span class="c1"># current timestep</span>

    <span class="k">if</span> <span class="n">firstdaytime</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># &quot;first in morning&quot;</span>
        <span class="n">Tgmap1</span> <span class="o">=</span> <span class="n">Tgmap0</span>

    <span class="k">if</span> <span class="n">timeadd</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">59</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">):</span>  <span class="c1"># more or equal to 59 min</span>
        <span class="n">weight1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">33.27</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">timeadd</span><span class="p">))</span>  <span class="c1"># surface temperature delay function - 1 step</span>
        <span class="n">Tgmap1</span> <span class="o">=</span> <span class="n">Tgmap0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weight1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tgmap1</span> <span class="o">*</span> <span class="n">weight1</span>
        <span class="n">Lup</span> <span class="o">=</span> <span class="n">Tgmap1</span>
        <span class="k">if</span> <span class="n">timestepdec</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">59</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">):</span>
            <span class="n">timeadd</span> <span class="o">=</span> <span class="n">timestepdec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeadd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timeadd</span> <span class="o">=</span> <span class="n">timeadd</span> <span class="o">+</span> <span class="n">timestepdec</span>
        <span class="n">weight1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">33.27</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">timeadd</span><span class="p">))</span>  <span class="c1"># surface temperature delay function - 1 step</span>
        <span class="n">Lup</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tgmap0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weight1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tgmap1</span> <span class="o">*</span> <span class="n">weight1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Lup</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">Tgmap1</span></div>


<div class="viewcode-block" id="Kup_veg_2015a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Kup_veg_2015a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Kup_veg_2015a</span><span class="p">(</span><span class="n">radI</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">svfbuveg</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">gvfalb</span><span class="p">,</span> <span class="n">gvfalbE</span><span class="p">,</span> <span class="n">gvfalbS</span><span class="p">,</span> <span class="n">gvfalbW</span><span class="p">,</span> <span class="n">gvfalbN</span><span class="p">,</span> <span class="n">gvfalbnosh</span><span class="p">,</span> <span class="n">gvfalbnoshE</span><span class="p">,</span> <span class="n">gvfalbnoshS</span><span class="p">,</span> <span class="n">gvfalbnoshW</span><span class="p">,</span> <span class="n">gvfalbnoshN</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate upward shortwave radiation with vegetation effects.</span>
<span class="sd">    </span>
<span class="sd">    Accounts for multiple reflections between ground, walls, and vegetation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Upward shortwave components for different directions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">albedo_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">albedo_b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">Kup</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalb</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">*</span> <span class="n">gvfalbnosh</span>
    <span class="n">KupE</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalbE</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">*</span> <span class="n">gvfalbnoshE</span>
    <span class="n">KupS</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalbS</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">*</span> <span class="n">gvfalbnoshS</span>
    <span class="n">KupW</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalbW</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">*</span> <span class="n">gvfalbnoshW</span>
    <span class="n">KupN</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvfalbN</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">*</span> <span class="n">gvfalbnoshN</span>

    <span class="k">return</span> <span class="n">Kup</span><span class="p">,</span> <span class="n">KupE</span><span class="p">,</span> <span class="n">KupS</span><span class="p">,</span> <span class="n">KupW</span><span class="p">,</span> <span class="n">KupN</span></div>


<div class="viewcode-block" id="Kvikt_veg">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Kvikt_veg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Kvikt_veg</span><span class="p">(</span><span class="n">svf</span><span class="p">,</span> <span class="n">svfveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate shortwave weight factor accounting for vegetation.&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">viktwall</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svf</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">svfvegbu</span> <span class="o">=</span> <span class="p">(</span><span class="n">svfveg</span> <span class="o">+</span> <span class="n">svf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">viktveg</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svfvegbu</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktveg</span> <span class="o">=</span> <span class="n">viktveg</span> <span class="o">-</span> <span class="n">viktwall</span>

    <span class="k">del</span> <span class="n">svfvegbu</span>

    <span class="k">return</span> <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span></div>



<div class="viewcode-block" id="shaded_or_sunlit">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.shaded_or_sunlit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">shaded_or_sunlit</span><span class="p">(</span><span class="n">solar_altitude</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">patch_altitude</span><span class="p">,</span> <span class="n">patch_azimuth</span><span class="p">,</span> <span class="n">asvf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if sky patches are shaded or sunlit.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        solar_altitude (float): Solar altitude angle</span>
<span class="sd">        solar_azimuth (float): Solar azimuth angle</span>
<span class="sd">        patch_altitude (torch.Tensor): Patch altitude angles</span>
<span class="sd">        patch_azimuth (torch.Tensor): Patch azimuth angles</span>
<span class="sd">        asvf (torch.Tensor): Anisotropic sky view factor</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Binary mask (1=sunlit, 0=shaded)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># Patch azimuth in relation to sun azimuth</span>
    <span class="n">patch_to_sun_azi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">solar_azimuth</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">)</span>

    <span class="c1"># Degrees to radians</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>

    <span class="c1"># Radians to degrees</span>
    <span class="n">rad2deg</span> <span class="o">=</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_to_sun_azi</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">solar_altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
    <span class="n">hsvf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">asvf</span><span class="p">)</span>
    <span class="n">yi_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span>
    <span class="n">tan_delta</span> <span class="o">=</span> <span class="n">hsvf</span> <span class="o">+</span> <span class="n">yi_</span>

    <span class="c1"># Degrees where below is in shade and above is sunlit</span>
    <span class="n">sunlit_degrees</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">tan_delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">rad2deg</span>

    <span class="c1"># Boolean for pixels where patch is sunlit</span>
    <span class="n">sunlit_patches</span> <span class="o">=</span> <span class="n">sunlit_degrees</span> <span class="o">&lt;</span> <span class="n">patch_altitude</span>
    <span class="c1"># Boolean for pixels where patch is shaded</span>
    <span class="n">shaded_patches</span> <span class="o">=</span> <span class="n">sunlit_degrees</span> <span class="o">&gt;</span> <span class="n">patch_altitude</span>

    <span class="k">return</span> <span class="n">sunlit_patches</span><span class="p">,</span> <span class="n">shaded_patches</span></div>


<div class="viewcode-block" id="Kside_veg_v2022a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Kside_veg_v2022a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Kside_veg_v2022a</span><span class="p">(</span><span class="n">radI</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">svfS</span><span class="p">,</span> <span class="n">svfW</span><span class="p">,</span> <span class="n">svfN</span><span class="p">,</span> <span class="n">svfE</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span>
                     <span class="n">azimuth</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">albedo</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">KupE</span><span class="p">,</span> <span class="n">KupS</span><span class="p">,</span> <span class="n">KupW</span><span class="p">,</span> <span class="n">KupN</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">anisotropic_diffuse</span><span class="p">,</span>
                     <span class="n">diffsh</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">asvf</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate shortwave radiation on vertical surfaces (walls) with vegetation effects.</span>
<span class="sd">    </span>
<span class="sd">    Computes direct, diffuse, and reflected shortwave radiation on walls in the</span>
<span class="sd">    four cardinal directions, accounting for vegetation shading and ground reflections.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        radI, radD, radG (float): Direct, diffuse, and global radiation (W/mÂ²)</span>
<span class="sd">        shadow (torch.Tensor): Shadow map</span>
<span class="sd">        svfS, svfW, svfN, svfE (torch.Tensor): Directional sky view factors</span>
<span class="sd">        svf*veg (torch.Tensor): Vegetation-obstructed SVFs</span>
<span class="sd">        azimuth, altitude (float): Solar angles (degrees)</span>
<span class="sd">        psi (torch.Tensor): Tilt angles</span>
<span class="sd">        t (float): Transmissivity factor</span>
<span class="sd">        albedo (torch.Tensor): Surface albedo</span>
<span class="sd">        F_sh (torch.Tensor): Form factor</span>
<span class="sd">        KupE, KupS, KupW, KupN (torch.Tensor): Upward shortwave per direction</span>
<span class="sd">        cyl (torch.Tensor): Cylindrical geometry factor</span>
<span class="sd">        lv (float): Leaf area index factor</span>
<span class="sd">        anisotropic_diffuse (bool): Use anisotropic diffuse model</span>
<span class="sd">        diffsh (torch.Tensor): Diffuse shadowing</span>
<span class="sd">        rows, cols (int): Grid dimensions</span>
<span class="sd">        asvf (torch.Tensor): Anisotropic SVF</span>
<span class="sd">        shmat, vegshmat, vbshvegshmat (torch.Tensor): Shadow matrices</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Keast, Ksouth, Kwest, Knorth, KsideI, KsideD, Kside) - </span>
<span class="sd">               Shortwave radiation components for each direction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">vikttot</span> <span class="o">=</span> <span class="mf">4.4897</span>
    <span class="n">aziE</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziS</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">90</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziW</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziN</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">270</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">deg2rad</span><span class="p">)</span>

    <span class="n">KsideD</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_veg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kside</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">Kref_veg_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_veg_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_veg_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_veg_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">Kref_sh_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sh_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sh_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sh_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">Kref_sun_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sun_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sun_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Kref_sun_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">KeastRef</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">KwestRef</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">KnorthRef</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">KsouthRef</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">diffRadE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">diffRadS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">diffRadW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">diffRadN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cyl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">KsideI</span> <span class="o">=</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="n">KeastI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">KsouthI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">KwestI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">KnorthI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">KeastI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">t</span><span class="p">)),</span>
                             <span class="n">radI</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziE</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">),</span>
                             <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="n">KsouthI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">270</span> <span class="o">-</span> <span class="n">t</span><span class="p">)),</span>
                              <span class="n">radI</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziS</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">),</span>
                              <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="n">KwestI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">t</span><span class="p">)),</span>
                             <span class="n">radI</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziW</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">),</span>
                             <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="n">KnorthI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">270</span> <span class="o">-</span> <span class="n">t</span><span class="p">)),</span>
                              <span class="n">radI</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziN</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">),</span>
                              <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="n">KsideI</span> <span class="o">=</span> <span class="n">shadow</span> <span class="o">*</span> <span class="mi">0</span>

    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span> <span class="o">=</span> <span class="n">Kvikt_veg</span><span class="p">(</span><span class="n">svfE</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>
    <span class="n">svfviktbuvegE</span> <span class="o">=</span> <span class="n">viktwall</span> <span class="o">+</span> <span class="p">(</span><span class="n">viktveg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="p">))</span>

    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span> <span class="o">=</span> <span class="n">Kvikt_veg</span><span class="p">(</span><span class="n">svfS</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>
    <span class="n">svfviktbuvegS</span> <span class="o">=</span> <span class="n">viktwall</span> <span class="o">+</span> <span class="p">(</span><span class="n">viktveg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="p">))</span>

    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span> <span class="o">=</span> <span class="n">Kvikt_veg</span><span class="p">(</span><span class="n">svfW</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>
    <span class="n">svfviktbuvegW</span> <span class="o">=</span> <span class="n">viktwall</span> <span class="o">+</span> <span class="p">(</span><span class="n">viktveg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="p">))</span>

    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span> <span class="o">=</span> <span class="n">Kvikt_veg</span><span class="p">(</span><span class="n">svfN</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>
    <span class="n">svfviktbuvegN</span> <span class="o">=</span> <span class="n">viktwall</span> <span class="o">+</span> <span class="p">(</span><span class="n">viktveg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">anisotropic_diffuse</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">anisotropic_sky</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">patch_altitude</span> <span class="o">=</span> <span class="n">lv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">patch_azimuth</span> <span class="o">=</span> <span class="n">lv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">anisotropic_sky</span><span class="p">:</span>
            <span class="n">patch_luminance</span> <span class="o">=</span> <span class="n">lv</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patch_luminance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">skyalt</span><span class="p">,</span> <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">radTot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">steradian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">steradian</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">360</span> <span class="o">/</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steradian</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">360</span> <span class="o">/</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span>

            <span class="n">radTot</span> <span class="o">+=</span> <span class="p">(</span><span class="n">patch_luminance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span>

        <span class="n">lumChi</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch_luminance</span> <span class="o">*</span> <span class="n">radD</span><span class="p">)</span> <span class="o">/</span> <span class="n">radTot</span>

        <span class="k">if</span> <span class="n">cyl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_azimuth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">anglIncC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
                <span class="n">KsideD</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lumChi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">anglIncC</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="n">sunlit_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">shaded_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">albedo</span> <span class="o">*</span> <span class="n">radD</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

                <span class="n">temp_vegsh</span> <span class="o">=</span> <span class="p">((</span><span class="n">vegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vbshvegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">Kref_veg</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

                <span class="n">temp_vbsh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">vbshvegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">temp_sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_vbsh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">sunlit_patches</span><span class="p">,</span> <span class="n">shaded_patches</span> <span class="o">=</span> <span class="n">shaded_or_sunlit</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">asvf</span><span class="p">)</span>
                <span class="n">Kref_sun</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="n">Kref_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

            <span class="n">Kside</span> <span class="o">=</span> <span class="n">KsideI</span> <span class="o">+</span> <span class="n">KsideD</span> <span class="o">+</span> <span class="n">Kref_sun</span> <span class="o">+</span> <span class="n">Kref_sh</span> <span class="o">+</span> <span class="n">Kref_veg</span>

            <span class="n">Keast</span> <span class="o">=</span> <span class="n">KupE</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Kwest</span> <span class="o">=</span> <span class="n">KupW</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Knorth</span> <span class="o">=</span> <span class="n">KupN</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Ksouth</span> <span class="o">=</span> <span class="n">KupS</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_azimuth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">):</span>
                    <span class="n">anglIncE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="n">diffRadE</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lumChi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">anglIncE</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">270</span><span class="p">):</span>
                    <span class="n">anglIncS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="n">diffRadS</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lumChi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">anglIncS</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">):</span>
                    <span class="n">anglIncW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="n">diffRadW</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lumChi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">anglIncW</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">):</span>
                    <span class="n">anglIncN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="n">diffRadN</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lumChi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">anglIncN</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="n">sunlit_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">radI</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">shaded_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">albedo</span> <span class="o">*</span> <span class="n">radD</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

                <span class="n">temp_vegsh</span> <span class="o">=</span> <span class="p">((</span><span class="n">vegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vbshvegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">Kref_veg</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                    <span class="n">Kref_veg_e</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                    <span class="n">Kref_veg_s</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                    <span class="n">Kref_veg_w</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
                    <span class="n">Kref_veg_n</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

                <span class="n">temp_vbsh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">vbshvegshmat</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">temp_sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_vbsh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">azimuth_difference</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">azimuth_difference</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth_difference</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                    <span class="n">sunlit_patches</span><span class="p">,</span> <span class="n">shaded_patches</span> <span class="o">=</span> <span class="n">shaded_or_sunlit</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">asvf</span><span class="p">)</span>
                    <span class="n">Kref_sun</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="n">Kref_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                        <span class="n">Kref_sun_e</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                        <span class="n">Kref_sh_e</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                        <span class="n">Kref_sun_s</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                        <span class="n">Kref_sh_s</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                        <span class="n">Kref_sun_w</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                        <span class="n">Kref_sh_w</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
                        <span class="n">Kref_sun_n</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                        <span class="n">Kref_sh_n</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Kref_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                        <span class="n">Kref_sh_e</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                        <span class="n">Kref_sh_s</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                        <span class="n">Kref_sh_w</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
                        <span class="n">Kref_sh_n</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

            <span class="n">Keast</span> <span class="o">=</span> <span class="n">KeastI</span> <span class="o">+</span> <span class="n">diffRadE</span> <span class="o">+</span> <span class="n">Kref_sun_e</span> <span class="o">+</span> <span class="n">Kref_sh_e</span> <span class="o">+</span> <span class="n">Kref_veg_e</span> <span class="o">+</span> <span class="n">KupE</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Kwest</span> <span class="o">=</span> <span class="n">KwestI</span> <span class="o">+</span> <span class="n">diffRadW</span> <span class="o">+</span> <span class="n">Kref_sun_w</span> <span class="o">+</span> <span class="n">Kref_sh_w</span> <span class="o">+</span> <span class="n">Kref_veg_w</span> <span class="o">+</span> <span class="n">KupW</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Knorth</span> <span class="o">=</span> <span class="n">KnorthI</span> <span class="o">+</span> <span class="n">diffRadN</span> <span class="o">+</span> <span class="n">Kref_sun_n</span> <span class="o">+</span> <span class="n">Kref_sh_n</span> <span class="o">+</span> <span class="n">Kref_veg_n</span> <span class="o">+</span> <span class="n">KupN</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Ksouth</span> <span class="o">=</span> <span class="n">KsouthI</span> <span class="o">+</span> <span class="n">diffRadS</span> <span class="o">+</span> <span class="n">Kref_sun_s</span> <span class="o">+</span> <span class="n">Kref_sh_s</span> <span class="o">+</span> <span class="n">Kref_veg_s</span> <span class="o">+</span> <span class="n">KupS</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">KeastDG</span> <span class="o">=</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfviktbuvegE</span><span class="p">)</span> <span class="o">+</span> <span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">svfviktbuvegE</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">+</span> <span class="n">KupE</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Keast</span> <span class="o">=</span> <span class="n">KeastI</span> <span class="o">+</span> <span class="n">KeastDG</span>

        <span class="n">KsouthDG</span> <span class="o">=</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfviktbuvegS</span><span class="p">)</span> <span class="o">+</span> <span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">svfviktbuvegS</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">+</span> <span class="n">KupS</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Ksouth</span> <span class="o">=</span> <span class="n">KsouthI</span> <span class="o">+</span> <span class="n">KsouthDG</span>

        <span class="n">KwestDG</span> <span class="o">=</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfviktbuvegW</span><span class="p">)</span> <span class="o">+</span> <span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">svfviktbuvegW</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">+</span> <span class="n">KupW</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Kwest</span> <span class="o">=</span> <span class="n">KwestI</span> <span class="o">+</span> <span class="n">KwestDG</span>

        <span class="n">KnorthDG</span> <span class="o">=</span> <span class="p">(</span><span class="n">radD</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfviktbuvegN</span><span class="p">)</span> <span class="o">+</span> <span class="n">albedo</span> <span class="o">*</span> <span class="p">(</span><span class="n">svfviktbuvegN</span> <span class="o">*</span> <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span> <span class="o">+</span> <span class="n">KupN</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Knorth</span> <span class="o">=</span> <span class="n">KnorthI</span> <span class="o">+</span> <span class="n">KnorthDG</span>

    <span class="k">del</span> <span class="n">temp_vegsh</span><span class="p">,</span><span class="n">temp_vbsh</span><span class="p">,</span><span class="n">temp_sh</span>
    <span class="k">del</span> <span class="n">Kref_sun</span> <span class="p">,</span><span class="n">Kref_sh</span> <span class="p">,</span><span class="n">Kref_veg</span>
    <span class="k">del</span> <span class="n">Kref_veg_n</span><span class="p">,</span><span class="n">Kref_veg_s</span><span class="p">,</span><span class="n">Kref_veg_e</span> <span class="p">,</span><span class="n">Kref_veg_w</span>
    <span class="k">del</span> <span class="n">Kref_sh_n</span> <span class="p">,</span><span class="n">Kref_sh_s</span> <span class="p">,</span><span class="n">Kref_sh_e</span> <span class="p">,</span><span class="n">Kref_sh_w</span>
    <span class="k">del</span> <span class="n">Kref_sun_n</span> <span class="p">,</span><span class="n">Kref_sun_s</span> <span class="p">,</span><span class="n">Kref_sun_e</span> <span class="p">,</span><span class="n">Kref_sun_w</span>
    <span class="k">del</span> <span class="n">KeastRef</span> <span class="p">,</span><span class="n">KwestRef</span> <span class="p">,</span><span class="n">KnorthRef</span><span class="p">,</span><span class="n">KsouthRef</span> <span class="p">,</span><span class="n">diffRadE</span> <span class="p">,</span><span class="n">diffRadS</span> <span class="p">,</span><span class="n">diffRadW</span> <span class="p">,</span><span class="n">diffRadN</span>
    <span class="k">del</span> <span class="n">KeastI</span><span class="p">,</span> <span class="n">KsouthI</span><span class="p">,</span> <span class="n">KwestI</span><span class="p">,</span> <span class="n">KnorthI</span><span class="p">,</span> <span class="n">viktveg</span><span class="p">,</span><span class="n">viktwall</span><span class="p">,</span><span class="n">svfviktbuvegE</span><span class="p">,</span><span class="n">svfviktbuvegS</span><span class="p">,</span><span class="n">svfviktbuvegW</span><span class="p">,</span><span class="n">svfviktbuvegN</span><span class="p">,</span><span class="n">KupW</span><span class="p">,</span><span class="n">KupN</span>

    <span class="k">return</span> <span class="n">Keast</span><span class="p">,</span> <span class="n">Ksouth</span><span class="p">,</span> <span class="n">Kwest</span><span class="p">,</span> <span class="n">Knorth</span><span class="p">,</span> <span class="n">KsideI</span><span class="p">,</span> <span class="n">KsideD</span><span class="p">,</span> <span class="n">Kside</span></div>



<div class="viewcode-block" id="sun_distance">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.sun_distance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_distance</span><span class="p">(</span><span class="n">jday</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Earth-Sun distance correction factor for given day.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        jday (torch.Tensor): Julian day of year</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Distance correction factor (dimensionless)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jday</span> <span class="o">/</span> <span class="mf">365.</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.00011</span> <span class="o">+</span> <span class="mf">0.034221</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001280</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.000719</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.000077</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">D</span></div>


<div class="viewcode-block" id="clearnessindex_2013b">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.clearnessindex_2013b">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clearnessindex_2013b</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">jday</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">RH</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate atmospheric clearness index.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        zen (torch.Tensor): Solar zenith angle (radians)</span>
<span class="sd">        jday (torch.Tensor): Julian day</span>
<span class="sd">        Ta (float): Air temperature (Â°C)</span>
<span class="sd">        RH (float): Relative humidity (%)</span>
<span class="sd">        radG (float): Global radiation (W/mÂ²)</span>
<span class="sd">        location (dict): Geographic location</span>
<span class="sd">        P (float): Atmospheric pressure (kPa)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Clearness index (dimensionless, 0-1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">P</span> <span class="o">==</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">1013.0</span>  <span class="c1"># Pressure in millibars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="mf">10.0</span>  <span class="c1"># Convert from hPa to millibars</span>

    <span class="n">Itoa</span> <span class="o">=</span> <span class="mf">1370.0</span>  <span class="c1"># Effective solar constant</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">sun_distance</span><span class="p">(</span><span class="n">jday</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mf">35.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zen</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1224.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zen</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>  <span class="c1"># optical air mass at p=1013</span>
    <span class="n">Trpg</span> <span class="o">=</span> <span class="mf">1.021</span> <span class="o">-</span> <span class="mf">0.084</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.000949</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">0.051</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>  <span class="c1"># Transmission coefficient for Rayleigh scattering and permanent gases</span>

    <span class="c1"># empirical constant depending on latitude</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.37</span><span class="p">,</span> <span class="mf">2.85</span><span class="p">,</span> <span class="mf">2.80</span><span class="p">,</span> <span class="mf">2.64</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">10.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">20.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.99</span><span class="p">,</span> <span class="mf">3.02</span><span class="p">,</span> <span class="mf">2.70</span><span class="p">,</span> <span class="mf">2.93</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">20.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">30.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.60</span><span class="p">,</span> <span class="mf">3.00</span><span class="p">,</span> <span class="mf">2.98</span><span class="p">,</span> <span class="mf">2.93</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">30.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">40.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.04</span><span class="p">,</span> <span class="mf">3.11</span><span class="p">,</span> <span class="mf">2.92</span><span class="p">,</span> <span class="mf">2.94</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">40.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">50.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.70</span><span class="p">,</span> <span class="mf">2.95</span><span class="p">,</span> <span class="mf">2.77</span><span class="p">,</span> <span class="mf">2.71</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">50.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">60.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.52</span><span class="p">,</span> <span class="mf">3.07</span><span class="p">,</span> <span class="mf">2.67</span><span class="p">,</span> <span class="mf">2.93</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">60.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">70.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.76</span><span class="p">,</span> <span class="mf">2.69</span><span class="p">,</span> <span class="mf">2.61</span><span class="p">,</span> <span class="mf">2.61</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">70.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.60</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">,</span> <span class="mf">2.24</span><span class="p">,</span> <span class="mf">2.63</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mf">80.0</span> <span class="o">&lt;=</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mf">90.0</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.11</span><span class="p">,</span> <span class="mf">1.44</span><span class="p">,</span> <span class="mf">1.94</span><span class="p">,</span> <span class="mf">2.02</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">jday</span> <span class="o">&gt;</span> <span class="mi">335</span> <span class="ow">or</span> <span class="n">jday</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mi">60</span> <span class="o">&lt;</span> <span class="n">jday</span> <span class="o">&lt;=</span> <span class="mi">152</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mi">152</span> <span class="o">&lt;</span> <span class="n">jday</span> <span class="o">&lt;=</span> <span class="mi">244</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="mi">244</span> <span class="o">&lt;</span> <span class="n">jday</span> <span class="o">&lt;=</span> <span class="mi">335</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># dewpoint calculation</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">17.27</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">237.7</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2</span> <span class="o">*</span> <span class="p">(((</span><span class="n">a2</span> <span class="o">*</span> <span class="n">Ta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b2</span> <span class="o">+</span> <span class="n">Ta</span><span class="p">))</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">RH</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="p">(((</span><span class="n">a2</span> <span class="o">*</span> <span class="n">Ta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b2</span> <span class="o">+</span> <span class="n">Ta</span><span class="p">))</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">RH</span><span class="p">)))</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="p">(</span><span class="n">Td</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span>  <span class="c1"># Dewpoint (F)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.1133</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.0393</span> <span class="o">*</span> <span class="n">Td</span><span class="p">)</span> 
    <span class="n">Tw</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.077</span> <span class="o">*</span> <span class="p">((</span><span class="n">u</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># Transmission coefficient for water vapor</span>
    <span class="n">Tar</span> <span class="o">=</span> <span class="mf">0.935</span> <span class="o">**</span> <span class="n">m</span>  <span class="c1"># Transmission coefficient for aerosols</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="n">Itoa</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zen</span><span class="p">)</span> <span class="o">*</span> <span class="n">Trpg</span> <span class="o">*</span> <span class="n">Tw</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Tar</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">I0</span><span class="p">)</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">I0</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">I0</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="mf">0.1473</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="p">(</span><span class="n">zen</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.3454</span>  <span class="c1"># 20070329</span>
    <span class="n">CIuncorr</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">/</span> <span class="n">I0</span>
    <span class="n">CI</span> <span class="o">=</span> <span class="n">CIuncorr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span><span class="p">)</span>
    <span class="n">I0et</span> <span class="o">=</span> <span class="n">Itoa</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zen</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span>  <span class="c1"># extra terrestrial solar radiation</span>
    <span class="n">Kt</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">/</span> <span class="n">I0et</span>

    <span class="k">return</span> <span class="n">I0</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">Kt</span><span class="p">,</span> <span class="n">I0et</span><span class="p">,</span> <span class="n">CIuncorr</span></div>


<div class="viewcode-block" id="diffusefraction">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.diffusefraction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">diffusefraction</span><span class="p">(</span><span class="n">radG</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">Kt</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">RH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fraction of diffuse radiation from global radiation.</span>
<span class="sd">    </span>
<span class="sd">    Uses empirical models to partition global radiation into direct and diffuse components.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        radG (float): Global horizontal radiation (W/mÂ²)</span>
<span class="sd">        altitude (torch.Tensor): Solar altitude (degrees)</span>
<span class="sd">        Kt (torch.Tensor): Clearness index</span>
<span class="sd">        Ta (float): Air temperature (Â°C)</span>
<span class="sd">        RH (float): Relative humidity (%)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (radD, radI) where:</span>
<span class="sd">            - radD: Diffuse radiation (W/mÂ²)</span>
<span class="sd">            - radI: Direct beam radiation (W/mÂ²)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">Ta</span> <span class="o">=</span> <span class="n">ensure_tensor</span><span class="p">(</span><span class="n">Ta</span><span class="p">)</span>
    <span class="n">RH</span> <span class="o">=</span> <span class="n">ensure_tensor</span><span class="p">(</span><span class="n">RH</span><span class="p">)</span>
    <span class="n">alfa</span> <span class="o">=</span> <span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span>
    <span class="n">alfa</span> <span class="o">=</span> <span class="n">ensure_tensor</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Ta</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">999.00</span> <span class="ow">or</span> <span class="n">RH</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">999.00</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Ta</span><span class="p">)</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RH</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">Kt</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.020</span> <span class="o">-</span> <span class="mf">0.248</span> <span class="o">*</span> <span class="n">Kt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mf">0.3</span> <span class="o">&lt;</span> <span class="n">Kt</span> <span class="o">&lt;</span> <span class="mf">0.78</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.45</span> <span class="o">-</span> <span class="mf">1.67</span> <span class="o">*</span> <span class="n">Kt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="mf">0.147</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RH</span> <span class="o">=</span> <span class="n">RH</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">Kt</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.232</span> <span class="o">*</span> <span class="n">Kt</span> <span class="o">+</span> <span class="mf">0.0239</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.000682</span> <span class="o">*</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">0.0195</span> <span class="o">*</span> <span class="n">RH</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mf">0.3</span> <span class="o">&lt;</span> <span class="n">Kt</span> <span class="o">&lt;</span> <span class="mf">0.78</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.329</span> <span class="o">-</span> <span class="mf">1.716</span> <span class="o">*</span> <span class="n">Kt</span> <span class="o">+</span> <span class="mf">0.267</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.00357</span> <span class="o">*</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">0.106</span> <span class="o">*</span> <span class="n">RH</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radD</span> <span class="o">=</span> <span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.426</span> <span class="o">*</span> <span class="n">Kt</span> <span class="o">-</span> <span class="mf">0.256</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.00349</span> <span class="o">*</span> <span class="n">Ta</span> <span class="o">+</span> <span class="mf">0.0734</span> <span class="o">*</span> <span class="n">RH</span><span class="p">)</span>

    <span class="n">radI</span> <span class="o">=</span> <span class="p">(</span><span class="n">radG</span> <span class="o">-</span> <span class="n">radD</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>

    <span class="c1"># Corrections for low sun altitudes (20130307)</span>
    <span class="n">radI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">radI</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">radI</span><span class="p">)</span>
    <span class="n">radI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">altitude</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">radI</span> <span class="o">&gt;</span> <span class="n">radG</span><span class="p">),</span> <span class="n">radG</span><span class="p">,</span> <span class="n">radI</span><span class="p">)</span>
    <span class="n">radD</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">radD</span> <span class="o">&gt;</span> <span class="n">radG</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">radD</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">radI</span><span class="p">,</span> <span class="n">radD</span></div>


<div class="viewcode-block" id="shadowingfunction_wallheight_13">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.shadowingfunction_wallheight_13">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">shadowingfunction_wallheight_13</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">aspect</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate shadow patterns accounting for wall heights (method 1.3).</span>
<span class="sd">    </span>
<span class="sd">    Determines which surfaces are in shadow cast by nearby walls based on</span>
<span class="sd">    solar angle, wall height, and wall orientation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (vegsh, sh, vbshvegsh, wallsh, wallsun, wallshve, facesh, facesun)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">walls</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># Add the implementation for creating walls if needed</span>

    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="n">sizex</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sizey</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">wallbol</span> <span class="o">=</span> <span class="p">(</span><span class="n">walls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">amaxvalue</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">pibyfour</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">threetimespibyfour</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">fivetimespibyfour</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">seventimespibyfour</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">sinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">cosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">tanazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">signsinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sinazimuth</span><span class="p">)</span>
    <span class="n">signcosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cosazimuth</span><span class="p">)</span>
    <span class="n">dssin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sinazimuth</span><span class="p">)</span>
    <span class="n">dscos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">cosazimuth</span><span class="p">)</span>
    <span class="n">tanaltitudebyscale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">amaxvalue</span> <span class="o">&gt;=</span> <span class="n">dz</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sizex</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sizey</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span> <span class="ow">and</span> <span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">threetimespibyfour</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fivetimespibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span> <span class="ow">and</span> <span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">seventimespibyfour</span><span class="p">):</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">index</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">/</span> <span class="n">tanazimuth</span><span class="p">))</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dssin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">tanazimuth</span><span class="p">))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">index</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dscos</span>

        <span class="n">dz</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">*</span> <span class="n">index</span> <span class="o">*</span> <span class="n">tanaltitudebyscale</span>
        <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">sizex</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">sizey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">absdx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">absdy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>

        <span class="n">xc1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xc2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizex</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yc1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yc2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizey</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">xp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">xp2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizex</span> <span class="o">-</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">yp2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizey</span> <span class="o">-</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">temp</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dz</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">azilow</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">azihigh</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">azilow</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&lt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&gt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="n">wallbol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">azilow</span> <span class="o">=</span> <span class="n">azilow</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">azihigh</span> <span class="o">=</span> <span class="n">azihigh</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">facesun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">facesh</span> <span class="o">+</span> <span class="n">wallbol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">walls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">walls</span> <span class="o">-</span> <span class="n">sh</span>
    <span class="n">wallsun</span><span class="p">[</span><span class="n">wallsun</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wallsun</span><span class="p">[</span><span class="n">facesh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wallsh</span> <span class="o">=</span> <span class="n">walls</span> <span class="o">-</span> <span class="n">wallsun</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">del</span> <span class="n">temp</span>

    <span class="k">return</span> <span class="n">sh</span><span class="p">,</span> <span class="n">wallsh</span><span class="p">,</span> <span class="n">wallsun</span><span class="p">,</span> <span class="n">facesh</span><span class="p">,</span> <span class="n">facesun</span></div>



<div class="viewcode-block" id="shadowingfunction_wallheight_23">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.shadowingfunction_wallheight_23">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">shadowingfunction_wallheight_23</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">vegdem</span><span class="p">,</span> <span class="n">vegdem2</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">amaxvalue</span><span class="p">,</span> <span class="n">bush</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">aspect</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate shadow patterns with vegetation and wall heights (method 2.3).</span>
<span class="sd">    </span>
<span class="sd">    Extended shadow calculation including vegetation layers and building walls.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Shadow components including vegetation effects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">degrees</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">degrees</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">degrees</span>

    <span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># initialise parameters</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempvegdem</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">tempvegdem2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">templastfabovea</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">templastgabovea</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bushplant</span> <span class="o">=</span> <span class="n">bush</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> 
    <span class="n">vbshvegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> 
    <span class="n">vegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">bushplant</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
    <span class="n">f</span> <span class="o">=</span> <span class="n">a</span> 
    <span class="n">shvoveg</span> <span class="o">=</span> <span class="n">vegdem</span> 
    <span class="n">wallbol</span> <span class="o">=</span> <span class="p">(</span><span class="n">walls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">pibyfour</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">threetimespibyfour</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">fivetimespibyfour</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">seventimespibyfour</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">pibyfour</span>
    <span class="n">sinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">cosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">tanazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">signsinazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sinazimuth</span><span class="p">)</span>
    <span class="n">signcosazimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cosazimuth</span><span class="p">)</span>
    <span class="n">dssin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sinazimuth</span><span class="p">)</span>
    <span class="n">dscos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">cosazimuth</span><span class="p">)</span>
    <span class="n">tanaltitudebyscale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dzprev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">amaxvalue</span> <span class="o">&gt;=</span> <span class="n">dz</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sizex</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sizey</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">threetimespibyfour</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">fivetimespibyfour</span> <span class="o">&lt;=</span> <span class="n">azimuth</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;</span> <span class="n">seventimespibyfour</span><span class="p">)):</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">index</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">/</span> <span class="n">tanazimuth</span><span class="p">))</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dssin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">signsinazimuth</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">tanazimuth</span><span class="p">))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">signcosazimuth</span> <span class="o">*</span> <span class="n">index</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dscos</span>

        <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="n">tanaltitudebyscale</span>
        <span class="n">tempvegdem</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">tempvegdem2</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">templastfabovea</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">templastgabovea</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

        <span class="n">absdx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">absdy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">xc1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xc2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizex</span> <span class="o">+</span> <span class="p">(</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yc1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yc2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizey</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xp1</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">((</span><span class="n">dx</span> <span class="o">-</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xp2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizex</span> <span class="o">-</span> <span class="p">(</span><span class="n">dx</span> <span class="o">+</span> <span class="n">absdx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yp1</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">((</span><span class="n">dy</span> <span class="o">-</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">yp2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizey</span> <span class="o">-</span> <span class="p">(</span><span class="n">dy</span> <span class="o">+</span> <span class="n">absdy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">tempvegdem</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vegdem</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dz</span>
        <span class="n">tempvegdem2</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vegdem2</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dz</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dz</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span> <span class="c1"># Moving building shadow</span>
        <span class="n">shvoveg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">shvoveg</span><span class="p">,</span> <span class="n">tempvegdem</span><span class="p">)</span> <span class="c1"># moving vegetation shadow volume</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="n">fabovea</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempvegdem</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>   <span class="c1"># vegdem above DEM</span>
        <span class="n">gabovea</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempvegdem2</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>   <span class="c1"># vegdem2 above DEM</span>

        <span class="n">templastfabovea</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vegdem</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dzprev</span>
        <span class="n">templastgabovea</span><span class="p">[</span><span class="n">xp1</span><span class="p">:</span><span class="n">xp2</span><span class="p">,</span> <span class="n">yp1</span><span class="p">:</span><span class="n">yp2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vegdem2</span><span class="p">[</span><span class="n">xc1</span><span class="p">:</span><span class="n">xc2</span><span class="p">,</span> <span class="n">yc1</span><span class="p">:</span><span class="n">yc2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dzprev</span>
        <span class="n">lastfabovea</span> <span class="o">=</span> <span class="n">templastfabovea</span> <span class="o">&gt;</span> <span class="n">a</span>
        <span class="n">lastgabovea</span> <span class="o">=</span> <span class="n">templastgabovea</span> <span class="o">&gt;</span> <span class="n">a</span>
        <span class="n">dzprev</span> <span class="o">=</span> <span class="n">dz</span>
        <span class="n">vegsh2</span> <span class="o">=</span> <span class="n">fabovea</span> <span class="o">+</span> <span class="n">gabovea</span> <span class="o">+</span> <span class="n">lastfabovea</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">+</span> <span class="n">lastgabovea</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">vegsh2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vegsh2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">vegsh2</span><span class="p">)</span>
        <span class="n">vegsh2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vegsh2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">vegsh2</span><span class="p">)</span>

        <span class="n">vegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">vegsh</span><span class="p">,</span> <span class="n">vegsh2</span><span class="p">)</span>
        <span class="n">vegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vegsh</span> <span class="o">*</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">vegsh</span><span class="p">)</span>
        <span class="n">vbshvegsh</span> <span class="o">=</span> <span class="n">vbshvegsh</span> <span class="o">+</span> <span class="n">vegsh</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">azilow</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">azihigh</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">azilow</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>    <span class="c1"># 90 to 270  (SHADOW)</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&lt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&gt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">-</span> <span class="n">wallbol</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>    <span class="c1"># 0 to 90</span>
        <span class="n">azilow</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">azilow</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">azihigh</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>    <span class="c1"># 270 to 360</span>
        <span class="n">azihigh</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">facesh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">aspect</span> <span class="o">&gt;</span> <span class="n">azilow</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">&lt;=</span> <span class="n">azihigh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sh</span>
    <span class="n">vbshvegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vbshvegsh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">vbshvegsh</span><span class="p">)</span>
    <span class="n">vbshvegsh</span> <span class="o">=</span> <span class="n">vbshvegsh</span> <span class="o">-</span> <span class="n">vegsh</span>

    <span class="n">vegsh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vegsh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">vegsh</span><span class="p">)</span>
    <span class="n">shvoveg</span> <span class="o">=</span> <span class="p">(</span><span class="n">shvoveg</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">vegsh</span>  <span class="c1"># Vegetation shadow volume</span>
    <span class="n">vegsh</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">vegsh</span>
    <span class="n">vbshvegsh</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">vbshvegsh</span>

    <span class="n">shvo</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">a</span>   <span class="c1"># building shadow volume</span>
    <span class="n">facesun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">facesh</span> <span class="o">+</span> <span class="n">wallbol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">walls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">walls</span> <span class="o">-</span> <span class="n">shvo</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wallsun</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">wallsun</span><span class="p">)</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">facesh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">wallsun</span><span class="p">)</span>
    <span class="n">wallsh</span> <span class="o">=</span> <span class="n">walls</span> <span class="o">-</span> <span class="n">wallsun</span>

    <span class="n">wallshve</span> <span class="o">=</span> <span class="n">shvoveg</span> <span class="o">*</span> <span class="n">wallbol</span>
    <span class="n">wallshve</span> <span class="o">=</span> <span class="n">wallshve</span> <span class="o">-</span> <span class="n">wallsh</span>
    <span class="n">wallshve</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wallshve</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">wallshve</span><span class="p">)</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">wallsun</span> <span class="o">-</span> <span class="n">wallshve</span>
    <span class="n">wallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wallsun</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">wallsun</span><span class="p">)</span>
    <span class="n">wallshve</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wallshve</span> <span class="o">&gt;</span> <span class="n">walls</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">wallshve</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">fabovea</span><span class="p">,</span><span class="n">gabovea</span><span class="p">,</span><span class="n">lastfabovea</span><span class="p">,</span><span class="n">lastgabovea</span><span class="p">,</span><span class="n">vegsh2</span>
    <span class="k">del</span> <span class="n">tempvegdem</span><span class="p">,</span><span class="n">tempvegdem2</span><span class="p">,</span><span class="n">templastfabovea</span><span class="p">,</span><span class="n">templastgabovea</span><span class="p">,</span><span class="n">shvoveg</span><span class="p">,</span><span class="n">wallbol</span>

    <span class="k">return</span> <span class="n">vegsh</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">vbshvegsh</span><span class="p">,</span> <span class="n">wallsh</span><span class="p">,</span> <span class="n">wallsun</span><span class="p">,</span> <span class="n">wallshve</span><span class="p">,</span> <span class="n">facesh</span><span class="p">,</span> <span class="n">facesun</span></div>



<div class="viewcode-block" id="Perez_v3">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Perez_v3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Perez_v3</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radI</span><span class="p">,</span> <span class="n">jday</span><span class="p">,</span> <span class="n">patchchoice</span><span class="p">,</span> <span class="n">patch_option</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate anisotropic diffuse radiation distribution using Perez model.</span>
<span class="sd">    </span>
<span class="sd">    Implements the Perez all-weather sky model for anisotropic diffuse radiation,</span>
<span class="sd">    accounting for circumsolar brightening and horizon brightening.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        zen (torch.Tensor): Solar zenith angle (radians)</span>
<span class="sd">        azimuth (torch.Tensor): Solar azimuth (radians)</span>
<span class="sd">        radD (float): Diffuse radiation (W/mÂ²)</span>
<span class="sd">        radI (float): Direct beam radiation (W/mÂ²)</span>
<span class="sd">        jday (torch.Tensor): Julian day</span>
<span class="sd">        patchchoice (int): Patch selection</span>
<span class="sd">        patch_option (int): Sky discretization (144 or 2304)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Patch-wise diffuse radiation distribution and anisotropic SVF</span>
<span class="sd">    </span>
<span class="sd">    Reference:</span>
<span class="sd">        Perez et al. (1993). All-weather model for sky luminance distribution.</span>
<span class="sd">        Solar Energy, 50(3), 235-245.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">m_a1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.3525</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2219</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5484</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0156</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0500</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_a2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2576</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7730</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2515</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6654</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3566</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3670</span><span class="p">,</span> <span class="mf">0.0211</span><span class="p">,</span> <span class="mf">0.0289</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_a3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2690</span><span class="p">,</span> <span class="mf">1.4148</span><span class="p">,</span> <span class="mf">0.8952</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2672</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5000</span><span class="p">,</span> <span class="mf">1.0078</span><span class="p">,</span> <span class="mf">0.5025</span><span class="p">,</span> <span class="mf">0.4260</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_a4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">1.4366</span><span class="p">,</span> <span class="mf">1.1016</span><span class="p">,</span> <span class="mf">0.0156</span><span class="p">,</span> <span class="mf">0.7117</span><span class="p">,</span> <span class="mf">2.3250</span><span class="p">,</span> <span class="mf">1.4051</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5119</span><span class="p">,</span> <span class="mf">0.3590</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_b1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.7670</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2054</span><span class="p">,</span> <span class="mf">0.2782</span><span class="p">,</span> <span class="mf">0.7234</span><span class="p">,</span> <span class="mf">0.2937</span><span class="p">,</span> <span class="mf">0.2875</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3250</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_b2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0007</span><span class="p">,</span> <span class="mf">0.0367</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1812</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6219</span><span class="p">,</span> <span class="mf">0.0496</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5328</span><span class="p">,</span> <span class="mf">0.1922</span><span class="p">,</span> <span class="mf">0.1156</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_b3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.2734</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9128</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5000</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.6812</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.6812</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8500</span><span class="p">,</span> <span class="mf">0.7023</span><span class="p">,</span> <span class="mf">0.7781</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_b4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1233</span><span class="p">,</span> <span class="mf">0.9156</span><span class="p">,</span> <span class="mf">1.1766</span><span class="p">,</span> <span class="mf">2.6297</span><span class="p">,</span> <span class="mf">1.8415</span><span class="p">,</span> <span class="mf">3.3750</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6317</span><span class="p">,</span> <span class="mf">0.0025</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_c1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">2.8000</span><span class="p">,</span> <span class="mf">6.9750</span><span class="p">,</span> <span class="mf">24.7219</span><span class="p">,</span> <span class="mf">33.3389</span><span class="p">,</span> <span class="mf">21.0000</span><span class="p">,</span> <span class="mf">14.0000</span><span class="p">,</span> <span class="mf">19.0000</span><span class="p">,</span> <span class="mf">31.0625</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_c2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.6004</span><span class="p">,</span> <span class="mf">0.1774</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.0812</span><span class="p">,</span> <span class="o">-</span><span class="mf">18.3000</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.7656</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9999</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.5000</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_c3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.2375</span><span class="p">,</span> <span class="mf">6.4477</span><span class="p">,</span> <span class="o">-</span><span class="mf">37.7000</span><span class="p">,</span> <span class="o">-</span><span class="mf">62.2500</span><span class="p">,</span> <span class="o">-</span><span class="mf">21.5906</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.1406</span><span class="p">,</span> <span class="mf">1.2438</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.1148</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_c4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1239</span><span class="p">,</span> <span class="mf">34.8438</span><span class="p">,</span> <span class="mf">52.0781</span><span class="p">,</span> <span class="mf">7.2492</span><span class="p">,</span> <span class="mf">7.5469</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9094</span><span class="p">,</span> <span class="mf">55.3750</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_d1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.8734</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5798</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5000</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5000</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.4000</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.2312</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_d2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.6297</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5081</span><span class="p">,</span> <span class="mf">1.5218</span><span class="p">,</span> <span class="mf">0.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1554</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1078</span><span class="p">,</span> <span class="mf">0.0250</span><span class="p">,</span> <span class="mf">0.4050</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_d3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.9738</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7812</span><span class="p">,</span> <span class="mf">3.9229</span><span class="p">,</span> <span class="mf">1.1477</span><span class="p">,</span> <span class="mf">1.4062</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0750</span><span class="p">,</span> <span class="mf">0.3844</span><span class="p">,</span> <span class="mf">13.3500</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_d4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.2809</span><span class="p">,</span> <span class="mf">0.1080</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.6204</span><span class="p">,</span> <span class="mf">0.1062</span><span class="p">,</span> <span class="mf">0.3988</span><span class="p">,</span> <span class="mf">1.5702</span><span class="p">,</span> <span class="mf">0.2656</span><span class="p">,</span> <span class="mf">0.6234</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_e1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0356</span><span class="p">,</span> <span class="mf">0.2624</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0156</span><span class="p">,</span> <span class="mf">0.4659</span><span class="p">,</span> <span class="mf">0.0032</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0672</span><span class="p">,</span> <span class="mf">1.0468</span><span class="p">,</span> <span class="mf">1.5000</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_e2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1246</span><span class="p">,</span> <span class="mf">0.0672</span><span class="p">,</span> <span class="mf">0.1597</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3296</span><span class="p">,</span> <span class="mf">0.0766</span><span class="p">,</span> <span class="mf">0.4016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3788</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6426</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_e3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5718</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2190</span><span class="p">,</span> <span class="mf">0.4199</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0876</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0656</span><span class="p">,</span> <span class="mf">0.3017</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4517</span><span class="p">,</span> <span class="mf">1.8564</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">m_e4</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.9938</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4285</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5562</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0329</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1294</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4844</span><span class="p">,</span> <span class="mf">1.4656</span><span class="p">,</span> <span class="mf">0.5636</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">acoeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m_a1</span><span class="p">,</span> <span class="n">m_a2</span><span class="p">,</span> <span class="n">m_a3</span><span class="p">,</span> <span class="n">m_a4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bcoeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m_b1</span><span class="p">,</span> <span class="n">m_b2</span><span class="p">,</span> <span class="n">m_b3</span><span class="p">,</span> <span class="n">m_b4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ccoeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m_c1</span><span class="p">,</span> <span class="n">m_c2</span><span class="p">,</span> <span class="n">m_c3</span><span class="p">,</span> <span class="n">m_c4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dcoeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m_d1</span><span class="p">,</span> <span class="n">m_d2</span><span class="p">,</span> <span class="n">m_d3</span><span class="p">,</span> <span class="n">m_d4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ecoeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m_e1</span><span class="p">,</span> <span class="n">m_e2</span><span class="p">,</span> <span class="n">m_e3</span><span class="p">,</span> <span class="n">m_e4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">rad2deg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">zen</span>
    <span class="n">zen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span>
    <span class="n">Idh</span> <span class="o">=</span> <span class="n">radD</span> 
    <span class="n">Ibn</span> <span class="o">=</span> <span class="n">radI</span>

    <span class="n">PerezClearness</span> <span class="o">=</span> <span class="p">((</span><span class="n">Idh</span> <span class="o">+</span> <span class="n">Ibn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Idh</span> <span class="o">+</span> <span class="mf">1.041</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1.041</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">day_angle</span> <span class="o">=</span> <span class="n">jday</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="mi">1367</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.00011</span> <span class="o">+</span> <span class="mf">0.034221</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">day_angle</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.00128</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">day_angle</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.000719</span> <span class="o">*</span>
                 <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">day_angle</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.000077</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">day_angle</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">:</span>
        <span class="n">AirMass</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">altitude</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">AirMass</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.50572</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">6.07995</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6364</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">AirMass</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.50572</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="n">altitude</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">6.07995</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6364</span><span class="p">)</span>

    <span class="n">PerezBrightness</span> <span class="o">=</span> <span class="p">(</span><span class="n">AirMass</span> <span class="o">*</span> <span class="n">Idh</span><span class="p">)</span> <span class="o">/</span> <span class="n">I0</span>
    <span class="k">if</span> <span class="n">Idh</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">PerezBrightness</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">1.065</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">1.230</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">1.500</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">1.950</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">2.800</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">4.500</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">PerezClearness</span> <span class="o">&lt;</span> <span class="mf">6.200</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intClearness</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="n">m_a</span> <span class="o">=</span> <span class="n">acoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">acoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span> <span class="o">+</span> <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">acoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">acoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">)</span>
    <span class="n">m_b</span> <span class="o">=</span> <span class="n">bcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span> <span class="o">+</span> <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">bcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">)</span>
    <span class="n">m_e</span> <span class="o">=</span> <span class="n">ecoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span> <span class="o">+</span> <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">ecoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intClearness</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">m_c</span> <span class="o">=</span> <span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span> <span class="o">+</span> <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">)</span>
        <span class="n">m_d</span> <span class="o">=</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span> <span class="o">+</span> <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">),</span> <span class="n">ccoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">m_d</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">PerezBrightness</span> <span class="o">*</span> <span class="p">(</span><span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zen</span><span class="p">))</span> <span class="o">+</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
              <span class="n">PerezBrightness</span> <span class="o">*</span> <span class="n">dcoeff</span><span class="p">[</span><span class="n">intClearness</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">PerezBrightness</span>

    <span class="k">if</span> <span class="n">patchchoice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">skyvaultalt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="mi">361</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">skyvaultazi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span> <span class="mi">361</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">90</span><span class="p">):</span>
            <span class="n">skyvaultalt</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">91</span> <span class="o">-</span> <span class="n">j</span>
            <span class="n">skyvaultazi</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">361</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">patchchoice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">skyvaultalt</span><span class="p">,</span> <span class="n">skyvaultazi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_patches</span><span class="p">(</span><span class="n">patch_option</span><span class="p">)</span>

    <span class="n">skyvaultzen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">skyvaultalt</span><span class="p">)</span> <span class="o">*</span> <span class="n">deg2rad</span>
    <span class="n">skyvaultalt</span> <span class="o">=</span> <span class="n">skyvaultalt</span> <span class="o">*</span> <span class="n">deg2rad</span>
    <span class="n">skyvaultazi</span> <span class="o">=</span> <span class="n">skyvaultazi</span> <span class="o">*</span> <span class="n">deg2rad</span>

    <span class="n">cosSkySunAngle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">skyvaultalt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skyvaultalt</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">skyvaultazi</span> <span class="o">-</span> <span class="n">azimuth</span><span class="p">))</span>

    <span class="n">lv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m_a</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_b</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skyvaultzen</span><span class="p">)))</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m_c</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_d</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosSkySunAngle</span><span class="p">))</span> <span class="o">+</span>
                                                                 <span class="n">m_e</span> <span class="o">*</span> <span class="n">cosSkySunAngle</span> <span class="o">*</span> <span class="n">cosSkySunAngle</span><span class="p">))</span>

    <span class="n">lv</span> <span class="o">=</span> <span class="n">lv</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">patchchoice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">skyvaultalt</span> <span class="o">*</span> <span class="n">rad2deg</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">skyvaultazi</span> <span class="o">*</span> <span class="n">rad2deg</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lv</span><span class="p">,</span> <span class="n">PerezClearness</span><span class="p">,</span> <span class="n">PerezBrightness</span></div>


<div class="viewcode-block" id="model1">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.model1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model1</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate longwave sky radiation using Model 1 (isotropic).&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">SBC</span> <span class="o">=</span> <span class="mf">5.67051e-8</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">skyalt</span><span class="p">,</span> <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skyzen</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">skyalt</span>
    <span class="n">cosskyzen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skyzen</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

    <span class="n">a_c</span> <span class="o">=</span> <span class="mf">0.67</span>
    <span class="n">b_c</span> <span class="o">=</span> <span class="mf">0.094</span>

    <span class="n">ln_u_prec</span> <span class="o">=</span> <span class="n">esky</span> <span class="o">/</span> <span class="n">b_c</span> <span class="o">-</span> <span class="n">a_c</span> <span class="o">/</span> <span class="n">b_c</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">u_prec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_u_prec</span><span class="p">)</span>
    <span class="n">owp</span> <span class="o">=</span> <span class="n">u_prec</span> <span class="o">/</span> <span class="n">cosskyzen</span>
    <span class="n">log_owp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">owp</span><span class="p">)</span>

    <span class="n">esky_band</span> <span class="o">=</span> <span class="n">a_c</span> <span class="o">+</span> <span class="n">b_c</span> <span class="o">*</span> <span class="n">log_owp</span>
    <span class="n">p_alt</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">patch_emissivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p_alt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">skyalt</span><span class="p">:</span>
        <span class="n">temp_emissivity</span> <span class="o">=</span> <span class="n">esky_band</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">patch_emissivity</span><span class="p">[</span><span class="n">p_alt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_emissivity</span>

    <span class="n">patch_emissivity_normalized</span> <span class="o">=</span> <span class="n">patch_emissivity</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patch_emissivity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span></div>


<div class="viewcode-block" id="model2">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.model2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model2</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate longwave sky radiation using Model 2 (simple anisotropic).&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">skyalt</span><span class="p">,</span> <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skyzen</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">skyalt</span>

    <span class="n">b_c</span> <span class="o">=</span> <span class="mf">0.308</span>

    <span class="n">esky_band</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">esky</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.7</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skyzen</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))))</span>
    <span class="n">p_alt</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">patch_emissivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p_alt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">skyalt</span><span class="p">:</span>
        <span class="n">temp_emissivity</span> <span class="o">=</span> <span class="n">esky_band</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">patch_emissivity</span><span class="p">[</span><span class="n">p_alt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_emissivity</span>

    <span class="n">patch_emissivity_normalized</span> <span class="o">=</span> <span class="n">patch_emissivity</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patch_emissivity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span></div>


<div class="viewcode-block" id="model3">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.model3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">model3</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate longwave sky radiation using Model 3 (advanced anisotropic).&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">skyalt</span><span class="p">,</span> <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skyzen</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">skyalt</span>

    <span class="n">b_c</span> <span class="o">=</span> <span class="mf">1.8</span>

    <span class="n">esky_band</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">esky</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">b_c</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skyzen</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)))</span>
    <span class="n">p_alt</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">patch_emissivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p_alt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">skyalt</span><span class="p">:</span>
        <span class="n">temp_emissivity</span> <span class="o">=</span> <span class="n">esky_band</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">patch_emissivity</span><span class="p">[</span><span class="n">p_alt</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_emissivity</span>

    <span class="n">patch_emissivity_normalized</span> <span class="o">=</span> <span class="n">patch_emissivity</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patch_emissivity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span></div>



<div class="viewcode-block" id="define_patch_characteristics">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.define_patch_characteristics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">define_patch_characteristics</span><span class="p">(</span><span class="n">solar_altitude</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span>
                                 <span class="n">patch_altitude</span><span class="p">,</span> <span class="n">patch_azimuth</span><span class="p">,</span> <span class="n">steradian</span><span class="p">,</span>
                                 <span class="n">asvf</span><span class="p">,</span>
                                 <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">,</span>
                                 <span class="n">Lsky_down</span><span class="p">,</span> <span class="n">Lsky_side</span><span class="p">,</span> <span class="n">Lsky</span><span class="p">,</span> <span class="n">Lup</span><span class="p">,</span>
                                 <span class="n">Ta</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span>
                                 <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate longwave radiation from discretized sky hemisphere patches.</span>
<span class="sd">    </span>
<span class="sd">    Computes downward and sideward longwave radiation by integrating</span>
<span class="sd">    contributions from individual sky patches, accounting for their</span>
<span class="sd">    position, solid angle, shadow state, and temperature.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        solar_altitude, solar_azimuth (float): Solar position (degrees)</span>
<span class="sd">        patch_altitude, patch_azimuth (torch.Tensor): Patch positions</span>
<span class="sd">        steradian (torch.Tensor): Solid angle of each patch</span>
<span class="sd">        asvf (torch.Tensor): Anisotropic sky view factor</span>
<span class="sd">        shmat, vegshmat, vbshvegshmat (torch.Tensor): Shadow matrices</span>
<span class="sd">        Lsky_down, Lsky_side, Lsky (torch.Tensor): Sky longwave components</span>
<span class="sd">        Lup (torch.Tensor): Upward longwave from ground</span>
<span class="sd">        Ta (float): Air temperature (Â°C)</span>
<span class="sd">        Tgwall (torch.Tensor): Wall/ground temperature (K)</span>
<span class="sd">        ewall (float): Wall emissivity</span>
<span class="sd">        rows, cols (int): Grid dimensions</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Ldown, Lside, Lside_sky, Lside_veg, Lside_sh, Lside_sun, </span>
<span class="sd">                Lside_ref, Least, Lwest, Lnorth, Lsouth) - Longwave components</span>
<span class="sd">                for downward, sideward (total and directional)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Integrates over all sky patches using solid angle weighting</span>
<span class="sd">        - Accounts for patch visibility through shadow matrices</span>
<span class="sd">        - Distinguishes between sunlit and shaded patches</span>
<span class="sd">        - Computes directional components (E, S, W, N)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># Stefan-Boltzmann&#39;s Constant</span>
    <span class="n">SBC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">5.67051e-8</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Define variables</span>
    <span class="n">Ldown</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Ldown_sky</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Ldown_veg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Ldown_sun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Ldown_sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Ldown_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">Lside</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside_sky</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside_veg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside_sun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside_sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside_ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">Least</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lwest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lnorth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lsouth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">ewall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ewall</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Calculations for patches on sky, shmat = 1 = sky is visible</span>
        <span class="n">temp_sky</span> <span class="o">=</span> <span class="p">((</span><span class="n">shmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Longwave radiation from sky to vertical surface</span>
        <span class="n">Ldown_sky</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_down</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Longwave radiation from sky to horizontal surface</span>
        <span class="n">Lside_sky</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_side</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Calculations for patches that are vegetation, vegshmat = 0 = shade from vegetation</span>
        <span class="n">temp_vegsh</span> <span class="o">=</span> <span class="p">((</span><span class="n">vegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vbshvegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Longwave radiation from vegetation surface (considered vertical)</span>
        <span class="n">vegetation_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

        <span class="c1"># Longwave radiation reaching a vertical surface</span>
        <span class="n">Lside_veg</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span>

        <span class="c1"># Longwave radiation reaching a horizontal surface</span>
        <span class="n">Ldown_veg</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span>

        <span class="c1"># Portion into cardinal directions to be used for standing box or POI output</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
            <span class="n">Least</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_side</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="n">Least</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
            <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_side</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
            <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_side</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
            <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">temp_sky</span> <span class="o">*</span> <span class="n">Lsky_side</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">vegetation_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_vegsh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

        <span class="c1"># Calculations for patches that are buildings, shmat = 0 = shade from buildings</span>
        <span class="n">temp_vbsh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">vbshvegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">temp_sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_vbsh</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">azimuth_difference</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">solar_azimuth</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># Longwave radiation from sunlit surfaces</span>
        <span class="n">sunlit_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="n">Tgwall</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="c1"># Longwave radiation from shaded surfaces</span>
        <span class="n">shaded_surface</span> <span class="o">=</span> <span class="p">((</span><span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">azimuth_difference</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth_difference</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">solar_altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="c1"># Calculate which patches defined as buildings that are sunlit or shaded</span>
            <span class="n">sunlit_patches</span><span class="p">,</span> <span class="n">shaded_patches</span> <span class="o">=</span> <span class="n">shaded_or_sunlit</span><span class="p">(</span><span class="n">solar_altitude</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">asvf</span><span class="p">)</span>

            <span class="c1"># Calculate longwave radiation from sunlit walls to vertical surface</span>
            <span class="n">Lside_sun</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>
            <span class="c1"># Calculate longwave radiation from shaded walls to vertical surface</span>
            <span class="n">Lside_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

            <span class="c1"># Calculate longwave radiation from sunlit walls to horizontal surface</span>
            <span class="n">Ldown_sun</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>
            <span class="c1"># Calculate longwave radiation from shaded walls to horizontal surface</span>
            <span class="n">Ldown_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

            <span class="c1"># Portion into cardinal directions to be used for standing box or POI output</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                <span class="n">Least</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="n">Least</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
                <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">sunlit_surface</span> <span class="o">*</span> <span class="n">sunlit_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
                <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">shaded_patches</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate longwave radiation from shaded walls reaching a vertical surface</span>
            <span class="n">Lside_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

            <span class="c1"># Calculate longwave radiation from shaded walls reaching a horizontal surface</span>
            <span class="n">Ldown_sh</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

            <span class="c1"># Portion into cardinal directions to be used for standing box or POI output</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                <span class="n">Least</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
                <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
                <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
                <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">shaded_surface</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

    <span class="c1"># Calculate reflected longwave in each patch</span>
    <span class="n">reflected_on_surfaces</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Ldown_sky</span> <span class="o">+</span> <span class="n">Lup</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">temp_sh</span> <span class="o">=</span> <span class="p">((</span><span class="n">shmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vbshvegshmat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Reflected longwave radiation reaching vertical surfaces</span>
        <span class="n">Lside_ref</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

        <span class="c1"># Reflected longwave radiation reaching horizontal surfaces</span>
        <span class="n">Ldown_ref</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span>

        <span class="c1"># Portion into cardinal directions to be used for standing box or POI output</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
            <span class="n">Least</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">90</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">):</span>
            <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="p">):</span>
            <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">270</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">):</span>
            <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">reflected_on_surfaces</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_sh</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">0</span> <span class="o">-</span> <span class="n">patch_azimuth</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>

    <span class="c1"># Sum of all Lside components (sky, vegetation, sunlit and shaded buildings, reflected)</span>
    <span class="n">Lside</span> <span class="o">=</span> <span class="n">Lside_sky</span> <span class="o">+</span> <span class="n">Lside_veg</span> <span class="o">+</span> <span class="n">Lside_sh</span> <span class="o">+</span> <span class="n">Lside_sun</span> <span class="o">+</span> <span class="n">Lside_ref</span>

    <span class="c1"># Sum of all Ldown components (sky, vegetation, sunlit and shaded buildings, reflected)</span>
    <span class="n">Ldown</span> <span class="o">=</span> <span class="n">Ldown_sky</span> <span class="o">+</span> <span class="n">Ldown_veg</span> <span class="o">+</span> <span class="n">Ldown_sh</span> <span class="o">+</span> <span class="n">Ldown_sun</span> <span class="o">+</span> <span class="n">Ldown_ref</span>


    <span class="k">del</span> <span class="n">Ldown_sky</span> <span class="p">,</span><span class="n">Ldown_veg</span> <span class="p">,</span><span class="n">Ldown_sun</span> <span class="p">,</span><span class="n">Ldown_sh</span> <span class="p">,</span><span class="n">Ldown_ref</span>

    <span class="k">del</span> <span class="n">temp_vegsh</span><span class="p">,</span> <span class="n">vegetation_surface</span><span class="p">,</span> <span class="n">temp_vbsh</span><span class="p">,</span> <span class="n">temp_sh</span>

    <span class="k">return</span> <span class="n">Ldown</span><span class="p">,</span> <span class="n">Lside</span><span class="p">,</span> <span class="n">Lside_sky</span><span class="p">,</span> <span class="n">Lside_veg</span><span class="p">,</span> <span class="n">Lside_sh</span><span class="p">,</span> <span class="n">Lside_sun</span><span class="p">,</span> <span class="n">Lside_ref</span><span class="p">,</span> <span class="n">Least</span><span class="p">,</span> <span class="n">Lwest</span><span class="p">,</span> <span class="n">Lnorth</span><span class="p">,</span> <span class="n">Lsouth</span></div>



<div class="viewcode-block" id="Lcyl_v2022a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Lcyl_v2022a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Lcyl_v2022a</span><span class="p">(</span><span class="n">esky</span><span class="p">,</span> <span class="n">sky_patches</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">Lup</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">,</span> <span class="n">solar_altitude</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">asvf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate longwave radiation on cylindrical surface (human body model).</span>
<span class="sd">    </span>
<span class="sd">    Computes longwave radiation received by a standing person from sky,</span>
<span class="sd">    ground, and wall surfaces, accounting for shadows and anisotropic effects.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        esky (float): Sky emissivity</span>
<span class="sd">        sky_patches (torch.Tensor): Sky hemisphere discretization</span>
<span class="sd">        Ta (float): Air temperature (Â°C)</span>
<span class="sd">        Tgwall (torch.Tensor): Wall/ground temperature (K)</span>
<span class="sd">        ewall (float): Wall emissivity</span>
<span class="sd">        Lup (torch.Tensor): Upward longwave radiation</span>
<span class="sd">        shmat, vegshmat, vbshvegshmat (torch.Tensor): Shadow matrices</span>
<span class="sd">        solar_altitude, solar_azimuth (float): Solar angles</span>
<span class="sd">        rows, cols (int): Grid dimensions</span>
<span class="sd">        asvf (torch.Tensor): Anisotropic SVF</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Lsky, Lrefl) - Sky and reflected longwave components</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Device for GPU computation</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># Stefan-Boltzmann&#39;s Constant</span>
    <span class="n">SBC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">5.67051e-8</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="c1"># Sky longwave radiation from emissivity based on Prata (1996)</span>
    <span class="n">Ldown_prata</span> <span class="o">=</span> <span class="p">(</span><span class="n">esky</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Degrees to radians</span>
    <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="c1"># Unique altitudes for patches</span>
    <span class="n">sky_patches_cpu</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">skyalt</span><span class="p">,</span> <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sky_patches_cpu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">skyalt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">skyalt</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">skyalt_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">skyalt_c</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="c1"># Altitudes and azimuths of the Robinson &amp; Stone patches</span>
    <span class="n">patch_altitude</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">patch_azimuth</span> <span class="o">=</span> <span class="n">sky_patches</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">emis_m</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Unsworth &amp; Monteith (1975)</span>
    <span class="k">if</span> <span class="n">emis_m</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span> <span class="o">=</span> <span class="n">model1</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">)</span>
    <span class="c1"># Martin &amp; Berdahl (1984)</span>
    <span class="k">elif</span> <span class="n">emis_m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span> <span class="o">=</span> <span class="n">model2</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">)</span>
    <span class="c1"># Bliss (1961)</span>
    <span class="k">elif</span> <span class="n">emis_m</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">patch_emissivity_normalized</span><span class="p">,</span> <span class="n">esky_band</span> <span class="o">=</span> <span class="n">model3</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">Ta</span><span class="p">)</span>

    <span class="c1"># Calculation of steradian for each patch</span>
    <span class="n">steradian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># If there are more than one patch in a band</span>
        <span class="k">if</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">steradian</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">360</span> <span class="o">/</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> \
            <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span>
        <span class="c1"># If there is only one patch in band, i.e. 90 degrees</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steradian</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">360</span> <span class="o">/</span> <span class="n">skyalt_c</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">patch_altitude</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">patch_altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span>

    <span class="c1"># True = anisotropic sky, False = isotropic sky</span>
    <span class="n">anisotropic_sky</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Longwave based on spectral flux density (divide by pi)</span>
    <span class="n">Ldown</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lside</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">Lnormal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">patch_altitude</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">altitude</span> <span class="ow">in</span> <span class="n">skyalt</span><span class="p">:</span>
        <span class="c1"># Anisotropic sky</span>
        <span class="k">if</span> <span class="n">anisotropic_sky</span><span class="p">:</span>
            <span class="n">temp_emissivity</span> <span class="o">=</span> <span class="n">esky_band</span><span class="p">[</span><span class="n">skyalt</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span>
        <span class="c1"># Isotropic sky but with patches (need to switch anisotropic_sky to False)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_emissivity</span> <span class="o">=</span> <span class="n">esky</span>
        <span class="c1"># Estimate longwave radiation on a horizontal surface (Ldown), vertical surface (Lside) and perpendicular (Lnormal)</span>
        <span class="n">Ldown</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp_emissivity</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="n">Lside</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp_emissivity</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">)</span>
        <span class="n">Lnormal</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp_emissivity</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span> <span class="o">*</span> <span class="n">steradian</span><span class="p">[</span><span class="n">patch_altitude</span> <span class="o">==</span> <span class="n">altitude</span><span class="p">]</span>

    <span class="n">Lsky_normal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">)</span>
    <span class="n">Lsky_down</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">)</span>
    <span class="n">Lsky_side</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">sky_patches</span><span class="p">)</span>

    <span class="n">Lsky_normal</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lnormal</span>
    <span class="n">Lsky_down</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ldown</span>
    <span class="n">Lsky_side</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lside</span>

    <span class="c1"># Estimate longwave radiation in each patch based on patch characteristics, i.e. sky, vegetation or building (shaded or sunlit)</span>
    <span class="n">Ldown</span><span class="p">,</span> <span class="n">Lside</span><span class="p">,</span> <span class="n">Lside_sky</span><span class="p">,</span> <span class="n">Lside_veg</span><span class="p">,</span> <span class="n">Lside_sh</span><span class="p">,</span> <span class="n">Lside_sun</span><span class="p">,</span> <span class="n">Lside_ref</span><span class="p">,</span> \
            <span class="n">Least_</span><span class="p">,</span> <span class="n">Lwest_</span><span class="p">,</span> <span class="n">Lnorth_</span><span class="p">,</span> <span class="n">Lsouth_</span> <span class="o">=</span> <span class="n">define_patch_characteristics</span><span class="p">(</span><span class="n">solar_altitude</span><span class="p">,</span> <span class="n">solar_azimuth</span><span class="p">,</span>
                                 <span class="n">patch_altitude</span><span class="p">,</span> <span class="n">patch_azimuth</span><span class="p">,</span> <span class="n">steradian</span><span class="p">,</span>
                                 <span class="n">asvf</span><span class="p">,</span>
                                 <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">,</span>
                                 <span class="n">Lsky_down</span><span class="p">,</span> <span class="n">Lsky_side</span><span class="p">,</span> <span class="n">Lsky_normal</span><span class="p">,</span> <span class="n">Lup</span><span class="p">,</span>
                                 <span class="n">Ta</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span>
                                 <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">Lnormal</span><span class="p">,</span> <span class="n">Lsky_normal</span><span class="p">,</span> <span class="n">Lsky_down</span><span class="p">,</span> <span class="n">Lsky_side</span>

    <span class="k">return</span> <span class="n">Ldown</span><span class="p">,</span> <span class="n">Lside</span><span class="p">,</span> <span class="n">Least_</span><span class="p">,</span> <span class="n">Lwest_</span><span class="p">,</span> <span class="n">Lnorth_</span><span class="p">,</span> <span class="n">Lsouth_</span></div>


<div class="viewcode-block" id="Lvikt_veg">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Lvikt_veg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Lvikt_veg</span><span class="p">(</span><span class="n">svf</span><span class="p">,</span> <span class="n">svfveg</span><span class="p">,</span> <span class="n">svfaveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate longwave radiation weight factors accounting for vegetation.&quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">viktonlywall</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svf</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svf</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktaveg</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svfaveg</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svfaveg</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svfaveg</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svfaveg</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svfaveg</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svfaveg</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktwall</span> <span class="o">=</span> <span class="n">viktonlywall</span> <span class="o">-</span> <span class="n">viktaveg</span>
    <span class="n">svfvegbu</span> <span class="o">=</span> <span class="p">(</span><span class="n">svfveg</span> <span class="o">+</span> <span class="n">svf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Vegetation plus buildings</span>
    <span class="n">viktsky</span> <span class="o">=</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svfvegbu</span><span class="p">)</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktrefl</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svfvegbu</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktveg</span> <span class="o">=</span> <span class="p">(</span><span class="n">vikttot</span> <span class="o">-</span> <span class="p">(</span><span class="mf">63.227</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">-</span> <span class="mf">161.51</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">156.91</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">70.424</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">16.773</span> <span class="o">*</span> <span class="n">svfvegbu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.4863</span> <span class="o">*</span> <span class="n">svfvegbu</span><span class="p">))</span> <span class="o">/</span> <span class="n">vikttot</span>
    <span class="n">viktveg</span> <span class="o">=</span> <span class="n">viktveg</span> <span class="o">-</span> <span class="n">viktwall</span>

    <span class="k">del</span> <span class="n">viktonlywall</span><span class="p">,</span><span class="n">viktaveg</span><span class="p">,</span><span class="n">svfvegbu</span>

    <span class="k">return</span> <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span></div>



<div class="viewcode-block" id="Lside_veg_v2022a">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Lside_veg_v2022a">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Lside_veg_v2022a</span><span class="p">(</span><span class="n">svfS</span><span class="p">,</span> <span class="n">svfW</span><span class="p">,</span> <span class="n">svfN</span><span class="p">,</span> <span class="n">svfE</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span> <span class="n">svfEaveg</span><span class="p">,</span> <span class="n">svfSaveg</span><span class="p">,</span> <span class="n">svfWaveg</span><span class="p">,</span> <span class="n">svfNaveg</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">Tw</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">Ldown</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">LupE</span><span class="p">,</span> <span class="n">LupS</span><span class="p">,</span> <span class="n">LupW</span><span class="p">,</span> <span class="n">LupN</span><span class="p">,</span> <span class="n">anisotropic_longwave</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate longwave radiation on vertical surfaces (walls) with vegetation effects.</span>
<span class="sd">    </span>
<span class="sd">    Computes longwave radiation received by walls in the four cardinal directions,</span>
<span class="sd">    accounting for sky emission, ground emission, wall-to-wall exchanges, and</span>
<span class="sd">    vegetation obstruction.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        svfS, svfW, svfN, svfE (torch.Tensor): Directional sky view factors</span>
<span class="sd">        svf*veg (torch.Tensor): Vegetation-obstructed SVFs</span>
<span class="sd">        svf*aveg (torch.Tensor): Vegetation-above SVFs</span>
<span class="sd">        azimuth, altitude (float): Solar angles (degrees)</span>
<span class="sd">        Ta (float): Air temperature (Â°C)</span>
<span class="sd">        Tw (torch.Tensor): Wall temperature</span>
<span class="sd">        SBC (float): Stefan-Boltzmann constant</span>
<span class="sd">        ewall (float): Wall emissivity</span>
<span class="sd">        Ldown (torch.Tensor): Downward longwave</span>
<span class="sd">        esky (float): Sky emissivity</span>
<span class="sd">        t (float): Time parameter</span>
<span class="sd">        F_sh (torch.Tensor): Shadow factor</span>
<span class="sd">        CI (torch.Tensor): Clearness index</span>
<span class="sd">        LupE, LupS, LupW, LupN (torch.Tensor): Upward longwave per direction</span>
<span class="sd">        anisotropic_longwave (bool): Use anisotropic model</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Ldown, Lside, Least, Lwest, Lnorth, Lsouth) - Longwave components</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ewall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ewall</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">anisotropic_longwave</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">anisotropic_longwave</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Building height angle from svf</span>
    <span class="n">svfalfaE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfE</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">svfalfaS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfS</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">svfalfaW</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfW</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">svfalfaN</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfN</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">vikttot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">4.4897</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">aziW</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziN</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">90</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziE</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">t</span>
    <span class="n">aziS</span> <span class="o">=</span> <span class="n">azimuth</span> <span class="o">-</span> <span class="mi">270</span> <span class="o">+</span> <span class="n">t</span>

    <span class="n">F_sh</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">F_sh</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># (cylindric_wedge scaled 0-1)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">CI</span>
    <span class="n">Lsky_allsky</span> <span class="o">=</span> <span class="n">esky</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1">## Least</span>
    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span> <span class="o">=</span> <span class="n">Lvikt_veg</span><span class="p">(</span><span class="n">svfE</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfEaveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># daytime</span>
        <span class="n">alfaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">svfalfaE</span><span class="p">)</span>
        <span class="n">betaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">svfalfaE</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span>
        <span class="n">betasun</span> <span class="o">=</span> <span class="p">((</span><span class="n">alfaB</span> <span class="o">-</span> <span class="n">betaB</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaB</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tw</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziE</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">betasun</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="n">F_sh</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># nighttime</span>
        <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="c1"># Longwave from ground (see Lcyl_v2022a for remaining fluxes)</span>
    <span class="k">if</span> <span class="n">anisotropic_longwave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupE</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Least</span> <span class="o">=</span> <span class="n">Lground</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Lsky</span> <span class="o">=</span> <span class="p">((</span><span class="n">svfE</span> <span class="o">+</span> <span class="n">svfEveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Lsky_allsky</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktsky</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lveg</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktveg</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupE</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lrefl</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">LupE</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">viktrefl</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Least</span> <span class="o">=</span> <span class="n">Lsky</span> <span class="o">+</span> <span class="n">Lwallsun</span> <span class="o">+</span> <span class="n">Lwallsh</span> <span class="o">+</span> <span class="n">Lveg</span> <span class="o">+</span> <span class="n">Lground</span> <span class="o">+</span> <span class="n">Lrefl</span>

    <span class="c1">## Lsouth</span>
    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span> <span class="o">=</span> <span class="n">Lvikt_veg</span><span class="p">(</span><span class="n">svfS</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">svfSaveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># daytime</span>
        <span class="n">alfaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">svfalfaS</span><span class="p">)</span>
        <span class="n">betaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">svfalfaS</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span>
        <span class="n">betasun</span> <span class="o">=</span> <span class="p">((</span><span class="n">alfaB</span> <span class="o">-</span> <span class="n">betaB</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaB</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">270</span> <span class="o">-</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tw</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziS</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">betasun</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="n">F_sh</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># nighttime</span>
        <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">anisotropic_longwave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupS</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lsouth</span> <span class="o">=</span> <span class="n">Lground</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Lsky</span> <span class="o">=</span> <span class="p">((</span><span class="n">svfS</span> <span class="o">+</span> <span class="n">svfSveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Lsky_allsky</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktsky</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lveg</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktveg</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupS</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lrefl</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">LupS</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">viktrefl</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lsouth</span> <span class="o">=</span> <span class="n">Lsky</span> <span class="o">+</span> <span class="n">Lwallsun</span> <span class="o">+</span> <span class="n">Lwallsh</span> <span class="o">+</span> <span class="n">Lveg</span> <span class="o">+</span> <span class="n">Lground</span> <span class="o">+</span> <span class="n">Lrefl</span>

    <span class="c1">## Lwest</span>
    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span> <span class="o">=</span> <span class="n">Lvikt_veg</span><span class="p">(</span><span class="n">svfW</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfWaveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># daytime</span>
        <span class="n">alfaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">svfalfaW</span><span class="p">)</span>
        <span class="n">betaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">svfalfaW</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span>
        <span class="n">betasun</span> <span class="o">=</span> <span class="p">((</span><span class="n">alfaB</span> <span class="o">-</span> <span class="n">betaB</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaB</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">180</span> <span class="o">-</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tw</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziW</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">betasun</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="n">F_sh</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># nighttime</span>
        <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">anisotropic_longwave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupW</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lwest</span> <span class="o">=</span> <span class="n">Lground</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Lsky</span> <span class="o">=</span> <span class="p">((</span><span class="n">svfW</span> <span class="o">+</span> <span class="n">svfWveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Lsky_allsky</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktsky</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lveg</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktveg</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupW</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lrefl</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">LupW</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">viktrefl</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lwest</span> <span class="o">=</span> <span class="n">Lsky</span> <span class="o">+</span> <span class="n">Lwallsun</span> <span class="o">+</span> <span class="n">Lwallsh</span> <span class="o">+</span> <span class="n">Lveg</span> <span class="o">+</span> <span class="n">Lground</span> <span class="o">+</span> <span class="n">Lrefl</span>

    <span class="c1">## Lnorth</span>
    <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span> <span class="o">=</span> <span class="n">Lvikt_veg</span><span class="p">(</span><span class="n">svfN</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span> <span class="n">svfNaveg</span><span class="p">,</span> <span class="n">vikttot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># daytime</span>
        <span class="n">alfaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">svfalfaN</span><span class="p">)</span>
        <span class="n">betaB</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">svfalfaN</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">))</span>
        <span class="n">betasun</span> <span class="o">=</span> <span class="p">((</span><span class="n">alfaB</span> <span class="o">-</span> <span class="n">betaB</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">betaB</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">azimuth</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">270</span> <span class="o">-</span> <span class="n">t</span><span class="p">)):</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tw</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aziN</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">betasun</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="n">F_sh</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># nighttime</span>
        <span class="n">Lwallsun</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Lwallsh</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktwall</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">anisotropic_longwave</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupN</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lnorth</span> <span class="o">=</span> <span class="n">Lground</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Lsky</span> <span class="o">=</span> <span class="p">((</span><span class="n">svfN</span> <span class="o">+</span> <span class="n">svfNveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Lsky_allsky</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktsky</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lveg</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">viktveg</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lground</span> <span class="o">=</span> <span class="n">LupN</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lrefl</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">LupN</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">viktrefl</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">Lnorth</span> <span class="o">=</span> <span class="n">Lsky</span> <span class="o">+</span> <span class="n">Lwallsun</span> <span class="o">+</span> <span class="n">Lwallsh</span> <span class="o">+</span> <span class="n">Lveg</span> <span class="o">+</span> <span class="n">Lground</span> <span class="o">+</span> <span class="n">Lrefl</span>

    <span class="k">del</span> <span class="n">LupE</span><span class="p">,</span><span class="n">LupS</span><span class="p">,</span><span class="n">LupW</span><span class="p">,</span><span class="n">LupN</span><span class="p">,</span><span class="n">svfalfaE</span><span class="p">,</span><span class="n">svfalfaS</span><span class="p">,</span><span class="n">svfalfaW</span><span class="p">,</span><span class="n">svfalfaN</span>

    <span class="k">del</span> <span class="n">viktveg</span><span class="p">,</span> <span class="n">viktwall</span><span class="p">,</span> <span class="n">viktsky</span><span class="p">,</span> <span class="n">viktrefl</span>

    <span class="k">return</span> <span class="n">Least</span><span class="p">,</span> <span class="n">Lsouth</span><span class="p">,</span> <span class="n">Lwest</span><span class="p">,</span> <span class="n">Lnorth</span></div>



<div class="viewcode-block" id="Solweig_2022a_calc">
<a class="viewcode-back" href="../../api.html#solweig_gpu.solweig.Solweig_2022a_calc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Solweig_2022a_calc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dsm</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">svf</span><span class="p">,</span> <span class="n">svfN</span><span class="p">,</span> <span class="n">svfW</span><span class="p">,</span> <span class="n">svfE</span><span class="p">,</span> <span class="n">svfS</span><span class="p">,</span> <span class="n">svfveg</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span>
                       <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfaveg</span><span class="p">,</span> <span class="n">svfEaveg</span><span class="p">,</span> <span class="n">svfSaveg</span><span class="p">,</span> <span class="n">svfWaveg</span><span class="p">,</span> <span class="n">svfNaveg</span><span class="p">,</span> <span class="n">vegdem</span><span class="p">,</span> <span class="n">vegdem2</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">absK</span><span class="p">,</span> <span class="n">absL</span><span class="p">,</span>
                       <span class="n">ewall</span><span class="p">,</span> <span class="n">Fside</span><span class="p">,</span> <span class="n">Fup</span><span class="p">,</span> <span class="n">Fcyl</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">zen</span><span class="p">,</span> <span class="n">jday</span><span class="p">,</span> <span class="n">usevegdem</span><span class="p">,</span> <span class="n">onlyglobal</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span>
                       <span class="n">landcover</span><span class="p">,</span> <span class="n">lc_grid</span><span class="p">,</span> <span class="n">dectime</span><span class="p">,</span> <span class="n">altmax</span><span class="p">,</span> <span class="n">dirwalls</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">elvis</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">RH</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radI</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span>
                       <span class="n">amaxvalue</span><span class="p">,</span> <span class="n">bush</span><span class="p">,</span> <span class="n">Twater</span><span class="p">,</span> <span class="n">TgK</span><span class="p">,</span> <span class="n">Tstart</span><span class="p">,</span> <span class="n">alb_grid</span><span class="p">,</span> <span class="n">emis_grid</span><span class="p">,</span> <span class="n">TgK_wall</span><span class="p">,</span> <span class="n">Tstart_wall</span><span class="p">,</span> <span class="n">TmaxLST</span><span class="p">,</span>
                       <span class="n">TmaxLST_wall</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">svfalfa</span><span class="p">,</span> <span class="n">svfbuveg</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1</span><span class="p">,</span>
                       <span class="n">Tgmap1E</span><span class="p">,</span> <span class="n">Tgmap1S</span><span class="p">,</span> <span class="n">Tgmap1W</span><span class="p">,</span> <span class="n">Tgmap1N</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">TgOut1</span><span class="p">,</span> <span class="n">diffsh</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">,</span> <span class="n">anisotropic_sky</span><span class="p">,</span> <span class="n">asvf</span><span class="p">,</span> <span class="n">patch_option</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main SOLWEIG 2022a calculation kernel - integrates all radiation and temperature calculations.</span>
<span class="sd">    </span>
<span class="sd">    This is the core GPU-accelerated function that computes:</span>
<span class="sd">    - Shortwave radiation (direct, diffuse, reflected)</span>
<span class="sd">    - Longwave radiation (sky, ground, wall emissions)</span>
<span class="sd">    - Surface energy balance</span>
<span class="sd">    - Ground and wall surface temperatures</span>
<span class="sd">    - Mean radiant temperature (Tmrt)</span>
<span class="sd">    </span>
<span class="sd">    This function is called once per time step and performs the complete</span>
<span class="sd">    radiation budget calculation accounting for 3D urban geometry, vegetation,</span>
<span class="sd">    and surface-atmosphere interactions.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        i (int): Time step index</span>
<span class="sd">        dsm (torch.Tensor): Digital Surface Model</span>
<span class="sd">        scale (float): Grid resolution (pixels/meter)</span>
<span class="sd">        rows, cols (int): Domain dimensions</span>
<span class="sd">        svf* (torch.Tensor): Sky view factors (multiple directional variants)</span>
<span class="sd">        vegdem, vegdem2, bush (torch.Tensor): Vegetation layers</span>
<span class="sd">        albedo_b, absK, absL, ewall (float): Surface optical/thermal properties</span>
<span class="sd">        Fside, Fup, Fcyl (torch.Tensor): Form factors for different geometries</span>
<span class="sd">        altitude, azimuth, zen (torch.Tensor): Solar geometry</span>
<span class="sd">        jday, dectime, altmax (torch.Tensor): Temporal parameters</span>
<span class="sd">        usevegdem, onlyglobal (bool): Model configuration flags</span>
<span class="sd">        buildings (torch.Tensor): Building footprint mask</span>
<span class="sd">        location (dict): Geographic coordinates</span>
<span class="sd">        psi (torch.Tensor): Tilt angles</span>
<span class="sd">        landcover, lc_grid: Land cover classification</span>
<span class="sd">        dirwalls, walls, cyl (torch.Tensor): Wall geometry</span>
<span class="sd">        elvis (np.ndarray): Elevation data</span>
<span class="sd">        Ta, RH, P (float): Meteorological conditions (air temp, humidity, pressure)</span>
<span class="sd">        radG, radD, radI (float): Incoming radiation components (global, diffuse, direct)</span>
<span class="sd">        amaxvalue (float): Maximum domain elevation</span>
<span class="sd">        Twater (float): Water surface temperature</span>
<span class="sd">        TgK, Tstart, TgK_wall, Tstart_wall (torch.Tensor): Temperature states</span>
<span class="sd">        TmaxLST, TmaxLST_wall (torch.Tensor): Maximum temperatures</span>
<span class="sd">        alb_grid, emis_grid (torch.Tensor): Spatial albedo and emissivity</span>
<span class="sd">        first, second (torch.Tensor): Surface type classifications</span>
<span class="sd">        svfalfa, svfbuveg (torch.Tensor): Vegetation view factors</span>
<span class="sd">        firstdaytime, timeadd, timestepdec (float): Temporal parameters</span>
<span class="sd">        Tgmap1, Tgmap1E, Tgmap1S, Tgmap1W, Tgmap1N (torch.Tensor): Previous temperature maps</span>
<span class="sd">        CI, TgOut1 (torch.Tensor): Clearness index and output temperature</span>
<span class="sd">        diffsh, shmat, vegshmat, vbshvegshmat (torch.Tensor): Shadow matrices</span>
<span class="sd">        anisotropic_sky (bool): Use anisotropic sky model</span>
<span class="sd">        asvf (torch.Tensor): Anisotropic SVF</span>
<span class="sd">        patch_option (int): Sky discretization option</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (KsideI, TgOut1, TgOut, radIout, radDout, Lside, Lsky_patch, CI_Tg, CI_TgG, </span>
<span class="sd">                KsideD, dRad, Kside) - Comprehensive radiation and temperature outputs</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - GPU-accelerated for performance</span>
<span class="sd">        - Most computationally intensive function in SOLWEIG</span>
<span class="sd">        - Implements surface energy balance with iteration</span>
<span class="sd">        - Accounts for multiple reflections and anisotropic effects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

    <span class="c1"># Convert input data to torch tensors</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">zen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">zen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="c1">#lc_grid = torch.tensor(lc_grid, device=device).clone().detach()</span>
    <span class="n">dectime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dectime</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">altmax</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altmax</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">Twater</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Twater</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="c1">#TgK_wall = torch.tensor(TgK_wall, device=device).clone().detach()</span>
    <span class="c1">#Tstart_wall = torch.tensor(Tstart_wall, device=device).clone().detach()</span>
    <span class="c1">#TmaxLST = torch.tensor(TmaxLST, device=device).clone().detach()</span>
    <span class="c1">#TmaxLST_wall = torch.tensor(TmaxLST_wall, device=device).clone().detach()</span>

    <span class="c1"># Stefan Bolzmans Constant</span>
    <span class="n">SBC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">5.67051e-8</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="c1"># Find sunrise decimal hour - new from 2014a</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">SNUP</span> <span class="o">=</span> <span class="n">daylen</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">jday</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]))</span>

    <span class="c1"># Vapor pressure</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="mf">6.107</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">((</span><span class="mf">7.5</span> <span class="o">*</span> <span class="n">Ta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">237.3</span> <span class="o">+</span> <span class="n">Ta</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">RH</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span>

    <span class="c1"># Determination of clear - sky emissivity from Prata (1996)</span>
    <span class="n">msteg</span> <span class="o">=</span> <span class="mf">46.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ea</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">))</span>
    <span class="n">esky</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">msteg</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="mf">1.2</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">msteg</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="o">+</span> <span class="n">elvis</span>  <span class="c1"># -0.04 old error from Jonsson et al.2006</span>

    <span class="k">if</span> <span class="n">altitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># # # # # # DAYTIME # # # # # #</span>
        <span class="c1"># Clearness Index on Earth&#39;s surface after Crawford and Dunchon (1999) with a correction</span>
        <span class="c1">#  factor for low sun elevations after Lindberg et al.(2008)</span>
        <span class="n">I0</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">Kt</span><span class="p">,</span> <span class="n">I0et</span><span class="p">,</span> <span class="n">CIuncorr</span> <span class="o">=</span> <span class="n">clearnessindex_2013b</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">zen</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">jday</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Ta</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">RH</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">radG</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">location</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
        <span class="n">CI</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Estimation of radD and radI if not measured after Reindl et al.(1990)</span>
        <span class="k">if</span> <span class="n">onlyglobal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">I0</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">Kt</span><span class="p">,</span> <span class="n">I0et</span><span class="p">,</span> <span class="n">CIuncorr</span> <span class="o">=</span> <span class="n">clearnessindex_2013b</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">zen</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">jday</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">Ta</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">RH</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">radG</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">location</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
            <span class="n">CI</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CI</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="n">radI</span><span class="p">,</span> <span class="n">radD</span> <span class="o">=</span> <span class="n">diffusefraction</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">radG</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">Kt</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Ta</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">RH</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>

        <span class="c1"># Diffuse Radiation</span>
        <span class="c1"># Anisotropic Diffuse Radiation after Perez et al. 1993</span>
        <span class="k">if</span> <span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">patchchoice</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zenDeg</span> <span class="o">=</span> <span class="n">zen</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="c1"># Relative luminance</span>
            <span class="n">lv</span><span class="p">,</span> <span class="n">pc_</span><span class="p">,</span> <span class="n">pb_</span> <span class="o">=</span> <span class="n">Perez_v3</span><span class="p">(</span><span class="n">zenDeg</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radI</span><span class="p">,</span> <span class="n">jday</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">patchchoice</span><span class="p">,</span> <span class="n">patch_option</span><span class="p">)</span>
            <span class="c1"># Total relative luminance from sky, i.e. from each patch, into each cell</span>
            <span class="n">aniLum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">aniLum</span> <span class="o">+=</span> <span class="n">diffsh</span><span class="p">[:,:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">lv</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">dRad</span> <span class="o">=</span> <span class="n">aniLum</span> <span class="o">*</span> <span class="n">radD</span>   <span class="c1"># Total diffuse radiation from sky into each cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dRad</span> <span class="o">=</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">svfbuveg</span>
            <span class="n">patchchoice</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Shadow  images</span>
        <span class="k">if</span> <span class="n">usevegdem</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vegsh</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">wallsh</span><span class="p">,</span> <span class="n">wallsun</span><span class="p">,</span> <span class="n">wallshve</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">facesun</span> <span class="o">=</span> <span class="n">shadowingfunction_wallheight_23</span><span class="p">(</span><span class="n">dsm</span><span class="p">,</span> <span class="n">vegdem</span><span class="p">,</span> <span class="n">vegdem2</span><span class="p">,</span>
                                        <span class="n">azimuth</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">scale</span><span class="p">,</span> <span class="n">amaxvalue</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">bush</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">dirwalls</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="n">shadow</span> <span class="o">=</span> <span class="n">sh</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vegsh</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">psi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sh</span><span class="p">,</span> <span class="n">wallsh</span><span class="p">,</span> <span class="n">wallsun</span><span class="p">,</span> <span class="n">facesh</span><span class="p">,</span> <span class="n">facesun</span> <span class="o">=</span> <span class="n">shadowingfunction_wallheight_13</span><span class="p">(</span><span class="n">dsm</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">scale</span><span class="p">,</span>
                                                                                   <span class="n">walls</span><span class="p">,</span> <span class="n">dirwalls</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="n">shadow</span> <span class="o">=</span> <span class="n">sh</span>

        <span class="c1"># # # Surface temperature parameterisation during daytime # # # #</span>
        <span class="n">Tgamp</span> <span class="o">=</span> <span class="n">TgK</span> <span class="o">*</span> <span class="n">altmax</span> <span class="o">+</span> <span class="n">Tstart</span> <span class="c1"># Fixed 2021</span>
        <span class="n">Tgampwall</span> <span class="o">=</span> <span class="n">TgK_wall</span> <span class="o">*</span> <span class="n">altmax</span> <span class="o">+</span> <span class="n">Tstart_wall</span>
        <span class="n">Tg</span> <span class="o">=</span> <span class="n">Tgamp</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((((</span><span class="n">dectime</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dectime</span><span class="p">))</span> <span class="o">-</span> <span class="n">SNUP</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">TmaxLST</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">SNUP</span> <span class="o">/</span> <span class="mi">24</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2015 a, based on max sun altitude</span>
        <span class="n">Tgwall</span> <span class="o">=</span> <span class="n">Tgampwall</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">((((</span><span class="n">dectime</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dectime</span><span class="p">))</span> <span class="o">-</span> <span class="n">SNUP</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">TmaxLST_wall</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">SNUP</span> <span class="o">/</span> <span class="mi">24</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2015a, based on max sun altitude</span>

        <span class="n">Tgwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Tgwall</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

        <span class="n">radI0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">diffusefraction</span><span class="p">(</span><span class="n">I0</span><span class="p">,</span> <span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">Ta</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">RH</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="mf">0.1473</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="p">(</span><span class="n">zen</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.3454</span>  <span class="c1"># 20070329 correction of lat, Lindberg et al. 2008</span>
        <span class="n">CI_Tg</span> <span class="o">=</span> <span class="p">(</span><span class="n">radG</span> <span class="o">/</span> <span class="n">radI0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span><span class="p">)</span>
        <span class="n">CI_Tg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CI_Tg</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">deg2rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
        <span class="n">radG0</span> <span class="o">=</span> <span class="n">radI0</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="n">deg2rad</span><span class="p">))</span> <span class="o">+</span> <span class="n">_</span>
        <span class="n">CI_TgG</span> <span class="o">=</span> <span class="p">(</span><span class="n">radG</span> <span class="o">/</span> <span class="n">radG0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span><span class="p">)</span>
        <span class="n">CI_TgG</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CI_TgG</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">Tg</span> <span class="o">=</span> <span class="n">Tg</span> <span class="o">*</span> <span class="n">CI_TgG</span>  <span class="c1"># new estimation</span>
        <span class="n">Tgwall</span> <span class="o">=</span> <span class="n">Tgwall</span> <span class="o">*</span> <span class="n">CI_TgG</span>
        <span class="k">if</span> <span class="n">landcover</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Tg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Tg</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>  <span class="c1"># temporary for removing low Tg during morning 20130205</span>

        <span class="c1"># # # # Ground View Factors # # # #</span>
        <span class="n">gvfLup</span><span class="p">,</span> <span class="n">gvfalb</span><span class="p">,</span> <span class="n">gvfalbnosh</span><span class="p">,</span> <span class="n">gvfLupE</span><span class="p">,</span> <span class="n">gvfalbE</span><span class="p">,</span> <span class="n">gvfalbnoshE</span><span class="p">,</span> <span class="n">gvfLupS</span><span class="p">,</span> <span class="n">gvfalbS</span><span class="p">,</span> <span class="n">gvfalbnoshS</span><span class="p">,</span> <span class="n">gvfLupW</span><span class="p">,</span> <span class="n">gvfalbW</span><span class="p">,</span>\
        <span class="n">gvfalbnoshW</span><span class="p">,</span> <span class="n">gvfLupN</span><span class="p">,</span> <span class="n">gvfalbN</span><span class="p">,</span> <span class="n">gvfalbnoshN</span><span class="p">,</span> <span class="n">gvfSum</span><span class="p">,</span> <span class="n">gvfNorm</span> <span class="o">=</span> <span class="n">gvf_2018a</span><span class="p">(</span><span class="n">wallsun</span><span class="p">,</span> <span class="n">walls</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span>
                <span class="n">second</span><span class="p">,</span> <span class="n">dirwalls</span><span class="p">,</span> <span class="n">Tg</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">emis_grid</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">alb_grid</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span>
                                                                 <span class="n">Twater</span><span class="p">,</span> <span class="n">lc_grid</span><span class="p">,</span> <span class="n">landcover</span><span class="p">)</span>

        <span class="c1"># # # # Lup, daytime # # # #</span>
        <span class="n">Lup</span><span class="p">,</span> <span class="n">timeaddnotused</span><span class="p">,</span> <span class="n">Tgmap1</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLup</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1</span><span class="p">)</span>
        <span class="n">LupE</span><span class="p">,</span> <span class="n">timeaddnotused</span><span class="p">,</span> <span class="n">Tgmap1E</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLupE</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1E</span><span class="p">)</span>
        <span class="n">LupS</span><span class="p">,</span> <span class="n">timeaddnotused</span><span class="p">,</span> <span class="n">Tgmap1S</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLupS</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1S</span><span class="p">)</span>
        <span class="n">LupW</span><span class="p">,</span> <span class="n">timeaddnotused</span><span class="p">,</span> <span class="n">Tgmap1W</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLupW</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1W</span><span class="p">)</span>
        <span class="n">LupN</span><span class="p">,</span> <span class="n">timeaddnotused</span><span class="p">,</span> <span class="n">Tgmap1N</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">gvfLupN</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">Tgmap1N</span><span class="p">)</span>

        <span class="c1"># # For Tg output in POIs</span>
        <span class="n">TgTemp</span> <span class="o">=</span> <span class="n">Tg</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">+</span> <span class="n">Ta</span>
        <span class="n">TgOut</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">TgOut1</span> <span class="o">=</span> <span class="n">TsWaveDelay_2015a</span><span class="p">(</span><span class="n">TgTemp</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timeadd</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> <span class="n">TgOut1</span><span class="p">)</span> <span class="c1">#timeadd only here v2021a</span>

        <span class="c1"># Building height angle from svf</span>
        <span class="n">F_sh</span> <span class="o">=</span> <span class="n">cylindric_wedge</span><span class="p">(</span><span class="n">zen</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">svfalfa</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>  <span class="c1"># Fraction shadow on building walls based on sun alt and svf</span>
        <span class="n">F_sh</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">F_sh</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># # # # # # # Calculation of shortwave daytime radiative fluxes # # # # # # #</span>
        <span class="n">Kdown</span> <span class="o">=</span> <span class="n">radI</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">altitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span> <span class="o">+</span> <span class="n">dRad</span> <span class="o">+</span> <span class="n">albedo_b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">svfbuveg</span><span class="p">)</span> <span class="o">*</span> \
                            <span class="p">(</span><span class="n">radG</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">radD</span> <span class="o">*</span> <span class="n">F_sh</span><span class="p">)</span>

        <span class="n">Kup</span><span class="p">,</span> <span class="n">KupE</span><span class="p">,</span> <span class="n">KupS</span><span class="p">,</span> <span class="n">KupW</span><span class="p">,</span> <span class="n">KupN</span> <span class="o">=</span> <span class="n">Kup_veg_2015a</span><span class="p">(</span><span class="n">radI</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">svfbuveg</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">gvfalb</span><span class="p">,</span>
                    <span class="n">gvfalbE</span><span class="p">,</span> <span class="n">gvfalbS</span><span class="p">,</span> <span class="n">gvfalbW</span><span class="p">,</span> <span class="n">gvfalbN</span><span class="p">,</span> <span class="n">gvfalbnosh</span><span class="p">,</span> <span class="n">gvfalbnoshE</span><span class="p">,</span> <span class="n">gvfalbnoshS</span><span class="p">,</span> <span class="n">gvfalbnoshW</span><span class="p">,</span> <span class="n">gvfalbnoshN</span><span class="p">)</span>

        <span class="n">Keast</span><span class="p">,</span> <span class="n">Ksouth</span><span class="p">,</span> <span class="n">Kwest</span><span class="p">,</span> <span class="n">Knorth</span><span class="p">,</span> <span class="n">KsideI</span><span class="p">,</span> <span class="n">KsideD</span><span class="p">,</span> <span class="n">Kside</span> <span class="o">=</span> <span class="n">Kside_veg_v2022a</span><span class="p">(</span><span class="n">radI</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> <span class="n">radG</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">svfS</span><span class="p">,</span> <span class="n">svfW</span><span class="p">,</span> <span class="n">svfN</span><span class="p">,</span> <span class="n">svfE</span><span class="p">,</span>
                    <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">psi</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">albedo_b</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">KupE</span><span class="p">,</span> <span class="n">KupS</span><span class="p">,</span> <span class="n">KupW</span><span class="p">,</span>
                    <span class="n">KupN</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">anisotropic_sky</span><span class="p">,</span> <span class="n">diffsh</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">asvf</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">)</span>

        <span class="n">firstdaytime</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># # # # # # # NIGHTTIME # # # # # # # #</span>

        <span class="n">Tgwall</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Nocturnal K fluxes set to 0</span>
        <span class="n">Knight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Kdown</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Kwest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Kup</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Keast</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Ksouth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Knorth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">KsideI</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">KsideD</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">F_sh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">Tg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">shadow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">CI_Tg</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">CI</span><span class="p">)</span>
        <span class="n">CI_TgG</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">CI</span><span class="p">)</span>

        <span class="n">dRad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">Kside</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># # # # Lup # # # #</span>
        <span class="n">Lup</span> <span class="o">=</span> <span class="n">SBC</span> <span class="o">*</span> <span class="n">emis_grid</span> <span class="o">*</span> <span class="p">((</span><span class="n">Knight</span> <span class="o">+</span> <span class="n">Ta</span> <span class="o">+</span> <span class="n">Tg</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">landcover</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Lup</span><span class="p">[</span><span class="n">lc_grid</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SBC</span> <span class="o">*</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="p">(</span><span class="n">Twater</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># nocturnal Water temp</span>

        <span class="n">LupE</span> <span class="o">=</span> <span class="n">Lup</span>
        <span class="n">LupS</span> <span class="o">=</span> <span class="n">Lup</span>
        <span class="n">LupW</span> <span class="o">=</span> <span class="n">Lup</span>
        <span class="n">LupN</span> <span class="o">=</span> <span class="n">Lup</span>

        <span class="c1"># # For Tg output in POIs</span>
        <span class="n">TgOut</span> <span class="o">=</span> <span class="n">Ta</span> <span class="o">+</span> <span class="n">Tg</span>

        <span class="n">I0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">timeadd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">firstdaytime</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># # # # Ldown # # # #</span>
    <span class="c1"># Anisotropic sky longwave radiation</span>
    <span class="k">if</span> <span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;lv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="c1"># Creating skyvault of patches of constant radians (Tregeneza and Sharples, 1993)</span>
            <span class="n">skyvaultalt</span><span class="p">,</span> <span class="n">skyvaultazi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_patches</span><span class="p">(</span><span class="n">patch_option</span><span class="p">)</span>

            <span class="n">patch_emissivities</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">skyvaultalt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">skyvaultalt</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">skyvaultazi</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">patch_emissivities</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">L_patches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_patches</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">lv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">altitude</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CI</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">CI</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">CI</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="n">esky_c</span> <span class="o">=</span> <span class="n">CI</span> <span class="o">*</span> <span class="n">esky</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CI</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span>
            <span class="n">esky</span> <span class="o">=</span> <span class="n">esky_c</span>

        <span class="n">Ldown</span><span class="p">,</span> <span class="n">Lside</span><span class="p">,</span> <span class="n">Least_</span><span class="p">,</span> <span class="n">Lwest_</span><span class="p">,</span> <span class="n">Lnorth_</span><span class="p">,</span> <span class="n">Lsouth_</span> \
                  <span class="o">=</span> <span class="n">Lcyl_v2022a</span><span class="p">(</span><span class="n">esky</span><span class="p">,</span> <span class="n">L_patches</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">Lup</span><span class="p">,</span> <span class="n">shmat</span><span class="p">,</span> <span class="n">vegshmat</span><span class="p">,</span> <span class="n">vbshvegshmat</span><span class="p">,</span>
                                <span class="n">altitude</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">asvf</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ldown</span> <span class="o">=</span> <span class="p">(</span><span class="n">svf</span> <span class="o">+</span> <span class="n">svfveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">esky</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">svfveg</span> <span class="o">-</span> <span class="n">svfaveg</span><span class="p">)</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> \
                    <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">svfaveg</span> <span class="o">-</span> <span class="n">svf</span><span class="p">)</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tgwall</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">svf</span> <span class="o">-</span> <span class="n">svfveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="n">esky</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Jonsson et al.(2006)</span>

        <span class="n">Lside</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">L_patches</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">CI</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>  <span class="c1"># non - clear conditions</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">CI</span>
            <span class="n">Ldown</span> <span class="o">=</span> <span class="n">Ldown</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="n">svf</span> <span class="o">+</span> <span class="n">svfveg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">svfveg</span> <span class="o">-</span> <span class="n">svfaveg</span><span class="p">)</span> <span class="o">*</span>
                    <span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">svfaveg</span> <span class="o">-</span> <span class="n">svf</span><span class="p">)</span> <span class="o">*</span> <span class="n">ewall</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="n">Tgwall</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
                    <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">svf</span> <span class="o">-</span> <span class="n">svfveg</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ewall</span><span class="p">)</span> <span class="o">*</span> <span class="n">SBC</span> <span class="o">*</span> <span class="p">((</span><span class="n">Ta</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># # # # Lside # # # #</span>
    <span class="n">Least</span><span class="p">,</span> <span class="n">Lsouth</span><span class="p">,</span> <span class="n">Lwest</span><span class="p">,</span> <span class="n">Lnorth</span> <span class="o">=</span> <span class="n">Lside_veg_v2022a</span><span class="p">(</span><span class="n">svfS</span><span class="p">,</span> <span class="n">svfW</span><span class="p">,</span> <span class="n">svfN</span><span class="p">,</span> <span class="n">svfE</span><span class="p">,</span> <span class="n">svfEveg</span><span class="p">,</span> <span class="n">svfSveg</span><span class="p">,</span> <span class="n">svfWveg</span><span class="p">,</span> <span class="n">svfNveg</span><span class="p">,</span>
                    <span class="n">svfEaveg</span><span class="p">,</span> <span class="n">svfSaveg</span><span class="p">,</span> <span class="n">svfWaveg</span><span class="p">,</span> <span class="n">svfNaveg</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">altitude</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">Tgwall</span><span class="p">,</span> <span class="n">SBC</span><span class="p">,</span> <span class="n">ewall</span><span class="p">,</span> <span class="n">Ldown</span><span class="p">,</span>
                                                      <span class="n">esky</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_sh</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">LupE</span><span class="p">,</span> <span class="n">LupS</span><span class="p">,</span> <span class="n">LupW</span><span class="p">,</span> <span class="n">LupN</span><span class="p">,</span> <span class="n">anisotropic_sky</span><span class="p">)</span>

    <span class="c1"># Box and anisotropic longwave</span>
    <span class="k">if</span> <span class="n">cyl</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Least</span> <span class="o">+=</span> <span class="n">Least_</span>
        <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">Lwest_</span>
        <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">Lnorth_</span>
        <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">Lsouth_</span>

    <span class="c1"># # # # Calculation of radiant flux density and Tmrt # # # #</span>
    <span class="c1"># Human body considered as a cylinder with isotropic all-sky diffuse</span>
    <span class="k">if</span> <span class="n">cyl</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Sstr</span> <span class="o">=</span> <span class="n">absK</span> <span class="o">*</span> <span class="p">(</span><span class="n">KsideI</span> <span class="o">*</span> <span class="n">Fcyl</span> <span class="o">+</span> <span class="p">(</span><span class="n">Kdown</span> <span class="o">+</span> <span class="n">Kup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="p">(</span><span class="n">Knorth</span> <span class="o">+</span> <span class="n">Keast</span> <span class="o">+</span> <span class="n">Ksouth</span> <span class="o">+</span> <span class="n">Kwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span> <span class="o">+</span> <span class="n">absL</span> <span class="o">*</span> \
                        <span class="p">((</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">Lup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lnorth</span> <span class="o">+</span> <span class="n">Least</span> <span class="o">+</span> <span class="n">Lsouth</span> <span class="o">+</span> <span class="n">Lwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span>
    <span class="c1"># Human body considered as a cylinder with Perez et al. (1993) (anisotropic sky diffuse)</span>
    <span class="c1"># and Martin and Berdahl (1984) (anisotropic sky longwave)</span>
    <span class="k">elif</span> <span class="n">cyl</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Sstr</span> <span class="o">=</span> <span class="n">absK</span> <span class="o">*</span> <span class="p">(</span><span class="n">Kside</span> <span class="o">*</span> <span class="n">Fcyl</span> <span class="o">+</span> <span class="p">(</span><span class="n">Kdown</span> <span class="o">+</span> <span class="n">Kup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="p">(</span><span class="n">Knorth</span> <span class="o">+</span> <span class="n">Keast</span> <span class="o">+</span> <span class="n">Ksouth</span> <span class="o">+</span> <span class="n">Kwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span> <span class="o">+</span> <span class="n">absL</span> <span class="o">*</span> \
                        <span class="p">((</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">Lup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="n">Lside</span> <span class="o">*</span> <span class="n">Fcyl</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lnorth</span> <span class="o">+</span> <span class="n">Least</span> <span class="o">+</span> <span class="n">Lsouth</span> <span class="o">+</span> <span class="n">Lwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span>
    <span class="c1"># Knorth = nan Ksouth = nan Kwest = nan Keast = nan</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># Human body considered as a standing cube</span>
        <span class="n">Sstr</span> <span class="o">=</span> <span class="n">absK</span> <span class="o">*</span> <span class="p">((</span><span class="n">Kdown</span> <span class="o">+</span> <span class="n">Kup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="p">(</span><span class="n">Knorth</span> <span class="o">+</span> <span class="n">Keast</span> <span class="o">+</span> <span class="n">Ksouth</span> <span class="o">+</span> <span class="n">Kwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span> <span class="o">+</span> <span class="n">absL</span> <span class="o">*</span> \
                        <span class="p">((</span><span class="n">Ldown</span> <span class="o">+</span> <span class="n">Lup</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fup</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lnorth</span> <span class="o">+</span> <span class="n">Least</span> <span class="o">+</span> <span class="n">Lsouth</span> <span class="o">+</span> <span class="n">Lwest</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fside</span><span class="p">)</span>

    <span class="n">Tmrt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Sstr</span> <span class="o">/</span> <span class="p">(</span><span class="n">absL</span> <span class="o">*</span> <span class="n">SBC</span><span class="p">))))</span> <span class="o">-</span> <span class="mf">273.2</span>

    <span class="c1"># Add longwave to cardinal directions for output in POI</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cyl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">anisotropic_sky</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Least</span> <span class="o">+=</span> <span class="n">Least_</span>
        <span class="n">Lwest</span> <span class="o">+=</span> <span class="n">Lwest_</span>
        <span class="n">Lnorth</span> <span class="o">+=</span> <span class="n">Lnorth_</span>
        <span class="n">Lsouth</span> <span class="o">+=</span> <span class="n">Lsouth_</span>

    <span class="k">return</span> <span class="n">Tmrt</span><span class="p">,</span> <span class="n">Kdown</span><span class="p">,</span> <span class="n">Kup</span><span class="p">,</span> <span class="n">Ldown</span><span class="p">,</span> <span class="n">Lup</span><span class="p">,</span> <span class="n">Tg</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">esky</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">CI</span><span class="p">,</span> <span class="n">shadow</span><span class="p">,</span> <span class="n">firstdaytime</span><span class="p">,</span> <span class="n">timestepdec</span><span class="p">,</span> \
           <span class="n">timeadd</span><span class="p">,</span> <span class="n">Tgmap1</span><span class="p">,</span> <span class="n">Tgmap1E</span><span class="p">,</span> <span class="n">Tgmap1S</span><span class="p">,</span> <span class="n">Tgmap1W</span><span class="p">,</span> <span class="n">Tgmap1N</span><span class="p">,</span> <span class="n">Keast</span><span class="p">,</span> <span class="n">Ksouth</span><span class="p">,</span> <span class="n">Kwest</span><span class="p">,</span> <span class="n">Knorth</span><span class="p">,</span> <span class="n">Least</span><span class="p">,</span> \
           <span class="n">Lsouth</span><span class="p">,</span> <span class="n">Lwest</span><span class="p">,</span> <span class="n">Lnorth</span><span class="p">,</span> <span class="n">KsideI</span><span class="p">,</span> <span class="n">TgOut1</span><span class="p">,</span> <span class="n">TgOut</span><span class="p">,</span> <span class="n">radI</span><span class="p">,</span> <span class="n">radD</span><span class="p">,</span> \
               <span class="n">Lside</span><span class="p">,</span> <span class="n">L_patches</span><span class="p">,</span> <span class="n">CI_Tg</span><span class="p">,</span> <span class="n">CI_TgG</span><span class="p">,</span> <span class="n">KsideD</span><span class="p">,</span> <span class="n">dRad</span><span class="p">,</span> <span class="n">Kside</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2025, Harsh Kamath and Naveen Sudharsan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>