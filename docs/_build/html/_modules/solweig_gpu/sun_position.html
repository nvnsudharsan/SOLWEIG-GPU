

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>solweig_gpu.sun_position &mdash; SOLWEIG-GPU 1.2.15 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=4afb903a"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SOLWEIG-GPU
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SOLWEIG-GPU</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">solweig_gpu.sun_position</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for solweig_gpu.sun_position</h1><div class="highlight"><pre>
<span></span><span class="c1">#SOLWEIG-GPU: GPU-accelerated SOLWEIG model for urban thermal comfort simulation</span>
<span class="c1">#Copyright (C) 2022–2025 Harsh Kamath and Naveen Sudharsan</span>

<span class="c1">#This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#it under the terms of the GNU General Public License as published by</span>
<span class="c1">#the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#(at your option) any later version.</span>

<span class="c1">#This program is distributed in the hope that it will be useful,</span>
<span class="c1">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1">#GNU General Public License for more details.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">radians</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.ndimage.interpolation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>


<div class="viewcode-block" id="sun_position">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.sun_position">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_position</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate solar position (zenith and azimuth) using SPA algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Implements the Solar Position Algorithm (SPA) as described in:</span>
<span class="sd">    Reda, I. and Andreas, A. (2004). Solar position algorithm for solar radiation applications.</span>
<span class="sd">    Solar Energy, 76(5), 577-589.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        time (dict): Time information with keys:</span>
<span class="sd">            - &#39;year&#39; (int): Year</span>
<span class="sd">            - &#39;month&#39; (int): Month (1-12)</span>
<span class="sd">            - &#39;day&#39; (int): Day of month</span>
<span class="sd">            - &#39;hour&#39; (int): Hour (0-23)</span>
<span class="sd">            - &#39;min&#39; (int): Minute (0-59)</span>
<span class="sd">            - &#39;sec&#39; (int): Second (0-59)</span>
<span class="sd">            - &#39;UTC&#39; (float): UTC offset in hours (e.g., -5 for EST)</span>
<span class="sd">        </span>
<span class="sd">        location (dict): Geographic location with keys:</span>
<span class="sd">            - &#39;latitude&#39; (float): Latitude in degrees (-90 to 90)</span>
<span class="sd">            - &#39;longitude&#39; (float): Longitude in degrees (-180 to 180)</span>
<span class="sd">            - &#39;altitude&#39; (float): Elevation above sea level in meters</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Solar position containing:</span>
<span class="sd">            - &#39;zenith&#39; (float): Solar zenith angle in degrees (0=directly overhead, 90=horizon)</span>
<span class="sd">            - &#39;azimuth&#39; (float): Solar azimuth in degrees (0=North, 90=East, 180=South, 270=West)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Accounts for atmospheric refraction</span>
<span class="sd">        - Accuracy: ~0.0003° for years 2000-6000</span>
<span class="sd">        - All angles in degrees unless otherwise specified</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; time = {&#39;year&#39;: 2020, &#39;month&#39;: 7, &#39;day&#39;: 18, &#39;hour&#39;: 12, &#39;min&#39;: 0, &#39;sec&#39;: 0, &#39;UTC&#39;: -5}</span>
<span class="sd">        &gt;&gt;&gt; location = {&#39;latitude&#39;: 30.27, &#39;longitude&#39;: -97.74, &#39;altitude&#39;: 0}</span>
<span class="sd">        &gt;&gt;&gt; sun = sun_position(time, location)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Zenith: {sun[&#39;zenith&#39;]:.2f}°, Azimuth: {sun[&#39;azimuth&#39;]:.2f}°&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1. Calculate the Julian Day, and Century. Julian Ephemeris day, century</span>
    <span class="c1"># and millenium are calculated using a mean delta_t of 33.184 seconds.</span>
    <span class="n">julian</span> <span class="o">=</span> <span class="n">julian_calculation</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="c1">#print(julian)</span>

    <span class="c1"># 2. Calculate the Earth heliocentric longitude, latitude, and radius</span>
    <span class="c1"># vector (L, B, and R)</span>
    <span class="n">earth_heliocentric_position</span> <span class="o">=</span> <span class="n">earth_heliocentric_position_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">)</span>

    <span class="c1"># 3. Calculate the geocentric longitude and latitude</span>
    <span class="n">sun_geocentric_position</span> <span class="o">=</span> <span class="n">sun_geocentric_position_calculation</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">)</span>

    <span class="c1"># 4. Calculate the nutation in longitude and obliquity (in degrees).</span>
    <span class="n">nutation</span> <span class="o">=</span> <span class="n">nutation_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">)</span>

    <span class="c1"># 5. Calculate the true obliquity of the ecliptic (in degrees).</span>
    <span class="n">true_obliquity</span> <span class="o">=</span> <span class="n">true_obliquity_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">,</span> <span class="n">nutation</span><span class="p">)</span>

    <span class="c1"># 6. Calculate the aberration correction (in degrees)</span>
    <span class="n">aberration_correction</span> <span class="o">=</span> <span class="n">abberation_correction_calculation</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">)</span>

    <span class="c1"># 7. Calculate the apparent sun longitude in degrees)</span>
    <span class="n">apparent_sun_longitude</span> <span class="o">=</span> <span class="n">apparent_sun_longitude_calculation</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">,</span> <span class="n">nutation</span><span class="p">,</span> <span class="n">aberration_correction</span><span class="p">)</span>

    <span class="c1"># 8. Calculate the apparent sideral time at Greenwich (in degrees)</span>
    <span class="n">apparent_stime_at_greenwich</span> <span class="o">=</span> <span class="n">apparent_stime_at_greenwich_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">,</span> <span class="n">nutation</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">)</span>

    <span class="c1"># 9. Calculate the sun rigth ascension (in degrees)</span>
    <span class="n">sun_rigth_ascension</span> <span class="o">=</span> <span class="n">sun_rigth_ascension_calculation</span><span class="p">(</span><span class="n">apparent_sun_longitude</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">,</span> <span class="n">sun_geocentric_position</span><span class="p">)</span>

    <span class="c1"># 10. Calculate the geocentric sun declination (in degrees). Positive or</span>
    <span class="c1"># negative if the sun is north or south of the celestial equator.</span>
    <span class="n">sun_geocentric_declination</span> <span class="o">=</span> <span class="n">sun_geocentric_declination_calculation</span><span class="p">(</span><span class="n">apparent_sun_longitude</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">,</span>
                                                                        <span class="n">sun_geocentric_position</span><span class="p">)</span>

    <span class="c1"># 11. Calculate the observer local hour angle (in degrees, westward from south).</span>
    <span class="n">observer_local_hour</span> <span class="o">=</span> <span class="n">observer_local_hour_calculation</span><span class="p">(</span><span class="n">apparent_stime_at_greenwich</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">sun_rigth_ascension</span><span class="p">)</span>

    <span class="c1"># 12. Calculate the topocentric sun position (rigth ascension, declination and</span>
    <span class="c1"># rigth ascension parallax in degrees)</span>
    <span class="n">topocentric_sun_position</span> <span class="o">=</span> <span class="n">topocentric_sun_position_calculate</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
                                                                  <span class="n">observer_local_hour</span><span class="p">,</span> <span class="n">sun_rigth_ascension</span><span class="p">,</span>
                                                                  <span class="n">sun_geocentric_declination</span><span class="p">)</span>

    <span class="c1"># 13. Calculate the topocentric local hour angle (in degrees)</span>
    <span class="n">topocentric_local_hour</span> <span class="o">=</span> <span class="n">topocentric_local_hour_calculate</span><span class="p">(</span><span class="n">observer_local_hour</span><span class="p">,</span> <span class="n">topocentric_sun_position</span><span class="p">)</span>

    <span class="c1"># 14. Calculate the topocentric zenith and azimuth angle (in degrees)</span>
    <span class="n">sun</span> <span class="o">=</span> <span class="n">sun_topocentric_zenith_angle_calculate</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">topocentric_sun_position</span><span class="p">,</span> <span class="n">topocentric_local_hour</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sun</span></div>



<div class="viewcode-block" id="julian_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.julian_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">julian_calculation</span><span class="p">(</span><span class="n">t_input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Julian day and related time parameters.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        t_input (dict): Time dictionary with year, month, day, hour, min, sec, UTC</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Julian day, century, ephemeris day/century/millennium</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

        <span class="n">time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">year</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">month</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">day</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">minute</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_input</span><span class="o">.</span><span class="n">second</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">t_input</span>

    <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span>

    <span class="n">ut_time</span> <span class="o">=</span> <span class="p">((</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">))</span>   <span class="c1"># time of day in UT time.</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ut_time</span>   <span class="c1"># Day of month in decimal time, ex. 2sd day of month at 12:30:30UT, D=2.521180556</span>

    <span class="c1"># In 1582, the gregorian calendar was adopted</span>
    <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1582</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>   <span class="c1"># The Julian calendar ended on October 4, 1582</span>
                <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>   <span class="c1"># The Gregorian calendar started on October 15, 1582</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">A</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This date never existed!. Date automatically set to October 4, 1582&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>   <span class="c1"># Julian calendar</span>
            <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Gregorian calendar</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">A</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1582</span><span class="p">:</span>   <span class="c1"># Julian calendar</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>    <span class="c1"># Gregorian calendar</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">A</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">julian</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">365.25</span><span class="o">*</span><span class="p">(</span><span class="n">Y</span><span class="o">+</span><span class="mi">4716</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">30.6001</span><span class="o">*</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1524.5</span>

    <span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># 33.184;</span>
    <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">julian</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta_t</span><span class="o">/</span><span class="mi">86400</span><span class="p">)</span>
    <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;century&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">julian</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2451545</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36525</span>
    <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_century&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_day&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2451545</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36525</span>
    <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_millenium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_century&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>

    <span class="k">return</span> <span class="n">julian</span></div>



<div class="viewcode-block" id="earth_heliocentric_position_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.earth_heliocentric_position_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">earth_heliocentric_position_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Earth&#39;s heliocentric position (longitude, latitude, radius).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        julian (dict): Julian day parameters</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Earth heliocentric position (longitude, latitude, radius in AU)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Tabulated values for the longitude calculation</span>
    <span class="c1"># L terms  from the original code.</span>
    <span class="n">L0_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">175347046.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">3341656.0</span><span class="p">,</span> <span class="mf">4.6692568</span><span class="p">,</span> <span class="mf">6283.07585</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">34894.0</span><span class="p">,</span> <span class="mf">4.6261</span><span class="p">,</span> <span class="mf">12566.1517</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">3497.0</span><span class="p">,</span> <span class="mf">2.7441</span><span class="p">,</span> <span class="mf">5753.3849</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">3418.0</span><span class="p">,</span> <span class="mf">2.8289</span><span class="p">,</span> <span class="mf">3.5231</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">3136.0</span><span class="p">,</span> <span class="mf">3.6277</span><span class="p">,</span> <span class="mf">77713.7715</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">2676.0</span><span class="p">,</span> <span class="mf">4.4181</span><span class="p">,</span> <span class="mf">7860.4194</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">2343.0</span><span class="p">,</span> <span class="mf">6.1352</span><span class="p">,</span> <span class="mf">3930.2097</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1324.0</span><span class="p">,</span> <span class="mf">0.7425</span><span class="p">,</span> <span class="mf">11506.7698</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1273.0</span><span class="p">,</span> <span class="mf">2.0371</span><span class="p">,</span> <span class="mf">529.691</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1199.0</span><span class="p">,</span> <span class="mf">1.1096</span><span class="p">,</span> <span class="mf">1577.3435</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">990</span><span class="p">,</span> <span class="mf">5.233</span><span class="p">,</span> <span class="mf">5884.927</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">902</span><span class="p">,</span> <span class="mf">2.045</span><span class="p">,</span> <span class="mf">26.298</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">857</span><span class="p">,</span> <span class="mf">3.508</span><span class="p">,</span> <span class="mf">398.149</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">780</span><span class="p">,</span> <span class="mf">1.179</span><span class="p">,</span> <span class="mf">5223.694</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">753</span><span class="p">,</span> <span class="mf">2.533</span><span class="p">,</span> <span class="mf">5507.553</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">505</span><span class="p">,</span> <span class="mf">4.583</span><span class="p">,</span> <span class="mf">18849.228</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">492</span><span class="p">,</span> <span class="mf">4.205</span><span class="p">,</span> <span class="mf">775.523</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">357</span><span class="p">,</span> <span class="mf">2.92</span><span class="p">,</span> <span class="mf">0.067</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">317</span><span class="p">,</span> <span class="mf">5.849</span><span class="p">,</span> <span class="mf">11790.629</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">284</span><span class="p">,</span> <span class="mf">1.899</span><span class="p">,</span> <span class="mf">796.298</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">271</span><span class="p">,</span> <span class="mf">0.315</span><span class="p">,</span> <span class="mf">10977.079</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">243</span><span class="p">,</span> <span class="mf">0.345</span><span class="p">,</span> <span class="mf">5486.778</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">206</span><span class="p">,</span> <span class="mf">4.806</span><span class="p">,</span> <span class="mf">2544.314</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">205</span><span class="p">,</span> <span class="mf">1.869</span><span class="p">,</span> <span class="mf">5573.143</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">202</span><span class="p">,</span> <span class="mf">2.4458</span><span class="p">,</span> <span class="mf">6069.777</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">156</span><span class="p">,</span> <span class="mf">0.833</span><span class="p">,</span> <span class="mf">213.299</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">132</span><span class="p">,</span> <span class="mf">3.411</span><span class="p">,</span> <span class="mf">2942.463</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">126</span><span class="p">,</span> <span class="mf">1.083</span><span class="p">,</span> <span class="mf">20.775</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">115</span><span class="p">,</span> <span class="mf">0.645</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mf">0.636</span><span class="p">,</span> <span class="mf">4694.003</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mf">0.976</span><span class="p">,</span> <span class="mf">15720.839</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mf">4.267</span><span class="p">,</span> <span class="mf">7.114</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">99</span><span class="p">,</span> <span class="mf">6.21</span><span class="p">,</span> <span class="mf">2146.17</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mf">0.68</span><span class="p">,</span> <span class="mf">155.42</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">86</span><span class="p">,</span> <span class="mf">5.98</span><span class="p">,</span> <span class="mf">161000.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">85</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">6275.96</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">85</span><span class="p">,</span> <span class="mf">3.67</span><span class="p">,</span> <span class="mf">71430.7</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mf">1.81</span><span class="p">,</span> <span class="mf">17260.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">79</span><span class="p">,</span> <span class="mf">3.04</span><span class="p">,</span> <span class="mf">12036.46</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">71</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">,</span> <span class="mf">5088.63</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">74</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">3154.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">74</span><span class="p">,</span> <span class="mf">4.68</span><span class="p">,</span> <span class="mf">801.82</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">9437.76</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">62</span><span class="p">,</span> <span class="mf">3.98</span><span class="p">,</span> <span class="mf">8827.39</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">61</span><span class="p">,</span> <span class="mf">1.82</span><span class="p">,</span> <span class="mf">7084.9</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">57</span><span class="p">,</span> <span class="mf">2.78</span><span class="p">,</span> <span class="mf">6286.6</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mf">4.39</span><span class="p">,</span> <span class="mf">14143.5</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mf">3.47</span><span class="p">,</span> <span class="mf">6279.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">52</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">12139.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">52</span><span class="p">,</span> <span class="mf">1.33</span><span class="p">,</span> <span class="mf">1748.02</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">51</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">5856.48</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">49</span><span class="p">,</span> <span class="mf">0.49</span><span class="p">,</span> <span class="mf">1194.45</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mf">5.37</span><span class="p">,</span> <span class="mf">8429.24</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">19651.05</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mf">6.17</span><span class="p">,</span> <span class="mf">10447.39</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mf">6.04</span><span class="p">,</span> <span class="mf">10213.29</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mf">2.57</span><span class="p">,</span> <span class="mf">1059.38</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mf">1.71</span><span class="p">,</span> <span class="mf">2352.87</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mf">1.78</span><span class="p">,</span> <span class="mf">6812.77</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">17789.85</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="mf">83996.85</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mf">2.74</span><span class="p">,</span> <span class="mf">1349.87</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mf">3.16</span><span class="p">,</span> <span class="mf">4690.48</span><span class="p">]])</span>

    <span class="n">L1_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">628331966747.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">206059.0</span><span class="p">,</span> <span class="mf">2.678235</span><span class="p">,</span> <span class="mf">6283.07585</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">4303.0</span><span class="p">,</span> <span class="mf">2.6351</span><span class="p">,</span> <span class="mf">12566.1517</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">425.0</span><span class="p">,</span> <span class="mf">1.59</span><span class="p">,</span> <span class="mf">3.523</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">119.0</span><span class="p">,</span> <span class="mf">5.796</span><span class="p">,</span> <span class="mf">26.298</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">109.0</span><span class="p">,</span> <span class="mf">2.966</span><span class="p">,</span> <span class="mf">1577.344</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">93</span><span class="p">,</span> <span class="mf">2.59</span><span class="p">,</span> <span class="mf">18849.23</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="mf">1.14</span><span class="p">,</span> <span class="mf">529.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">68</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">398.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">67</span><span class="p">,</span> <span class="mf">4.41</span><span class="p">,</span> <span class="mf">5507.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">59</span><span class="p">,</span> <span class="mf">2.89</span><span class="p">,</span> <span class="mf">5223.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mf">2.17</span><span class="p">,</span> <span class="mf">155.42</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">796.3</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mf">0.47</span><span class="p">,</span> <span class="mf">775.52</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">29</span><span class="p">,</span> <span class="mf">2.65</span><span class="p">,</span> <span class="mf">7.11</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mf">5.34</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">19</span><span class="p">,</span> <span class="mf">1.85</span><span class="p">,</span> <span class="mf">5486.78</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">19</span><span class="p">,</span> <span class="mf">4.97</span><span class="p">,</span> <span class="mf">213.3</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mf">2.99</span><span class="p">,</span> <span class="mf">6275.96</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">2544.31</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">1.43</span><span class="p">,</span> <span class="mf">2146.17</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mf">1.21</span><span class="p">,</span> <span class="mf">10977.08</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span> <span class="mf">1748.02</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">3.26</span><span class="p">,</span> <span class="mf">5088.63</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">1194.45</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">2.08</span><span class="p">,</span> <span class="mi">4694</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">,</span> <span class="mf">553.57</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">3286.6</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">4.24</span><span class="p">,</span> <span class="mf">1349.87</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">,</span> <span class="mf">242.73</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">5.64</span><span class="p">,</span> <span class="mf">951.72</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">5.3</span><span class="p">,</span> <span class="mf">2352.87</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.65</span><span class="p">,</span> <span class="mf">9437.76</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">4.67</span><span class="p">,</span> <span class="mf">4690.48</span><span class="p">]])</span>

    <span class="n">L2_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">52919.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">8720.0</span><span class="p">,</span> <span class="mf">1.0721</span><span class="p">,</span> <span class="mf">6283.0758</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">309.0</span><span class="p">,</span> <span class="mf">0.867</span><span class="p">,</span> <span class="mf">12566.152</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">3.52</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">5.19</span><span class="p">,</span> <span class="mf">26.3</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">3.68</span><span class="p">,</span> <span class="mf">155.42</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">,</span> <span class="mf">18849.23</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">,</span> <span class="mf">77713.77</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">775.52</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">4.66</span><span class="p">,</span> <span class="mf">1577.34</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="mf">7.11</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">3.44</span><span class="p">,</span> <span class="mf">5573.14</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.14</span><span class="p">,</span> <span class="mf">796.3</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">6.05</span><span class="p">,</span> <span class="mf">5507.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.19</span><span class="p">,</span> <span class="mf">242.73</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">6.12</span><span class="p">,</span> <span class="mf">529.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.31</span><span class="p">,</span> <span class="mf">398.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.28</span><span class="p">,</span> <span class="mf">553.57</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">4.38</span><span class="p">,</span> <span class="mf">5223.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3.75</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">]])</span>

    <span class="n">L3_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">289.0</span><span class="p">,</span> <span class="mf">5.844</span><span class="p">,</span> <span class="mf">6283.076</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">35</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mf">5.49</span><span class="p">,</span> <span class="mf">12566.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">,</span> <span class="mf">155.42</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">4.72</span><span class="p">,</span> <span class="mf">3.52</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.3</span><span class="p">,</span> <span class="mf">18849.23</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">5.97</span><span class="p">,</span> <span class="mf">242.73</span><span class="p">]])</span>
    <span class="n">L4_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">114.0</span><span class="p">,</span> <span class="mf">3.142</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">4.13</span><span class="p">,</span> <span class="mf">6283.08</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.84</span><span class="p">,</span> <span class="mf">12566.15</span><span class="p">]])</span>

    <span class="n">L5_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">L5_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">L5_terms</span><span class="p">)</span>    <span class="c1"># since L5_terms is 1D, we have to convert it to 2D to avoid indexErrors</span>

    <span class="n">A0</span> <span class="o">=</span> <span class="n">L0_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="n">L0_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="n">L0_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A1</span> <span class="o">=</span> <span class="n">L1_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="n">L1_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">L1_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A2</span> <span class="o">=</span> <span class="n">L2_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B2</span> <span class="o">=</span> <span class="n">L2_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">L2_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">L3_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B3</span> <span class="o">=</span> <span class="n">L3_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C3</span> <span class="o">=</span> <span class="n">L3_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">L4_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B4</span> <span class="o">=</span> <span class="n">L4_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C4</span> <span class="o">=</span> <span class="n">L4_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A5</span> <span class="o">=</span> <span class="n">L5_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B5</span> <span class="o">=</span> <span class="n">L5_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C5</span> <span class="o">=</span> <span class="n">L5_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">JME</span> <span class="o">=</span> <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_millenium&#39;</span><span class="p">]</span>

    <span class="c1"># Compute the Earth Heliochentric longitude from the tabulated values.</span>
    <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B0</span> <span class="o">+</span> <span class="p">(</span><span class="n">C0</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B1</span> <span class="o">+</span> <span class="p">(</span><span class="n">C1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B2</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B3</span> <span class="o">+</span> <span class="p">(</span><span class="n">C3</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B4</span> <span class="o">+</span> <span class="p">(</span><span class="n">C4</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L5</span> <span class="o">=</span> <span class="n">A5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B5</span> <span class="o">+</span> <span class="p">(</span><span class="n">C5</span> <span class="o">*</span> <span class="n">JME</span><span class="p">))</span>

    <span class="n">earth_heliocentric_position</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">L0</span> <span class="o">+</span> <span class="p">(</span><span class="n">L1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">L2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
                                                          <span class="p">(</span><span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span>
                                                          <span class="p">(</span><span class="n">L4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span>
                                                          <span class="p">(</span><span class="n">L5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">1e8</span>
    <span class="c1"># Convert the longitude to degrees.</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># Limit the range to [0,360]</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="c1"># Tabulated values for the earth heliocentric latitude.</span>
    <span class="c1"># B terms  from the original code.</span>
    <span class="n">B0_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">280.0</span><span class="p">,</span> <span class="mf">3.199</span><span class="p">,</span> <span class="mf">84334.662</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">102.0</span><span class="p">,</span> <span class="mf">5.422</span><span class="p">,</span> <span class="mf">5507.553</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mf">3.88</span><span class="p">,</span> <span class="mf">5223.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">44</span><span class="p">,</span> <span class="mf">3.7</span><span class="p">,</span> <span class="mf">2352.87</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">1577.34</span><span class="p">]])</span>

    <span class="n">B1_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">5507.55</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.73</span><span class="p">,</span> <span class="mf">5223.69</span><span class="p">]])</span>

    <span class="n">A0</span> <span class="o">=</span> <span class="n">B0_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="n">B0_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="n">B0_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A1</span> <span class="o">=</span> <span class="n">B1_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="n">B1_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">B1_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B0</span> <span class="o">+</span> <span class="p">(</span><span class="n">C0</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B1</span> <span class="o">+</span> <span class="p">(</span><span class="n">C1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>

    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">L0</span> <span class="o">+</span> <span class="p">(</span><span class="n">L1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e8</span>

    <span class="c1"># Convert the latitude to degrees.</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># Limit the range to [0,360];</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="c1"># Tabulated values for radius vector.</span>
    <span class="c1"># R terms from the original code</span>
    <span class="n">R0_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">100013989.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1670700.0</span><span class="p">,</span> <span class="mf">3.0984635</span><span class="p">,</span> <span class="mf">6283.07585</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">13956.0</span><span class="p">,</span> <span class="mf">3.05525</span><span class="p">,</span> <span class="mf">12566.1517</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">3084.0</span><span class="p">,</span> <span class="mf">5.1985</span><span class="p">,</span> <span class="mf">77713.7715</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1628.0</span><span class="p">,</span> <span class="mf">1.1739</span><span class="p">,</span> <span class="mf">5753.3849</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1576.0</span><span class="p">,</span> <span class="mf">2.8469</span><span class="p">,</span> <span class="mf">7860.4194</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">925.0</span><span class="p">,</span> <span class="mf">5.453</span><span class="p">,</span> <span class="mf">11506.77</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">542.0</span><span class="p">,</span> <span class="mf">4.564</span><span class="p">,</span> <span class="mf">3930.21</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">472.0</span><span class="p">,</span> <span class="mf">3.661</span><span class="p">,</span> <span class="mf">5884.927</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">346.0</span><span class="p">,</span> <span class="mf">0.964</span><span class="p">,</span> <span class="mf">5507.553</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">329.0</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">,</span> <span class="mf">5223.694</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">307.0</span><span class="p">,</span> <span class="mf">0.299</span><span class="p">,</span> <span class="mf">5573.143</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">243.0</span><span class="p">,</span> <span class="mf">4.273</span><span class="p">,</span> <span class="mf">11790.629</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">212.0</span><span class="p">,</span> <span class="mf">5.847</span><span class="p">,</span> <span class="mf">1577.344</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">186.0</span><span class="p">,</span> <span class="mf">5.022</span><span class="p">,</span> <span class="mf">10977.079</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">175.0</span><span class="p">,</span> <span class="mf">3.012</span><span class="p">,</span> <span class="mf">18849.228</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">110.0</span><span class="p">,</span> <span class="mf">5.055</span><span class="p">,</span> <span class="mf">5486.778</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mf">0.89</span><span class="p">,</span> <span class="mf">6069.78</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">86</span><span class="p">,</span> <span class="mf">5.69</span><span class="p">,</span> <span class="mf">15720.84</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">86</span><span class="p">,</span> <span class="mf">1.27</span><span class="p">,</span> <span class="mf">161000.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">85</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">,</span> <span class="mf">17260.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">63</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="mf">529.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">57</span><span class="p">,</span> <span class="mf">2.01</span><span class="p">,</span> <span class="mf">83996.85</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mf">5.24</span><span class="p">,</span> <span class="mf">71430.7</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">49</span><span class="p">,</span> <span class="mf">3.25</span><span class="p">,</span> <span class="mf">2544.31</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mf">2.58</span><span class="p">,</span> <span class="mf">775.52</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mf">5.54</span><span class="p">,</span> <span class="mf">9437.76</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mf">6.01</span><span class="p">,</span> <span class="mf">6275.96</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mf">5.36</span><span class="p">,</span> <span class="mi">4694</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">38</span><span class="p">,</span> <span class="mf">2.39</span><span class="p">,</span> <span class="mf">8827.39</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">19651.05</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">12139.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">,</span> <span class="mf">12036.46</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">35</span><span class="p">,</span> <span class="mf">1.84</span><span class="p">,</span> <span class="mf">2942.46</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="mf">7084.9</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">5088.63</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mf">1.78</span><span class="p">,</span> <span class="mf">398.15</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mf">1.21</span><span class="p">,</span> <span class="mf">6286.6</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">,</span> <span class="mf">6279.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">26</span><span class="p">,</span> <span class="mf">4.59</span><span class="p">,</span> <span class="mf">10447.39</span><span class="p">]])</span>

    <span class="n">R1_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">103019.0</span><span class="p">,</span> <span class="mf">1.10749</span><span class="p">,</span> <span class="mf">6283.07585</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1721.0</span><span class="p">,</span> <span class="mf">1.0644</span><span class="p">,</span> <span class="mf">12566.1517</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">702.0</span><span class="p">,</span> <span class="mf">3.142</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">18849.23</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mf">2.84</span><span class="p">,</span> <span class="mf">5507.55</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mf">1.32</span><span class="p">,</span> <span class="mf">5223.69</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mf">1.42</span><span class="p">,</span> <span class="mf">1577.34</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">5.91</span><span class="p">,</span> <span class="mf">10977.08</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">1.42</span><span class="p">,</span> <span class="mf">6275.96</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">,</span> <span class="mf">5486.78</span><span class="p">]])</span>

    <span class="n">R2_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4359.0</span><span class="p">,</span> <span class="mf">5.7846</span><span class="p">,</span> <span class="mf">6283.0758</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">124.0</span><span class="p">,</span> <span class="mf">5.579</span><span class="p">,</span> <span class="mf">12566.152</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mf">3.63</span><span class="p">,</span> <span class="mf">77713.77</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.87</span><span class="p">,</span> <span class="mf">5573.14</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.47</span><span class="p">,</span> <span class="mi">18849</span><span class="p">]])</span>

    <span class="n">R3_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">145.0</span><span class="p">,</span> <span class="mf">4.273</span><span class="p">,</span> <span class="mf">6283.076</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">3.92</span><span class="p">,</span> <span class="mf">12566.15</span><span class="p">]])</span>

    <span class="n">R4_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">2.56</span><span class="p">,</span> <span class="mf">6283.08</span><span class="p">]</span>
    <span class="n">R4_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">R4_terms</span><span class="p">)</span>    <span class="c1"># since L5_terms is 1D, we have to convert it to 2D to avoid indexErrors</span>

    <span class="n">A0</span> <span class="o">=</span> <span class="n">R0_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B0</span> <span class="o">=</span> <span class="n">R0_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="n">R0_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A1</span> <span class="o">=</span> <span class="n">R1_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="n">R1_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">R1_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A2</span> <span class="o">=</span> <span class="n">R2_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B2</span> <span class="o">=</span> <span class="n">R2_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">R2_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">R3_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B3</span> <span class="o">=</span> <span class="n">R3_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C3</span> <span class="o">=</span> <span class="n">R3_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">R4_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">B4</span> <span class="o">=</span> <span class="n">R4_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">C4</span> <span class="o">=</span> <span class="n">R4_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Compute the Earth heliocentric radius vector</span>
    <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B0</span> <span class="o">+</span> <span class="p">(</span><span class="n">C0</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B1</span> <span class="o">+</span> <span class="p">(</span><span class="n">C1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B2</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B3</span> <span class="o">+</span> <span class="p">(</span><span class="n">C3</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)))</span>
    <span class="n">L4</span> <span class="o">=</span> <span class="n">A4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">B4</span> <span class="o">+</span> <span class="p">(</span><span class="n">C4</span> <span class="o">*</span> <span class="n">JME</span><span class="p">))</span>

    <span class="c1"># Units are in AU</span>
    <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">L0</span> <span class="o">+</span> <span class="p">(</span><span class="n">L1</span> <span class="o">*</span> <span class="n">JME</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">L2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
                                             <span class="p">(</span><span class="n">L3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span>
                                             <span class="p">(</span><span class="n">L4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JME</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">1e8</span>

    <span class="k">return</span> <span class="n">earth_heliocentric_position</span></div>



<div class="viewcode-block" id="sun_geocentric_position_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.sun_geocentric_position_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_geocentric_position_calculation</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate geocentric sun position from Earth heliocentric position. SPA Step 3.&quot;&quot;&quot;</span>

    <span class="n">sun_geocentric_position</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span>
    <span class="c1"># Limit the range to [0,360];</span>
    <span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>
    <span class="c1"># Limit the range to [0,360]</span>
    <span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sun_geocentric_position</span></div>



<div class="viewcode-block" id="nutation_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.nutation_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nutation_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate nutation in longitude and obliquity.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        julian (dict): Julian parameters</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Nutation in longitude and obliquity (degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># All Xi are in degrees.</span>
    <span class="n">JCE</span> <span class="o">=</span> <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_century&#39;</span><span class="p">]</span>

    <span class="c1"># 1. Mean elongation of the moon from the sun</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([(</span><span class="mi">1</span><span class="o">/</span><span class="mi">189474</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.0019142</span><span class="p">,</span> <span class="mf">445267.11148</span><span class="p">,</span> <span class="mf">297.85036</span><span class="p">])</span>

    <span class="c1"># X0 = polyval(p, JCE);</span>
    <span class="n">X0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>   <span class="c1"># This is faster than polyval...</span>

    <span class="c1"># 2. Mean anomaly of the sun (earth)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">300000</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.0001603</span><span class="p">,</span> <span class="mf">35999.05034</span><span class="p">,</span> <span class="mf">357.52772</span><span class="p">])</span>

    <span class="c1"># X1 = polyval(p, JCE)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># 3. Mean anomaly of the moon</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([(</span><span class="mi">1</span><span class="o">/</span><span class="mi">56250</span><span class="p">),</span> <span class="mf">0.0086972</span><span class="p">,</span> <span class="mf">477198.867398</span><span class="p">,</span> <span class="mf">134.96298</span><span class="p">])</span>

    <span class="c1"># X2 = polyval(p, JCE);</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># 4. Moon argument of latitude</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([(</span><span class="mi">1</span><span class="o">/</span><span class="mi">327270</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.0036825</span><span class="p">,</span> <span class="mf">483202.017538</span><span class="p">,</span> <span class="mf">93.27191</span><span class="p">])</span>

    <span class="c1"># X3 = polyval(p, JCE)</span>
    <span class="n">X3</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># 5. Longitude of the ascending node of the moon&#39;s mean orbit on the</span>
    <span class="c1"># ecliptic, measured from the mean equinox of the date</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([(</span><span class="mi">1</span><span class="o">/</span><span class="mi">450000</span><span class="p">),</span> <span class="mf">0.0020708</span><span class="p">,</span> <span class="o">-</span><span class="mf">1934.136261</span><span class="p">,</span> <span class="mf">125.04452</span><span class="p">])</span>

    <span class="c1"># X4 = polyval(p, JCE);</span>
    <span class="n">X4</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JCE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Y tabulated terms from the original code</span>
    <span class="n">Y_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="n">nutation_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">171996</span><span class="p">,</span> <span class="o">-</span><span class="mf">174.2</span><span class="p">,</span> <span class="mi">92025</span><span class="p">,</span> <span class="mf">8.9</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">13187</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6</span><span class="p">,</span> <span class="mi">5736</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">2274</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">977</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">2062</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mi">895</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">1426</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.4</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">712</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">517</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">386</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">301</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">217</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">95</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">158</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">129</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">53</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">63</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">63</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">58</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">51</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

    <span class="c1"># Using the tabulated values, compute the delta_longitude and</span>
    <span class="c1"># delta_obliquity.</span>
    <span class="n">Xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X0</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X4</span><span class="p">])</span>    <span class="c1"># a col mat in octave</span>

    <span class="n">tabulated_argument</span> <span class="o">=</span> <span class="n">Y_terms</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Xi</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>

    <span class="n">delta_longitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">nutation_terms</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">nutation_terms</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tabulated_argument</span><span class="p">)</span>
    <span class="n">delta_obliquity</span> <span class="o">=</span> <span class="p">(</span><span class="n">nutation_terms</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">nutation_terms</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">JCE</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tabulated_argument</span><span class="p">)</span>

    <span class="n">nutation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>    <span class="c1"># init nutation dictionary</span>
    <span class="c1"># Nutation in longitude</span>
    <span class="n">nutation</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_longitude</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36000000</span>

    <span class="c1"># Nutation in obliquity</span>
    <span class="n">nutation</span><span class="p">[</span><span class="s1">&#39;obliquity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_obliquity</span><span class="p">)</span> <span class="o">/</span> <span class="mi">36000000</span>

    <span class="k">return</span> <span class="n">nutation</span></div>



<div class="viewcode-block" id="true_obliquity_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.true_obliquity_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">true_obliquity_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">,</span> <span class="n">nutation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate true obliquity of the ecliptic. SPA Step 5.&quot;&quot;&quot;</span>


    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([</span><span class="mf">2.45</span><span class="p">,</span> <span class="mf">5.79</span><span class="p">,</span> <span class="mf">27.87</span><span class="p">,</span> <span class="mf">7.12</span><span class="p">,</span> <span class="o">-</span><span class="mf">39.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">249.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.38</span><span class="p">,</span> <span class="mf">1999.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.55</span><span class="p">,</span> <span class="o">-</span><span class="mf">4680.93</span><span class="p">,</span> <span class="mf">84381.448</span><span class="p">])</span>

    <span class="c1"># mean_obliquity = polyval(p, julian.ephemeris_millenium/10);</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;ephemeris_millenium&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="n">mean_obliquity</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                     <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">U</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

    <span class="n">true_obliquity</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_obliquity</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span> <span class="o">+</span> <span class="n">nutation</span><span class="p">[</span><span class="s1">&#39;obliquity&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">true_obliquity</span></div>



<div class="viewcode-block" id="abberation_correction_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.abberation_correction_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">abberation_correction_calculation</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate aberration correction. SPA Step 6.&quot;&quot;&quot;</span>

    <span class="n">aberration_correction</span> <span class="o">=</span> <span class="o">-</span><span class="mf">20.4898</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">aberration_correction</span></div>



<div class="viewcode-block" id="apparent_sun_longitude_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.apparent_sun_longitude_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apparent_sun_longitude_calculation</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">,</span> <span class="n">nutation</span><span class="p">,</span> <span class="n">aberration_correction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate apparent sun longitude. SPA Step 7.&quot;&quot;&quot;</span>

    <span class="n">apparent_sun_longitude</span> <span class="o">=</span> <span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">nutation</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">aberration_correction</span>
    <span class="k">return</span> <span class="n">apparent_sun_longitude</span></div>



<div class="viewcode-block" id="apparent_stime_at_greenwich_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.apparent_stime_at_greenwich_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apparent_stime_at_greenwich_calculation</span><span class="p">(</span><span class="n">julian</span><span class="p">,</span> <span class="n">nutation</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate apparent sidereal time at Greenwich. SPA Step 8.&quot;&quot;&quot;</span>

    <span class="n">JD</span> <span class="o">=</span> <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span>
    <span class="n">JC</span> <span class="o">=</span> <span class="n">julian</span><span class="p">[</span><span class="s1">&#39;century&#39;</span><span class="p">]</span>

    <span class="c1"># Mean sideral time, in degrees</span>
    <span class="n">mean_stime</span> <span class="o">=</span> <span class="mf">280.46061837</span> <span class="o">+</span> <span class="p">(</span><span class="mf">360.98564736629</span><span class="o">*</span><span class="p">(</span><span class="n">JD</span><span class="o">-</span><span class="mi">2451545</span><span class="p">))</span> <span class="o">+</span> \
                 <span class="p">(</span><span class="mf">0.000387933</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JC</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> \
                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">JC</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">38710000</span><span class="p">)</span>

    <span class="c1"># Limit the range to [0-360];</span>
    <span class="n">mean_stime</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">mean_stime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">apparent_stime_at_greenwich</span> <span class="o">=</span> <span class="n">mean_stime</span> <span class="o">+</span> <span class="p">(</span><span class="n">nutation</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">true_obliquity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">apparent_stime_at_greenwich</span></div>



<div class="viewcode-block" id="sun_rigth_ascension_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.sun_rigth_ascension_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_rigth_ascension_calculation</span><span class="p">(</span><span class="n">apparent_sun_longitude</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">,</span> <span class="n">sun_geocentric_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate sun right ascension. SPA Step 9.&quot;&quot;&quot;</span>

    <span class="n">argument_numerator</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">apparent_sun_longitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">true_obliquity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span> <span class="o">-</span> \
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">true_obliquity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
    <span class="n">argument_denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">apparent_sun_longitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">);</span>

    <span class="n">sun_rigth_ascension</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">argument_numerator</span><span class="p">,</span> <span class="n">argument_denominator</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1"># Limit the range to [0,360];</span>
    <span class="n">sun_rigth_ascension</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">sun_rigth_ascension</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sun_rigth_ascension</span></div>



<div class="viewcode-block" id="sun_geocentric_declination_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.sun_geocentric_declination_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_geocentric_declination_calculation</span><span class="p">(</span><span class="n">apparent_sun_longitude</span><span class="p">,</span> <span class="n">true_obliquity</span><span class="p">,</span> <span class="n">sun_geocentric_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate geocentric sun declination. SPA Step 10.&quot;&quot;&quot;</span>

    <span class="n">argument</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">true_obliquity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span> <span class="o">+</span> \
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sun_geocentric_position</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">true_obliquity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span>
         <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">apparent_sun_longitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>

    <span class="n">sun_geocentric_declination</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">sun_geocentric_declination</span></div>



<div class="viewcode-block" id="observer_local_hour_calculation">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.observer_local_hour_calculation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">observer_local_hour_calculation</span><span class="p">(</span><span class="n">apparent_stime_at_greenwich</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">sun_rigth_ascension</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate observer local hour angle. SPA Step 11.&quot;&quot;&quot;</span>

    <span class="n">observer_local_hour</span> <span class="o">=</span> <span class="n">apparent_stime_at_greenwich</span> <span class="o">+</span> <span class="n">location</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sun_rigth_ascension</span>
    <span class="c1"># Set the range to [0-360]</span>
    <span class="n">observer_local_hour</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">observer_local_hour</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">observer_local_hour</span></div>



<div class="viewcode-block" id="topocentric_sun_position_calculate">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.topocentric_sun_position_calculate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">topocentric_sun_position_calculate</span><span class="p">(</span><span class="n">earth_heliocentric_position</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
                                       <span class="n">observer_local_hour</span><span class="p">,</span> <span class="n">sun_rigth_ascension</span><span class="p">,</span> <span class="n">sun_geocentric_declination</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate topocentric sun position. SPA Step 12.&quot;&quot;&quot;</span>

    <span class="c1"># Equatorial horizontal parallax of the sun in degrees</span>
    <span class="n">eq_horizontal_parallax</span> <span class="o">=</span> <span class="mf">8.794</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="n">earth_heliocentric_position</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>

    <span class="c1"># Term u, used in the following calculations (in radians)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">0.99664719</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>

    <span class="c1"># Term x, used in the following calculations</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">6378140</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>

    <span class="c1"># Term y, used in the following calculations</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.99664719</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">6378140</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>

    <span class="c1"># Parallax in the sun rigth ascension (in radians)</span>
    <span class="n">nominator</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">eq_horizontal_parallax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">observer_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sun_geocentric_declination</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">eq_horizontal_parallax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">observer_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
    <span class="n">sun_rigth_ascension_parallax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">nominator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span>
    <span class="c1"># Conversion to degrees.</span>
    <span class="n">topocentric_sun_position</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;rigth_ascension_parallax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sun_rigth_ascension_parallax</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># Topocentric sun rigth ascension (in degrees)</span>
    <span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;rigth_ascension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sun_rigth_ascension</span> <span class="o">+</span> <span class="p">(</span><span class="n">sun_rigth_ascension_parallax</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># Topocentric sun declination (in degrees)</span>
    <span class="n">nominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sun_geocentric_declination</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">eq_horizontal_parallax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)))</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sun_rigth_ascension_parallax</span><span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sun_geocentric_declination</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">eq_horizontal_parallax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span> <span class="o">*</span> \
                                                                   <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">observer_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;declination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">nominator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">topocentric_sun_position</span></div>



<div class="viewcode-block" id="topocentric_local_hour_calculate">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.topocentric_local_hour_calculate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">topocentric_local_hour_calculate</span><span class="p">(</span><span class="n">observer_local_hour</span><span class="p">,</span> <span class="n">topocentric_sun_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate topocentric local hour angle. SPA Step 13.&quot;&quot;&quot;</span>

    <span class="n">topocentric_local_hour</span> <span class="o">=</span> <span class="n">observer_local_hour</span> <span class="o">-</span> <span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;rigth_ascension_parallax&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">topocentric_local_hour</span></div>



<div class="viewcode-block" id="sun_topocentric_zenith_angle_calculate">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.sun_topocentric_zenith_angle_calculate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sun_topocentric_zenith_angle_calculate</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">topocentric_sun_position</span><span class="p">,</span> <span class="n">topocentric_local_hour</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate topocentric zenith and azimuth angles with atmospheric refraction. SPA Step 14.&quot;&quot;&quot;</span>


    <span class="c1"># Topocentric elevation, without atmospheric refraction</span>
    <span class="n">argument</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;declination&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;declination&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span>
     <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">topocentric_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
    <span class="n">true_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="c1"># Atmospheric refraction correction (in degrees)</span>
    <span class="n">argument</span> <span class="o">=</span> <span class="n">true_elevation</span> <span class="o">+</span> <span class="p">(</span><span class="mf">10.3</span><span class="o">/</span><span class="p">(</span><span class="n">true_elevation</span> <span class="o">+</span> <span class="mf">5.11</span><span class="p">))</span>
    <span class="n">refraction_corr</span> <span class="o">=</span> <span class="mf">1.02</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">argument</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>

    <span class="c1"># For exact pressure and temperature correction, use this,</span>
    <span class="c1"># with P the pressure in mbar amd T the temperature in Kelvins:</span>
    <span class="c1"># refraction_corr = (P/1010) * (283/T) * 1.02 / (60 * tan(argument * pi/180));</span>

    <span class="c1"># Apparent elevation</span>
    <span class="n">apparent_elevation</span> <span class="o">=</span> <span class="n">true_elevation</span> <span class="o">+</span> <span class="n">refraction_corr</span>

    <span class="n">sun</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">apparent_elevation</span>

    <span class="c1"># Topocentric azimuth angle. The +180 conversion is to pass from astronomer</span>
    <span class="c1"># notation (westward from south) to navigation notation (eastward from</span>
    <span class="c1"># north);</span>
    <span class="n">nominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">topocentric_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">topocentric_local_hour</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span> <span class="o">-</span> \
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">topocentric_sun_position</span><span class="p">[</span><span class="s1">&#39;declination&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
    <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">nominator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span>

    <span class="c1"># Set the range to [0-360]</span>
    <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_to_range</span><span class="p">(</span><span class="n">sun</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sun</span></div>



<div class="viewcode-block" id="set_to_range">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.set_to_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_to_range</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">min_interval</span><span class="p">,</span> <span class="n">max_interval</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize angle to specified range.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        var: Angle value</span>
<span class="sd">        min_interval: Minimum value (typically 0)</span>
<span class="sd">        max_interval: Maximum value (typically 360)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Normalized angle in [min_interval, max_interval)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">var</span> <span class="o">-</span> <span class="n">max_interval</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">var</span><span class="o">/</span><span class="n">max_interval</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">min_interval</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="n">max_interval</span>
    <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="Solweig_2015a_metdata_noload">
<a class="viewcode-back" href="../../api.html#solweig_gpu.sun_position.Solweig_2015a_metdata_noload">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Solweig_2015a_metdata_noload</span><span class="p">(</span><span class="n">inputdata</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">UTC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process meteorological data and calculate solar geometry for each time step.</span>
<span class="sd">    </span>
<span class="sd">    Computes solar position (altitude, azimuth) for all hours in the met data</span>
<span class="sd">    and organizes the data for SOLWEIG calculations.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        inputdata (np.ndarray): Meteorological data array</span>
<span class="sd">        location (dict): Geographic location (latitude, longitude, altitude)</span>
<span class="sd">        UTC (float): UTC offset in hours</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: (Met, altitude, azimuth, zen, jday, I0, CI, Twater, TgK, Tstart, </span>
<span class="sd">                TgK_wall, Tstart_wall, firstdaytime, timeadd, timestepdec) containing</span>
<span class="sd">                processed meteorological forcing and solar geometry</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Calculates solar position for every time step</span>
<span class="sd">        - Prepares data for SOLWEIG radiation calculations</span>
<span class="sd">        - Handles multiple time steps efficiently</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">met</span> <span class="o">=</span> <span class="n">inputdata</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">met</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">dectime</span> <span class="o">=</span> <span class="n">met</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">met</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">met</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mf">24.</span><span class="p">)</span>
    <span class="n">dectimemin</span> <span class="o">=</span> <span class="n">met</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mf">24.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">halftimestepdec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">halftimestepdec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dectime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dectime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">time</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UTC</span>
    <span class="n">sunmaximum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">leafon1</span> <span class="o">=</span> <span class="mi">97</span>  <span class="c1">#TODO this should change</span>
    <span class="n">leafoff1</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1">#TODO this should change</span>

    <span class="c1"># initialize matrices</span>
    <span class="n">altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">zen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">jday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">YYYY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">leafon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
    <span class="n">altmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>

    <span class="n">sunmax</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">met</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">221</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">YMD</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Finding maximum altitude in 15 min intervals (20141027)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">dectime</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">dectime</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">fifteen</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">sunmaximum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">90.</span>
            <span class="n">sunmax</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
            <span class="k">while</span> <span class="n">sunmaximum</span> <span class="o">&lt;=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">sunmax</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]:</span>
                <span class="n">sunmaximum</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">sunmax</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span>
                <span class="n">fifteen</span> <span class="o">=</span> <span class="n">fifteen</span> <span class="o">+</span> <span class="mf">15.</span> <span class="o">/</span> <span class="mf">1440.</span>
                <span class="n">HM</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">1440.0</span> <span class="o">+</span> <span class="n">fifteen</span><span class="p">)</span>
                <span class="n">YMDHM</span> <span class="o">=</span> <span class="n">YMD</span> <span class="o">+</span> <span class="n">HM</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">year</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">month</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">day</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">hour</span>
                <span class="n">time</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">minute</span>
                <span class="n">sunmax</span> <span class="o">=</span> <span class="n">sun_position</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">location</span><span class="p">)</span>
        <span class="n">altmax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sunmaximum</span>

        <span class="n">half</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">halftimestepdec</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">YMDHM</span> <span class="o">=</span> <span class="n">YMD</span> <span class="o">+</span> <span class="n">H</span> <span class="o">+</span> <span class="n">M</span> <span class="o">-</span> <span class="n">half</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">year</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">month</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">day</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">time</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YMDHM</span><span class="o">.</span><span class="n">minute</span>
        <span class="n">sun</span> <span class="o">=</span> <span class="n">sun_position</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">89.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">90.0</span><span class="p">):</span>    <span class="c1"># Hopefully fixes weird values in Perez et al. when altitude &lt; 1.0, i.e. close to sunrise/sunset</span>
            <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">89.0</span>
        <span class="n">altitude</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span>
        <span class="n">zen</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;zenith&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
        <span class="n">azimuth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sun</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span>

        <span class="c1"># day of year and check for leap year</span>
        <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]):</span>
            <span class="n">dayspermonth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dayspermonth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">])</span>
        <span class="c1"># jday[0, i] = np.sum(dayspermonth[0, 0:time[&#39;month&#39;]-1]) + time[&#39;day&#39;] # bug when a new day 20191015</span>
        <span class="n">YYYY</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">YMD</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">jday</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">doy</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">doy</span> <span class="o">&gt;</span> <span class="n">leafon1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">doy</span> <span class="o">&lt;</span> <span class="n">leafoff1</span><span class="p">):</span>
            <span class="n">leafon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leafon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">YYYY</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">zen</span><span class="p">,</span> <span class="n">jday</span><span class="p">,</span> <span class="n">leafon</span><span class="p">,</span> <span class="n">dectime</span><span class="p">,</span> <span class="n">altmax</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2025, Harsh Kamath and Naveen Sudharsan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>